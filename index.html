<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- iOS Web App Capable -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Gelişmiş Tur Satış Sistemi - Eksiksiz</title>

    <!-- Font Awesome (Sosyal medya ikonları) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"
        integrity="sha512-Rf1p4+CU1sEe3pGB6zG3c+a8QAsMd6aBvq4OdUtSynQqLBAyVPnFddUmr/dZ+QkzrrbWFRIG5My0g4z+SwDmDA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* ============================ 1. RESET & TEMEL STİLLER ============================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Sayfa genel kapsayıcıları tam ekranı kapsasın */
        body,
        html {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0;
            margin: 0;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Mobil ve tüm ekranlarda kartları %95 genişliğe oturt */
        .tour-item,
        .centered-container,
        .admin-section,
        .sales-section {
            max-width: 95% !important;
            width: 95% !important;
            padding: 0 !important;
            margin: 10px auto !important;
            border-radius: 12px !important;
            box-shadow: none !important;
            border: 1px solid #ddd;
        }

        /* İçerikler genişlesin ve düzgün kutulansın */
        .tour-item>*,
        .centered-container>* {
            width: 100% !important;
            box-sizing: border-box;
        }

        /* Kart içeriği içeriği duvara yapıştırmasın ve kartlar arası boşluk */
        .tour-item {
            padding: 12px !important;
            margin-bottom: 20px !important;
        }

        /* Responsive ayarlar: mobil uyum */
        @media (max-width: 768px) {

            html,
            body {
                margin: 0;
                padding: 0;
                overflow-x: hidden;
            }

            .tour-item,
            .centered-container {
                border-radius: 0;
            }

            .tour-item h3 {
                font-size: 1.1rem;
            }

            .tour-item p {
                font-size: 14px;
            }
        }



        /* Dil Seçici (sağ üst) */
        #languageSelect {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 3px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            font-size: 12px;
            z-index: 2000;
            outline: none;
        }

        #languageSelect:hover {
            background: #f3f3f3;
        }

        /* WhatsApp Butonu (SVG) */
        #whatsappSupport {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            z-index: 1000;
        }

        #whatsappSupport img {
            width: 36px;
            height: 36px;
        }

        #whatsappSupport:hover {
            transform: scale(1.1);
        }

        /* ============================ 2. HEADER ANİMASYON ============================ */
        @keyframes fadeInScale {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        header {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            text-align: center;
            background: linear-gradient(45deg, #fce4ec, #c8e6c9);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            position: relative;
            animation: fadeInScale 0.8s ease forwards;
        }

        header h1 {
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
            font-size: 1.6rem;
        }

        header p {
            font-size: 14px;
            color: #555;
        }

        /* ============================ 3. SAYFA BÖLÜMLERİ ============================ */
        .login-section,
        .admin-section,
        .sales-section {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            display: none;
        }

        .active {
            display: block !important;
        }

        .centered-container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        /* ============================ 4. FORM ELEMANLARI & EMOJİ ============================ */
        h2,
        h3 {
            margin-bottom: 16px;
            font-weight: 600;
            color: #444;
        }

        h2:before {
            content: "✨ ";
        }

        h3:before {
            content: "⚡ ";
        }

        p {
            margin-bottom: 8px;
            color: #555;
            line-height: 1.4;
        }

        label {
            display: block;
            font-weight: 500;
            margin: 8px 0 4px;
        }

        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        button {
            cursor: pointer;
            padding: 10px 20px;
            background: #03a9f4;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            margin-top: 6px;
            transition: background 0.3s, transform 0.2s;
        }

        button:hover {
            background: #0288d1;
            transform: scale(1.03);
        }

        button.logout {
            background: #f44336;
            margin-top: 16px;
        }

        button.logout:hover {
            background: #e53935;
        }

        /* ============================ 5. CANLI CHAT ============================ */
        #liveChat {
            max-width: 400px;
            position: fixed;
            bottom: 80px;
            right: 80px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }

        #liveChatHeader {
            background: #03a9f4;
            color: #fff;
            padding: 10px;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
        }

        #liveChatMessages {
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }

        #liveChatInputContainer {
            display: flex;
            border-top: 1px solid #ccc;
        }

        #liveChatInput {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 0 0 0 6px;
        }

        #liveChatSend {
            padding: 8px 12px;
            background: #03a9f4;
            border: none;
            color: #fff;
            border-radius: 0 0 6px 0;
            cursor: pointer;
        }

        /* ============================ 6. ADMIN -> SATICI BUTONU (ÜST KÖŞE) ============================ */
        .go-seller-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #9c27b0;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.3s, transform 0.2s;
        }

        .go-seller-btn:hover {
            background: #7b1fa2;
        }

        /* ============================ 7. ADMIN: SATIÇI YÖNETİMİ ============================ */
        .admin-seller-management {
            margin-top: 16px;
            padding: 10px;
            border: 1px solid #ccc;
            background: #f8f8f8;
            border-radius: 6px;
        }

        .add-seller-form {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .add-seller-form h4 {
            margin-bottom: 8px;
            font-size: 1rem;
            color: #333;
        }

        .seller-list-container {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        /* ============================ 8. TUR KARTI HOVER ANİMASYON ============================ */
        .code-1 {
            background: #e3f2fd;
            border: 2px solid #90caf9;
        }

        .code-2 {
            background: #f3e5f5;
            border: 2px solid #ce93d8;
        }

        .code-3 {
            background: #fff3e0;
            border: 2px solid #ffb74d;
        }

        @keyframes cardHover {
            0% {
                transform: scale(1);
            }

            100% {
                transform: scale(1.02);
            }
        }

        .tour-item {
            margin: 14px 0;
            padding: 14px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.07);
            position: relative;
            transition: transform 0.2s;
        }

        .tour-item:hover {
            animation: cardHover 0.3s forwards;
        }

        .tour-images {
            display: flex;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .tour-images img {
            width: 120px;
            height: auto;
            margin-right: 5px;
            margin-bottom: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        .tour-video {
            margin-top: 10px;
            width: 100%;
            max-width: 500px;
            height: 280px;
            background: #000;
        }

        .tour-video iframe {
            width: 100%;
            height: 100%;
            border: none;
            /* YouTube embed allow.. */
        }

        .social-links {
            margin-top: 10px;
            text-align: center;
        }

        .social-links a {
            margin: 0 5px;
            font-size: 18px;
            color: #03a9f4;
            text-decoration: none;
        }

        .reservation-info {
            margin-top: 12px;
            padding: 14px;
            background: #f7f7f7;
            border: 1px solid #ddd;
            border-radius: 6px;
            display: none;
        }

        .reservation-info.active {
            display: block;
        }

        .occupant-list {
            margin-top: 10px;
            border: 1px solid #ccc;
            background: #fff;
            padding: 10px;
            border-radius: 6px;
        }

        .payment-extra {
            margin-top: 8px;
            padding: 10px;
            background: #fffde7;
            border: 1px solid #ffc107;
            border-radius: 6px;
            display: none;
        }

        /* ============================ 9. SATIŞ RAPORU TABLO ============================ */
        #salesReport {
            margin-top: 16px;
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid #eee;
            padding: 6px;
            border-radius: 4px;
        }

        #salesReport table {
            min-width: 900px;
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            color: #333;
        }

        #salesReport th,
        #salesReport td {
            padding: 8px 12px;
            border: 1px solid #ccc;
            text-align: left;
            font-size: 0.9rem;
        }

        #salesReport th {
            background: #423535;
        }

        /* ============================ 10. SATIÇI MUHASEBESİ ============================ */
        #sellerAccounting {
            display: none;
            margin-top: 16px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 10px;
            overflow-x: auto;
        }

        .seller-acc-filter {
            margin-bottom: 10px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            background: #f0f8ff;
        }

        .acc-details-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .acc-details-table th,
        .acc-details-table td {
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 0.9rem;
        }

        .acc-details-table th {
            background: #03a9f4;
            color: #fff;
        }

        /* ============================ 11. MODALLER: SATILMIŞ KOLTUKLAR & GÖRSEL ============================ */
        #modalOverlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 998;
        }

        #soldSeatsModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 600px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            padding: 20px;
            display: none;
            z-index: 999;
            overflow-y: auto;
            max-height: 80vh;
        }

        #imageModalOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        #imageModalOverlay img {
            max-width: 90%;
            max-height: 90%;
            border: 4px solid #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.7);
        }

        /* ============================ RESPONSIVE MEDIA QUERIES ============================ */
        @media (max-width: 992px) {
            .centered-container {
                max-width: 500px;
            }
        }

        @media (max-width: 768px) {
            .centered-container {
                max-width: 100%;
                box-shadow: none;
            }

            #salesReport {
                max-height: 400px;
            }

            .tour-images img {
                width: 90px;
            }
        }

        /* Sales Raporu (Tüm ekranlara sığdırma ve hizalama için) */
        #salesReport,
        #sellerSalesStats {
            max-width: 100%;
            overflow-x: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-top: 10px;
            border-radius: 6px;
            background: #fff;
        }

        .acc-details-table {
            width: 100%;
            border-collapse: collapse;
        }

        .acc-details-table th,
        .acc-details-table td {
            border: 1px solid #ddd;
            padding: 8px;
            font-size: 14px;
            text-align: left;
        }

        .acc-details-table th {
            background-color: #03a9f4;
            color: #ffffff;
        }

        #chat-widget {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 200px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            font-family: 'Segoe UI', sans-serif;
            overflow: hidden;
            z-index: 1000;
        }

        .chat-header {
            background: #03a9f4;
            color: #fff;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 500;
            user-select: none;
        }

        .chat-body {
            display: none;
            /* Başlangıçta kapalı olsun */
            flex-direction: column;
            height: 350px;
            border-top: 1px solid #ccc;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        .message {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            max-width: 80%;
            font-size: 14px;
            line-height: 1.4;
        }

        .bot {
            background: #e1f5fe;
            align-self: flex-start;
        }

        .user {
            background: #03a9f4;
            color: white;
            align-self: flex-end;
        }

        .chat-input {
            display: flex;
            border-top: 1px solid #ccc;
        }

        .chat-input input {
            flex: 1;
            border: none;
            padding: 10px;
            outline: none;
        }

        .chat-input button {
            background: #03a9f4;
            color: white;
            border: none;
            padding: 0 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .chat-input button:hover {
            background: #0288d1;

        }

        .tour-item {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .tour-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25);
        }

        .tour-item h3 {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            padding: 12px 16px;
            background: linear-gradient(120deg, #03a9f4, #81d4fa);
            color: #fff;
            border-bottom: 2px solid #03a9f4;
        }

        .tour-item p {
            padding: 8px 16px;
            color: #555;
        }

        .tour-item .tour-images {
            padding: 10px 16px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
        }

        .tour-item .tour-images img {
            height: 100px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .tour-item .tour-images img:hover {
            transform: scale(1.05);
        }

        .tour-item .tour-video {
            padding: 10px 16px;
        }

        .tour-item iframe {
            border-radius: 12px;
        }

        .tour-item .social-links {
            padding: 10px 16px;
            border-top: 1px solid #ddd;
            background: #fafafa;
        }

        .tour-item .social-links a img {
            width: 24px;
            transition: transform 0.2s ease;
        }

        .tour-item .social-links a:hover img {
            transform: scale(1.2);
        }

        .tour-item button {
            margin: 10px 16px;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .tour-item button:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        .tour-item button {
            padding: 8px 12px;
            background: #03a9f4;
            color: white;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            margin: 5px;
            font-weight: 500;
            transition: transform 0.2s, opacity 0.2s;
        }

        .tour-item button:hover {
            transform: scale(1.03);
            background: #0288d1;
        }

        .tour-item button.delete-btn {
            background: #e53935;
        }

        .tour-item button.whatsapp-btn {
            background: #25D366;
        }

        .tour-item button.edit-btn {
            background: #ff9800;

        }

        .tour-item button.share-btn {
            background: #607D8B;
        }

        .tour-item button.sell-btn {
            background: #4CAF50;
        }

        .tour-item button.detail-btn {
            background: #8e24aa;
        }

        .tour-item button:hover {
            filter: brightness(1.1);
            transform: translateY(-3px);
        }

        .payment-extra {
            background-color: #fafafa;
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .payment-extra label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 14px;
        }

        .payment-extra input {
            padding: 8px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .payment-extra h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #555;

        }

        .geriSayim {
            background-color: #fffae6;
            border: 2px dashed #ffae00;
            color: #ff3d00;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            padding: 8px 10px;
            border-radius: 12px;
            margin: 12px 0;
            display: inline-block;
            box-shadow: 0 2px 8px rgba(255, 165, 0, 0.3);
            animation: pulse 2s infinite;
        }

        .geriSayim::before {
            content: "⏳ Başlangıca Kalan: ";
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .alternative-tour {
            background: #ffeb3b;
            color: #333;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
            border: 2px solid #fbc02d;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .alternative-tour span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .acc-details-table td:nth-child(10) {
            /* Alternatif Tur kolonu */
            background: #ffeb3b;
            color: #333;
            font-weight: bold;
            text-align: center;
            border-left: 2px solid #fbc02d;
            border-right: 2px solid #fbc02d;
            padding: 10px;
        }

        /* Günübirlik (Mavi) */
        .code-1 {
            background: #e3f2fd;
            border: 2px solid #90caf9;
        }

        /* VIP (Kırmızı) */
        .code-2 {
            background: #ffebee;
            border: 2px solid #e57373;
        }

        /* Paket (Yeşil) */
        .code-3 {
            background: #e8f5e9;
            border: 2px solid #81c784;
        }

        /* Kültür Turu (Turuncu) */
        .code-4 {
            background: #fff3e0;
            border: 2px solid #ffb74d;
        }

        /* Yurtdışı Turu (Pembe) */
        .code-5 {
            background: #fce4ec;
            border: 2px solid #f06292;
        }

        /* Gemi Turu (Mor) */
        .code-6 {
            background: #ede7f6;
            border: 2px solid #9575cd;
        }

        .reservation-form {
            max-width: 600px;
            margin: auto;
            padding: 20px;
            border-radius: 10px;
            background-color: #f8f8f8;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .reservation-form input,
        .reservation-form textarea {
            width: 100%;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .reservation-form button {
            width: 100%;
            padding: 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .reservation-form button:hover {
            background-color: #0056b3;
        }

        .reservations-report {
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .filter-container {
            margin-bottom: 15px;
        }

        .filter-container input,
        .filter-container button {
            padding: 8px;
            margin-right: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        .styled-table {
            width: 100%;
            border-collapse: collapse;
        }

        .styled-table th,
        .styled-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .styled-table th {
            background-color: #f8f8f8;
        }

        .styled-table tbody tr:hover {
            background-color: #f1f1f1;
        }

        a {
            color: #25D366;
            text-decoration: none;
        }

        #advancedReservationReport {
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .filter-container input,
        .filter-container button {
            padding: 10px;
            margin-right: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        .payment-section {
            border: 2px dashed #4caf50;
            padding: 12px;
            border-radius: 8px;
            background: #f1f8e9;
            margin-top: 14px;
            transition: all 0.3s ease;
        }

        .payment-section h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .total-confirm button {
            background: #4caf50;
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            margin-top: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .total-confirm button:hover {
            background: #388e3c;
            transform: scale(1.05);
        }

        .payment-options {
            margin-top: 10px;
            animation: fadeIn 0.4s ease-in-out;
        }

        .payment-options select,
        .payment-options input {
            width: 100%;
            padding: 6px;
            margin: 4px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        .fadeIn {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-edit {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-edit-content {
            background: #fff;
            margin: 8% auto;
            padding: 20px;
            border: 2px solid #2196F3;
            border-radius: 12px;
            width: 90%;
            max-width: 480px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: fadeIn 0.3s ease;

            /* Yeni eklenen özellikler */
            max-height: 85vh;
            overflow-y: auto;
        }


        .modal-edit-content h3 {
            color: #333;
            margin-bottom: 12px;
            text-align: center;
        }

        .modal-edit-content label {
            display: block;
            margin: 8px 0 4px;
            font-weight: 500;
        }

        .modal-edit-content input,
        .modal-edit-content textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .modal-edit-content button {
            width: 100%;
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .modal-edit-content button:hover {
            background-color: #45a049;
        }

        .modal-edit-content .close {
            position: absolute;
            top: 12px;
            right: 18px;
            font-size: 26px;
            color: #f44336;
            cursor: pointer;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .advanced-seller-panel {
            background: #f8f8f8;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
        }

        .advanced-seller-panel h3 {
            margin-bottom: 12px;
            font-size: 18px;
            color: #333;
        }

        .advanced-seller-panel label {
            font-weight: 600;
            margin-top: 10px;
            display: block;
        }

        .advanced-seller-panel input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        .advanced-seller-panel table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            min-width: 800px;
        }

        .advanced-seller-panel th,
        .advanced-seller-panel td {
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 14px;
            text-align: left;
        }

        .advanced-seller-panel th {
            background: #2196f3;
            color: white;
        }

        #sellerAccounting {
            max-height: 600px;
            overflow-y: auto;
            overflow-x: auto;
            border: 1px solid #ccc;
            padding: 12px;
            border-radius: 8px;
            background: #f9f9f9;
            margin-top: 20px;
        }

        .full-tour-card {
            width: 100%;
            max-width: 100%;
            margin: 10px auto;
            padding: 20px;
            box-sizing: border-box;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* Küçük ekranlar için uyumlu */
        @media (max-width: 768px) {
            .full-tour-card {
                padding: 15px;
            }
        }

        /* === SATIÇI YÖNETİM CSS === */
        .seller-advanced-panel {
            background: #f7f9fb;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .seller-filters input {
            padding: 8px;
            margin: 5px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .seller-filters button {
            background: #4caf50;
            color: #fff;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .seller-filters button:hover {
            background: #388e3c;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }

        .seller-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .seller-table th,
        .seller-table td {
            border: 1px solid #ccc;
            padding: 8px;
            font-size: 14px;
        }

        .seller-table th {
            background-color: #2196f3;
            color: white;
        }

        .seller-table button {
            padding: 4px 8px;
            margin: 0 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .seller-table button:hover {
            background-color: #ddd;
        }

        .modal-edit {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-edit-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
        }

        .modal-edit-content input {
            display: block;
            width: 100%;
            margin: 8px 0;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        .modal-edit-content button {
            background: #2196f3;
            color: white;
            padding: 10px 14px;
            border: none;
            border-radius: 6px;
            width: 100%;
            margin-top: 10px;
        }

        .modal-close {
            float: right;
            font-size: 20px;
            color: #f44336;
            cursor: pointer;
        }

        .group-wrapper {
            margin-bottom: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 10px;
        }

        .team-stats {
            margin-top: 20px;
            background: #f1f8e9;
            border: 1px dashed #8bc34a;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
        }

        .seller-performance-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 15px;
            border: 1px solid #ddd;
        }

        .seller-performance-table th {
            background: #4CAF50;
            color: white;
            padding: 10px;
        }

        .seller-performance-table td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }

        .seller-performance-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        button.finalize-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

        .finalize-btn.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .finalize-btn:not(.disabled) {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
        }


        button.finalize-btn {
            width: 100%;
            padding: 12px 16px;
            background: #f57c00;
            color: white;
            font-weight: bold;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transition: background 0.3s ease, transform 0.2s;
            margin-top: 10px;
        }

        button.finalize-btn:hover {
            background: #e65100;
            transform: scale(1.02);
        }

        button.finalize-btn.disabled {
            background: #ccc !important;
            color: #777;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .create-tour-card {
            border: 2px dashed #90caf9;
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            margin: auto;
            margin-bottom: 40px;
        }

        .create-tour-card label {
            font-weight: 500;
            margin-top: 10px;
            display: block;
        }

        .create-tour-card input,
        .create-tour-card textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            margin-top: 4px;
        }

        .create-tour-card button {
            margin-top: 15px;
            padding: 10px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .create-tour-card button:hover {
            background: #1565c0;
        }


        .admin-custom-tour-approvals {
            margin: 20px auto;
            padding: 20px;
            background: #fff3e0;
            border: 1px solid #ffc107;
            border-radius: 8px;
            max-width: 800px;
        }

        .admin-custom-tour-approvals h3 {
            margin-bottom: 10px;
            color: #e65100;
        }

        .custom-tour-card {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: #ffffff;
        }

        .custom-tour-card button {
            margin-right: 10px;
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        .approve-btn {
            background-color: #4caf50;
            color: white;
        }

        .reject-btn {
            background-color: #f44336;
            color: white;
        }

        .view-btn {
            background-color: #2196f3;
            color: white;
        }

        .address-fields {
            background: #f1f8e9;
            padding: 10px;
            border-radius: 6px;
            border: 1px dashed #8bc34a;
            margin-top: 8px;
        }

        .address-fields input {
            margin-top: 6px;
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .filter-box {
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            max-width: 600px;
        }

        .filter-box label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
        }

        .filter-box input[type="text"],
        .filter-box input[type="date"] {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        .filter-box button {
            margin-top: 10px;
            padding: 10px 16px;
            background: #03a9f4;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        .filter-box button:hover {
            background: #0288d1;
        }

        #salesReportTable {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }

        #salesReportTable th,
        #salesReportTable td {
            border: 1px solid #ddd;
            padding: 8px 10px;
            font-size: 14px;
            vertical-align: middle;
        }

        #salesReportTable thead tr {
            background: #423535;
            color: #fff;
        }

        #salesReportTable tbody tr:hover {
            background: #fafafa;
        }

        /* Excel Butonu */
        #exportBtn {
            background: #4caf50;
            color: #fff;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
            font-weight: bold;
        }

        #exportBtn:hover {
            background: #388e3c;
        }

        /* Detay Modal */
        #saleDetailModalOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        #saleDetailModal {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        #saleDetailModal .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 22px;
            color: #f44336;
            cursor: pointer;
        }

        #saleDetailModal h3 {
            margin-top: 0;
            margin-bottom: 10px;
        }

        .kisi-card {
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 8px;
        }

        .whatsapp-btn {
            background: #25D366;
            color: #fff;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .detail-btn {
            background: #ff9800;
            color: #fff;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Sales Report Tablosu Konteyneri */
        #salesReport {
            overflow-x: auto;
            max-width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Tablonun kendisi */
        #salesReportTable {
            width: 100%;
            min-width: 1300px;
            /* İstersen azaltabilirsin */
            border-collapse: collapse;
            background: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        /* Başlık satırı */
        #salesReportTable thead tr {
            background: #2e3b4e;
            color: white;
        }

        /* Tüm hücreler */
        #salesReportTable th,
        #salesReportTable td {
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ddd;
            white-space: nowrap;
            /* Satır kaymasın */
        }

        /* Hover efekti */
        #salesReportTable tbody tr:hover {
            background: #f9f9f9;
        }

        #reservationTableBox {
            max-height: 550px;
            /* yaklaşık 20 satıra denk gelir */
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        /* Genel görünüm */
        #sellerPanel {
            font-family: 'Segoe UI', sans-serif;
            background: #fff;
            max-width: 1200px;
            margin: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        input,
        button {
            padding: 8px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }

        input:focus {
            outline: 2px solid #2196f3;
        }

        button {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            opacity: 0.9;
        }

        /* Satıcı Kartları */
        #sellerList>div {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        #sellerList>div:hover {
            transform: scale(1.01);
        }

        #sellerList h4 {
            margin: 0 0 6px;
            font-size: 16px;
            font-weight: bold;
        }

        #sellerList p {
            margin: 4px 0;
            font-size: 14px;
            color: #333;
        }

        #sellerList button {
            background: #03a9f4;
            color: white;
            border: none;
            padding: 6px 10px;
            margin-top: 6px;
            font-size: 13px;
            border-radius: 6px;
        }

        #sellerList button:nth-child(2) {
            background: #f44336;
        }

        #sellerList button:nth-child(3) {
            background: #4caf50;
        }

        /* Modal */
        #sellerEditModal {
            display: none;
            justify-content: center;
            align-items: center;
        }

        #sellerEditModal input {
            width: 100%;
            margin-bottom: 10px;
        }

        /* Performans Alanı */
        #sellerStats button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 10px;
            font-size: 13px;
            border-radius: 6px;
        }

        #sellerStats canvas {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 12px;
            padding: 10px;
        }

        @media (max-width: 768px) {
            #sellerPanel {
                padding: 10px;
            }

            #sellerStats canvas {
                max-width: 100%;
            }
        }

        /* Panelin ana kapsayıcısı */
        #sellerAccountingPanel {
            width: 95%;
            margin: 20px auto;
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #sellerAccountingPanel h2 {
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 18px;
            color: #444;
        }

        /* FILTRELEME ALANI */
        #filterToggleBtn {
            background: #03a9f4;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 10px;
        }

        #filterToggleBtn:hover {
            background: #0288d1;
        }

        #sellerFilterBox {
            display: none;
            /* Başlangıçta kapalı */
            background: #fafafa;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        #sellerFilterBox label {
            font-weight: 600;
            margin-top: 8px;
            display: block;
        }

        #sellerFilterBox input[type="text"],
        #sellerFilterBox input[type="date"] {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            margin-bottom: 8px;
        }

        #sellerFilterBox button {
            background: #4caf50;
            color: #fff;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 8px;
            font-weight: bold;
        }

        #sellerFilterBox button:hover {
            background: #388e3c;
        }

        /* SATICI GRUP KARTLARI */
        .seller-group {
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 10px;
        }

        .seller-group h3 {
            font-size: 16px;
            margin-bottom: 6px;
            color: #333;
        }

        .seller-info {
            margin-bottom: 10px;
            padding-left: 8px;
        }

        .seller-info p {
            margin: 4px 0;
            font-size: 14px;
        }

        /* Satıcı Satış Muhasebesi Alanı */
        #sellerAccountingPanel {
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            max-width: 1400px;
        }

        #sellerAccountingPanel h2 {
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 18px;
            color: #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Filtre alanını aç/kapa butonu */
        #filterToggleBtn {
            background: #03a9f4;
            color: #fff;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }

        #filterToggleBtn:hover {
            background: #0288d1;
        }

        /* Filtre Kutusu */
        #sellerFilterBox {
            display: none;
            /* Başlangıçta kapalı */
            background: #fafafa;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        #sellerFilterBox label {
            font-weight: 600;
            margin-top: 8px;
            display: block;
        }

        #sellerFilterBox input,
        #sellerFilterBox select {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        #sellerFilterBox button {
            background: #4caf50;
            color: #fff;
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 8px;
            font-weight: bold;
        }

        #sellerFilterBox button:hover {
            background: #388e3c;
        }

        /* Sonuç Tablosu */
        #sellerSalesTableContainer {
            max-height: 300px;
            /* en fazla 10-12 satır gösterilsin */
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 10px;
        }

        table.seller-sales-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }

        .seller-sales-table th,
        .seller-sales-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            vertical-align: middle;
        }

        .seller-sales-table thead {
            background: #2e3b4e;
            color: #fff;
        }

        .seller-sales-table tbody tr:hover {
            background: #f9f9f9;
        }

        .seller-sales-table tfoot {
            background: #fff8e1;
            font-weight: bold;
        }

        /* Modal - Satış Detayı */
        #saleDetailModalOverlay2 {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        #saleDetailModal2 {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        #saleDetailModal2 .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 20px;
            color: #f44336;
            cursor: pointer;
        }

        #saleDetailModal2 h4 {
            margin-top: 0;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        #saleDetailModalContent2 p {
            margin: 6px 0;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <select id="languageSelect">
        <option value="tr">Türkçe 🇹🇷</option>
        <option value="en">English 🇺🇸</option>
        <option value="ar">العربية 🇸🇦</option>
        <option value="de">Deutsch 🇩🇪</option>
        <option value="ru">Русский 🇷🇺</option>
        <option value="fa">فارسی 🇮🇷</option>
    </select>
    <div id="google_translate_element" style="display:none;"></div>

    <!-- WHATSAPP -->
    <a href="https://api.whatsapp.com/send?phone=905000000000" id="whatsappSupport" target="_blank">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp Logo">
    </a>

    <!-- HEADER -->
    <header>
        <h1 data-key="header_title">Dailytur Satış Paneli</h1>
        <p data-key="header_subtitle">Acentelerinizde misafirlerinize güvenli bir şekilde tur organize edecek platform.
        </p>
    </header>

    <!-- MODALLER -->
    <div id="modalOverlay"></div>
    <div id="soldSeatsModal">
        <h3>Satılmış Koltuklar</h3>
        <div id="soldSeatsList"></div>
        <button onclick="closeSoldSeatsModal()">Kapat</button>
    </div>
    <div id="imageModalOverlay" onclick="closeImageModal()">
        <img id="imageModalImg" src="" alt="Büyütülmüş Görsel" />
    </div>

    <!-- CANLI CHAT -->
    <div id="liveChat">
        <div id="liveChatHeader" onclick="toggleLiveChat()">Canlı Destek</div>
        <div id="liveChatMessages"></div>
        <div id="liveChatInputContainer">
            <input type="text" id="liveChatInput" placeholder="Mesajınızı yazın..." />
            <button id="liveChatSend" onclick="sendLiveChat()">Gönder</button>
        </div>
    </div>

    <!-- LOGIN EKRANI -->
    <div class="login-section active" id="loginSection">
        <div class="centered-container">
            <h2 data-key="login_title">Giriş Yap</h2>
            <label data-key="login_user">Kullanıcı Adı</label>
            <input type="text" id="loginUsername" placeholder="admin / satici1" />
            <label data-key="login_pass">Şifre</label>
            <input type="password" id="loginPassword" placeholder="12345" />
            <button onclick="login()" data-key="login_button">Giriş</button>
            <p style="font-size:14px; margin-top:8px; color:#666;" data-key="login_info">

            </p>
        </div>
    </div>

    <!-- ADMIN EKRANI -->
    <section class="admin-section" id="adminSection">
        <div class="centered-container">
            <h2 data-key="admin_panel_title">Admin Paneli</h2>
            <p data-key="admin_panel_subtitle">
                Merhaba <span id="adminName"></span>. Burada turları ekleyip, satış raporuna bakabilirsiniz.
            </p>

            <h3 data-key="admin_changePass">Admin Şifre Değiştir</h3>
            <label data-key="admin_newPass">Yeni Şifre:</label>
            <input type="password" id="newAdminPass" placeholder="Yeni Şifre" />
            <button onclick="changeAdminPass()" data-key="admin_passBtn">Değiştir</button>
            <hr />

            <h3 data-key="admin_newTour">Tur Ekle</h3>
            <label data-key="admin_tourName">Tur Adı:</label>
            <input type="text" id="addTourName" />
            <label data-key="admin_tourDesc">Açıklama:</label>
            <textarea id="addTourDesc" rows="2"></textarea>
            <label data-key="admin_tourDate">Tarih (Gün):</label>
            <input type="date" id="addTourDate" />
            <label data-key="admin_tourStart">Başlangıç Saati:</label>
            <input type="time" id="addTourStart" />
            <label data-key="admin_tourEnd">Bitiş Saati:</label>
            <input type="time" id="addTourEnd" />
            <label data-key="admin_tourPrice">Fiyat (TL):</label>
            <input type="number" id="addTourPrice" />
            <label data-key="admin_tourStops">Duraklar (virgülle):</label>
            <input type="text" id="addTourStops" />
            <label data-key="admin_tourLoc">Konum Bilgisi:</label>
            <input type="text" id="addTourLocation" />
            <label data-key="admin_tourGuide">Rehber Bilgisi:</label>
            <input type="text" id="addTourGuide" />
            <label data-key="admin_tourSeats">Toplam Koltuk:</label>
            <input type="number" id="addTourSeats" />
            <label>Tur Kodu:</label>
            <select id="addTourCode" onchange="tourCodeChange()">
                <option value="1">1 - Günübirlik Tur (Mavi)</option>
                <option value="2">2 - VIP Tur (Kırmızı)</option>
                <option value="3">3 - Paket Tur (Yeşil)</option>
                <option value="4">4 - Kültür Turu (Turuncu)</option>
                <option value="5">5 - Yurtdışı Turu (Pembe)</option>
            </select>



            <div id="packageDetails" style="display:none;">
                <h4>Paket Tur Detayları</h4>
                <label>Günlük Program</label>
                <textarea id="dayPlans"></textarea>

                <label>Konaklama Bilgisi</label>
                <textarea id="stayPlan"></textarea>

                <label>Paket Fiyat</label>
                <input type="number" id="packagePrice">

                <label>Para Birimi</label>
                <select id="currency">
                    <option value="TL">TL</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>


            <label>Yedek Tur (Bu tur dolarsa veya yeterli katılımcı olmazsa):</label>
            <input type="text" id="alternativeTourName" placeholder="Alternatif tur ismi giriniz" />

            <label>Video Ekle (URL):</label>
            <input type="text" id="addTourVideo" placeholder="https://www.youtube.com/embed/xxx" />
            <label data-key="admin_tourImages">Tur Görselleri (max 10):</label>
            <input type="file" id="addTourImages" multiple accept="image/*,video/*" />
            <button onclick="uploadImagesAndCreateTour()" data-key="admin_tourBtn" style="margin-top:10px;">
                Turu Ekle
            </button>

            <!-- Admin -> Satıcı butonu en üst köşede -->
            <button class="go-seller-btn" onclick="goToSeller()" data-key="admin_goSeller">Satıcı Ekranına Geç</button>
        </div>

        <hr />

        <!-- TURLAR FİLTRE -->
        <div class="centered-container">
            <h4>Tur Filtre (Admin)</h4>
            <label>Tur Adı:</label>
            <input type="text" id="adminTourFilterName" placeholder="Tur adında ara..." />
            <label>Kod (1(Günübirlik)/2(Vıp)/3(Paket)/4(Kültür)/5(Yurtdışı)):</label>
            <input type="text" id="adminTourFilterCode" placeholder="örn: 1" />
            <label>Tarih (en erken):</label>
            <input type="date" id="adminTourFilterStart" />
            <label>Tarih (en geç):</label>
            <input type="date" id="adminTourFilterEnd" />
            <!-- Eklenmesi gereken satır -->
            <label>Konum:</label>
            <input type="text" id="adminTourFilterLocation" placeholder="Konum ara...">
            <label>Min Fiyat:</label>
            <input type="number" id="filterMinPrice" placeholder="En az fiyat">

            <label>Max Fiyat:</label>
            <input type="number" id="filterMaxPrice" placeholder="En yüksek fiyat">

            <label>Min Koltuk:</label>
            <input type="number" id="filterMinSeats" placeholder="En az koltuk">

            <label><input type="checkbox" id="filterOnlyAvailable"> Sadece boş koltuk olanlar</label>

            <button onclick="filterAdminTours()">Turları Filtrele</button>
        </div>

        <div class="centered-container">
            <h3 data-key="admin_savedToursBtn">Kayıtlı Turlar</h3>
            <div id="adminTourList"></div>
        </div>

        <hr />


        <div id="salesReportContainer" style="overflow-x:auto; padding: 10px;">
            <div id="salesReportHeader"></div>
            <div id="salesReportTable"></div>
        </div>

        <!-- Modal -->
        <div id="saleDetailModalOverlay"
            style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:9999;">
            <div id="saleDetailModal"
                style="background:#fff; border-radius:12px; padding:20px; max-width:500px; width:90%; box-shadow:0 5px 15px rgba(0,0,0,0.3); position:relative;">
                <button onclick="closeSaleDetailModal()"
                    style="position:absolute; top:10px; right:10px; background:#f44336; color:#fff; border:none; border-radius:6px; padding:4px 8px;">X</button>
                <h3 style="margin-top:0;">📋 Satış Detayı</h3>
                <div id="saleDetailContent"></div>
            </div>
        </div>

        <h2>Garanti BBVA 3D Ödeme</h2>
        <form id="paymentForm">
            <input type="text" id="cardNumber" placeholder="Kart Numarası" required />
            <input type="text" id="expireMonth" placeholder="Son Kullanma Ay (MM)" required />
            <input type="text" id="expireYear" placeholder="Son Kullanma Yıl (YY)" required />
            <input type="password" id="cvv" placeholder="CVV" required />
            <input type="text" id="amount" placeholder="Tutar (örn. 100.00)" required />
            <button type="submit">Ödemeyi Başlat</button>
        </form>

        <!-- 📊 Gelişmiş İleri Tarihli Rezervasyonlar -->
        <div id="advancedReservationPanel"
            style="background:#fff; padding:15px; border-radius:8px; margin-top:30px; box-shadow:0 2px 6px rgba(0,0,0,0.1);">

            <h3>📊 Gelişmiş İleri Tarihli Rezervasyonlar</h3>

            <!-- 🔍 Filtre Alanları -->
            <div id="reservationFilterBox" style="margin-bottom:10px;">
                <div style="display:flex; flex-wrap:wrap; gap:10px;">
                    <input type="text" id="filterTourName" placeholder="Tur Adı" />
                    <input type="date" id="filterDate" />
                    <input type="text" id="filterCustomer" placeholder="Müşteri Adı Soyadı" />
                    <input type="text" id="filterPhone" placeholder="Telefon" />
                    <input type="text" id="filterCountry" placeholder="Ülke" />
                    <input type="text" id="filterSeller" placeholder="Satıcı Adı" />
                    <input type="number" id="filterPersonCount" placeholder="Kişi Sayısı" />
                    <input type="text" id="filterNotes" placeholder="Not" />
                    <button onclick="loadFilteredReservations()" style="background:#03a9f4;color:white;">🔍
                        Filtrele</button>
                    <button onclick="closeAdvancedPanel()" style="background:red;color:white;">❌ Kapat</button>
                </div>
            </div>

            <!-- 📋 Tablo Alanı -->
            <div id="reservationTableBox"
                style="max-height: 500px; overflow-y:auto; border: 1px solid #ddd; border-radius:6px;">
                <table class="styled-table" style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background:#f0f0f0;">
                            <th>🆔</th>
                            <th>Tur Adı</th>
                            <th>Tarih</th>
                            <th>Kişi Sayısı</th>
                            <th>Müşteri</th>
                            <th>Satıcı</th>
                            <th>Ülke</th>
                            <th>Telefon</th>
                            <th>Not</th>
                            <th>WhatsApp</th>
                        </tr>
                    </thead>
                    <tbody id="reservationsList"></tbody>
                </table>
            </div>
        </div>

        <!-- 📋 Rezervasyon Detay Modal -->
        <div id="reservationDetailModal"
            style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
            <div
                style="background:#fff; padding:20px; max-width:400px; width:90%; border-radius:10px; position:relative;">
                <span onclick="closeReservationModal()"
                    style="position:absolute;top:10px;right:15px;cursor:pointer;font-size:20px;color:red;">✖</span>
                <h3>📋 Rezervasyon Detayı</h3>
                <div id="reservationModalContent"></div>
            </div>
        </div>

        <!-- Admin Paneli içinde, mesela <section class="admin-section" id="adminSection"> ... sonuna ekleyebilirsiniz -->
        <div id="sellerAccountingPanel">
            <h2>
                Satıcı Satış Muhasebesi
                <button id="filterToggleBtn" onclick="toggleSellerFilter()">Filtre</button>
            </h2>

            <!-- Filtre Kutusu -->
            <div id="sellerFilterBox">
                <label>Satıcı Seç (dropdown)</label>
                <select id="filterSellerSelect">
                    <option value="">Tüm Satıcılar</option>
                </select>

                <label>Satıcı Ad Soyad (Metin Arama)</label>
                <input type="text" id="filterSellerName" placeholder="Satıcı adında ara...">

                <label>Ekip</label>
                <input type="text" id="filterTeam" placeholder="Ekip adı...">

                <label>Şehir</label>
                <input type="text" id="filterCity" placeholder="Şehir...">

                <label>Ülke</label>
                <input type="text" id="filterCountry" placeholder="Ülke...">

                <label>Tur Adı</label>
                <input type="text" id="filterTourName" placeholder="Tur adı...">

                <label>Başlangıç Tarihi</label>
                <input type="date" id="filterStartDate">

                <label>Bitiş Tarihi</label>
                <input type="date" id="filterEndDate">

                <button onclick="filterSellerSales()">Filtrele</button>
                <button style="background:#f44336;" onclick="resetSellerFilters()">Sıfırla</button>
            </div>

            <!-- Satış Listesi Tablosu -->
            <div id="sellerSalesTableContainer">
                <table class="seller-sales-table">
                    <thead>
                        <tr>
                            <th>Satıcı</th>
                            <th>Tur</th>
                            <th>Tarih</th>
                            <th>Kişi</th>
                            <th>Tutar</th>
                            <th>Ödeme</th>
                            <th>Müşteri</th>
                        </tr>
                    </thead>
                    <tbody id="sellerSalesTbody">
                        <!-- Filtrelenmiş sonuçlar buraya gelecek -->
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" style="text-align:right;">Toplam</td>
                            <td id="sellerSalesTotal" colspan="3"></td>
                        </tr>
                        <tr>
                            <td colspan="4" style="text-align:right;">Komisyon (%10)</td>
                            <td id="sellerSalesCommission" colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Modal (Daha estetik) -->
        <div id="saleDetailModalOverlay2" onclick="closeSaleDetailModal2(event)">
            <div id="saleDetailModal2" onclick="event.stopPropagation()">
                <span class="close-btn" onclick="closeSaleDetailModal2()">✖</span>
                <h4>Satış Detayı</h4>
                <div id="saleDetailModalContent2"></div>
            </div>
        </div>



        <!-- 📦 SATIÇI YÖNETİM PANELİ -->
        <div id="sellerPanel" style="padding: 20px; background: #fff; border-radius: 12px;">
            <h2>✨ Satıcı Yönetimi</h2>

            <!-- ✅ KAYIT FORMU -->
            <form id="sellerForm"
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px;">
                <input id="sellerUsername" placeholder="Kullanıcı Adı" required />
                <input id="sellerPassword" placeholder="Şifre" required type="password" />
                <input id="sellerName" placeholder="Ad Soyad" />
                <input id="sellerPhone" placeholder="Telefon" />
                <input id="sellerTC" placeholder="TC/Vergi No" />
                <input id="sellerIBAN" placeholder="IBAN" />
                <input id="sellerTeam" placeholder="Ekip Adı" />
                <input id="sellerCity" placeholder="Şehir" />
                <input id="sellerCountry" placeholder="Ülke" />
            </form>
            <button onclick="saveSeller()">➕ Kaydet</button>

            <!-- 🔍 FİLTRELEME -->
            <div style="margin: 20px 0; display:flex; flex-wrap:wrap; gap:10px;">
                <input id="filterName" placeholder="İsim" />
                <input id="filterTeam" placeholder="Ekip" />
                <input id="filterCity" placeholder="Şehir" />
                <input id="filterCountry" placeholder="Ülke" />
                <button onclick="filterSellers()">🔍 Filtrele</button>
                <button onclick="resetFilters()">↩️ Sıfırla</button>
            </div>

            <!-- 📄 SATIÇI KART LİSTESİ -->
            <div id="sellerList"
                style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;"></div>
        </div>

        <!-- ✏️ GÜNCELLEME MODAL -->
        <div id="sellerEditModal"
            style="display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(0,0,0,0.5); z-index:999; justify-content:center; align-items:center;">
            <div
                style="background:#fff; padding:20px; width:90%; max-width:400px; border-radius:12px; position:relative;">
                <span onclick="closeEditModal()"
                    style="position:absolute;top:10px;right:15px;font-size:22px;cursor:pointer;color:red;">✖</span>
                <h3>✏️ Satıcı Güncelle</h3>
                <input type="hidden" id="editSellerId" />
                <input id="editSellerName" placeholder="Ad Soyad" />
                <input id="editSellerPhone" placeholder="Telefon" />
                <input id="editSellerCity" placeholder="Şehir" />
                <input id="editSellerCountry" placeholder="Ülke" />
                <input id="editSellerIBAN" placeholder="IBAN" />
                <input id="editSellerPassword" placeholder="Yeni Şifre (opsiyonel)" type="password" />
                <button onclick="updateSeller()">💾 Kaydet</button>
            </div>
        </div>

        <!-- 📊 PERFORMANS PANELİ -->
        <div id="sellerStats"
            style="display:none; margin-top:20px; background:#f1f8e9; padding:15px; border-radius:12px;">
            <h3>📊 Satış Performansı</h3>
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                <button onclick="loadStats('1d')">🗓️ 1 Gün</button>
                <button onclick="loadStats('1w')">📆 1 Hafta</button>
                <button onclick="loadStats('1m')">📆 1 Ay</button>
                <input type="date" id="customStart" />
                <input type="date" id="customEnd" />
                <button onclick="loadStats('custom')">📅 Aralık</button>
                <button onclick="switchChart()">📉 Grafik Tipi</button>
                <button onclick="printStats()">🖨️ Yazdır</button>
            </div>
            <div id="sellerStatsSummary" style="margin-top: 10px; font-weight: bold;"></div>
            <canvas id="sellerChart" style="margin-top:15px; width:100%; max-width:600px;"></canvas>
        </div>


        <!-- 💼 Satıcı Satış Muhasebesi MODALI -->
        <div id="sellerSalesModal"
            style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
            <div
                style="background:white; padding:20px; border-radius:12px; max-width:700px; width:90%; max-height:90vh; overflow-y:auto; position:relative;">
                <span onclick="closeSellerSalesModal()"
                    style="position:absolute; top:10px; right:15px; font-size:20px; color:red; cursor:pointer;">✖</span>
                <h3 id="sellerSalesTitle">📊 Satış Detayları</h3>
                <table style="width:100%; border-collapse: collapse; margin-top: 10px;" border="1">
                    <thead style="background:#ffe0b2;">
                        <tr>
                            <th>📅 Tarih</th>
                            <th>🚌 Tur</th>
                            <th>👤 Müşteri</th>
                            <th>👥 Kişi</th>
                            <th>💳 Ödeme</th>
                            <th>💰 Tutar</th>
                        </tr>
                    </thead>
                    <tbody id="sellerSalesBody"></tbody>
                    <tfoot style="background:#fff8e1; font-weight: bold;">
                        <tr>
                            <td colspan="5">Toplam</td>
                            <td id="sellerSalesTotal">0 TL</td>
                        </tr>
                        <tr>
                            <td colspan="5">Komisyon (%10)</td>
                            <td id="sellerSalesCommission">0 TL</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>



        <!-- TUR DÜZENLE MODALI -->
        <div id="editTourModal" class="modal-edit">
            <div class="modal-edit-content">
                <span class="close" onclick="closeEditModal()">&times;</span>
                <h3>⚡ Tur Güncelle</h3>

                <input type="hidden" id="editTourId" />

                <label>Adı:</label>
                <input type="text" id="editTourName" />

                <label>Açıklama:</label>
                <textarea id="editTourDesc" rows="2"></textarea>

                <label>Tarih:</label>
                <input type="date" id="editTourDate" />

                <label>Başlangıç Saati:</label>
                <input type="time" id="editTourStart" />

                <label>Bitiş Saati:</label>
                <input type="time" id="editTourEnd" />

                <label>Fiyat (TL):</label>
                <input type="number" id="editTourPrice" />

                <label>Rehber:</label>
                <input type="text" id="editTourGuide" />

                <label>Toplam Koltuk:</label>
                <input type="number" id="editTourSeats" />

                <button onclick="saveTourEdits()">💾 Kaydet</button>
            </div>
        </div>


        <button onclick="sendNotification()"
            style="margin-top:10px;background:#03a9f4;color:#fff;padding:10px 16px;border:none;border-radius:6px;">📤
            Gönder</button>
        </div>



        <button class="logout" onclick="logout()" data-key="admin_logout">Çıkış</button>
    </section>

    <!-- SATICI EKRANI -->
    <section class="sales-section" id="salesSection">
        <h2 data-key="seller_panel">Satıcı Paneli</h2>
        <p data-key="seller_panel_sub">
            Merhaba <span id="sellerName"></span>. Burada tüm turları görüp, Turu Sat yapabilir ve Kayıtlı Turlarınızı
            inceleyebilirsiniz.
        </p>

        <!-- Satıcıdan Admin Ekranına Dön (Sadece Admin isen) -->
        <button id="sellerToAdminBtn" style="display:none; margin-bottom:10px; background:#9c27b0;"
            onclick="goToAdmin()">
            Admin Ekranına Geç
        </button>


        <h3>Satıcı Bilgilerim</h3>
        <label>Yeni Satıcı Adı:</label>
        <input type="text" id="sellerNewName" />
        <label>Yeni Şifre:</label>
        <input type="password" id="sellerNewPass" />
        <button onclick="sellerUpdateProfile()">Güncelle</button>
        </div>



        <div class="centered-container" style="margin-bottom:20px;">
            <h4>Tur Filtre (Satıcı)</h4>
            <label>Tur Adı:</label>
            <input type="text" id="sellerTourFilterName" placeholder="Ara..." />
            <label>Kod (1/2/3):</label>
            <input type="text" id="sellerTourFilterCode" placeholder="örn: 2" />
            <label>Tarih (en erken):</label>
            <input type="date" id="sellerTourFilterStart" />
            <label>Tarih (en geç):</label>
            <input type="date" id="sellerTourFilterEnd" />
            <!-- Eklenmesi gereken satır -->
            <label>Konum:</label>
            <input type="text" id="sellerTourFilterLocation" placeholder="Konum ara...">
            <label>Min Fiyat:</label>
            <input type="number" id="filterMinPrice" placeholder="En az fiyat">

            <label>Max Fiyat:</label>
            <input type="number" id="filterMaxPrice" placeholder="En yüksek fiyat">

            <label>Min Koltuk:</label>
            <input type="number" id="filterMinSeats" placeholder="En az koltuk">

            <label><input type="checkbox" id="filterOnlyAvailable"> Sadece boş koltuk olanlar</label>


            <button onclick="renderSellerTours()">Filtrele</button>
        </div>

        <div class="centered-container">
            <h3 data-key="seller_stats">Satıcı İstatistikleri</h3>
            <p id="sellerStatsContent">Henüz satış yok.</p>
            <button style="background:#8bc34a;" onclick="showSellerAccounting()">Ayrıntılı Muhasebe</button>
        </div>

        <div id="sellerAccounting" class="centered-container">
            <h3>📊 Ayrıntılı Satış Muhasebesi</h3>
            <div class="seller-acc-filter">
                <label>🚌 Tur Adı:</label>
                <input type="text" id="accFilterTour" />

                <label>📅 Tarih Aralığı:</label>
                <input type="date" id="accFilterStart" /> -
                <input type="date" id="accFilterEnd" />

                <label>💳 Ödeme Tipi:</label>
                <select id="accFilterPayType">
                    <option value="">Tümü</option>
                    <option value="Kredi Kartı">Kredi Kartı</option>
                    <option value="Araçta Ödeme">Araçta Ödeme</option>
                    <option value="Banka Havalesi">Banka Havalesi</option>
                </select>

                <label>📍 Lokasyon:</label>
                <input type="text" id="accFilterLocation" />

                <button onclick="filterSellerAccounting()">Filtrele</button>
                <button onclick="hideSellerFilter()"
                    style="margin-left: 10px; background: crimson; color: white; border-radius: 5px; padding: 5px 10px;">
                    ❌ Kapat
                </button>


            </div>
            <div id="sellerAccountingContent"></div>
        </div>


        <div class="centered-container" style="margin-top:20px;">
            <div id="sellerSavedList" style="display:none; margin-top:10px;"></div>
        </div>

        <div class="centered-container" style="margin-top:20px;">
            <h3 data-key="seller_activeTours">Tüm Turlar</h3>
            <div id="sellerTourList"></div>


        </div>
        <div class="reservation-form">
            <h3>🚀 İleri Tarihli Rezervasyon Oluştur</h3>
            <input type="text" id="tourName" placeholder="🌍 Tur Adı">
            <input type="date" id="tourDate">
            <input type="number" id="personCount" placeholder="👥 Kişi Sayısı">
            <input type="text" id="customerName" placeholder="😊 Müşteri Adı">
            <input type="text" id="customerSurname" placeholder="✏️ Müşteri Soyadı">
            <input type="text" id="country" placeholder="🏳️ Ülke">
            <input type="tel" id="phone" placeholder="📞 Telefon">
            <textarea id="notes" placeholder="📌 Notlar (Opsiyonel)"></textarea>
            <button id="reservationSaveBtn" onclick="saveReservation()">💾 Rezervasyonu Kaydet</button>

        </div>



        <button class="logout" onclick="logout()" data-key="seller_logout" style="margin-left:10px;">Çıkış</button>


    </section>
    <div id="chat-widget">
        <div class="chat-header" onclick="toggleChat()">
            Canlı Destek 💬
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-messages" id="chatMessages">
                <div class="message bot">👋 Merhaba, size nasıl yardımcı olabilirim?</div>
            </div>
            <div class="chat-input">
                <input type="text" id="userMessage" placeholder="Mesajınız...">
                <button onclick="sendMessage()">Gönder</button>
            </div>
        </div>
    </div>



    <!-- ============================== FIREBASE ENTEGRASYONU ============================== -->
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-storage-compat.js"></script>

    <script>
        /* ================== 1. Firebase Config (Kendi projenizin ayarları) ================== */
        const firebaseConfig = {
            apiKey: "AIzaSyDI6f_7_9ew-p5kE5oDAe1FNTD3K9kYg-k",
            authDomain: "tur-61.firebaseapp.com",
            projectId: "tur-61",
            storageBucket: "tur-61.firebasestorage.app",
            messagingSenderId: "294563420707",
            appId: "1:294563420707:web:97f50bb6f7dee679a9ef96"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        /* ================== 2. Koleksiyonlar ================== */
        const toursCollection = db.collection("tours");
        const salesCollection = db.collection("salesHistory");
        const sellersCollection = db.collection("sellers");

        /* ================== 3. Global Değişkenler ================== */
        let users = [
            { username: "admin", password: "12345", role: "admin", name: "Admin" },
            { username: "satici1", password: "12345", role: "seller", name: "Satıcı 1" }
        ];
        let currentUser = null;
        let tours = [];
        let salesHistory = [];
        let sellers = [];

        /* ================== Set Payment Status ================== */
        async function setPaymentStatus(saleId, status) {
            try {
                const currentSalesHistoryDoc = await salesCollection.doc(saleId).get();

                if (currentSalesHistoryDoc.exists) {
                    const currentSalesHistory = currentSalesHistoryDoc.data();

                    if (currentSalesHistory.paymentStatus !== "completed") {
                        await salesCollection.doc(saleId).update({ paymentStatus: status });

                        if (currentSalesHistory.tourId && currentSalesHistory.seatsSold) {
                            await db.collection("tours").doc(currentSalesHistory.tourId).update({
                                soldSeats: firebase.firestore.FieldValue.increment(currentSalesHistory.seatsSold)
                            });
                        } else {
                            console.error("Eksik tur bilgisi veya koltuk sayısı.");
                        }

                        // URL search query params cleanup
                        const url = new URL(window.location.href);
                        url.searchParams.delete("action");
                        url.searchParams.delete("oid");
                        url.searchParams.delete("success");
                        window.history.replaceState({}, document.title, url.toString());

                        alert("Ödeme başarıyla güncellendi.");
                    }
                } else {
                    alert("Satış kaydı bulunamadı.");
                }
            } catch (error) {
                alert("Ödeme durumu güncellenirken hata oluştu: " + error);
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const saleId = urlParams.get("oid");
        const paymentIsSuccess = urlParams.get("success");

        if (urlParams.get("action") === "payment-result") {
            if (saleId && saleId != "" && paymentIsSuccess == "true") {
                setPaymentStatus(saleId, "completed");
            } else if (saleId) {
                setPaymentStatus(saleId, "failed");
                alert("Ödeme başarısız!");
            }
        }

        /* ================== 4. Giriş / Çıkış & Rol Ekranları ================== */
        // login fonksiyonunuzu düzeltin
        async function login() {
            const un = document.getElementById("loginUsername").value.trim();
            const pw = document.getElementById("loginPassword").value.trim();

            let found = users.find(u => u.username === un && u.password === pw);
            if (found) {
                currentUser = found;
                showRoleScreen(found.role);
                return;
            }

            try {
                const doc = await sellersCollection.doc(un).get();
                if (!doc.exists) {
                    alert("Kullanıcı/Şifre hatalı!");
                    return;
                }
                let data = doc.data();
                if (data.password === pw && data.role === "seller") {
                    currentUser = {
                        username: un,
                        password: pw,
                        role: "seller",
                        name: data.name || un
                    };
                    showRoleScreen("seller");
                } else {
                    alert("Kullanıcı/Şifre hatalı!");
                }
            } catch (err) {
                console.error(err);
                alert("Firebase hatası: " + err);
            }
        }


        function showRoleScreen(role) {
            document.getElementById("loginSection").classList.remove("active");
            if (role === "admin") {
                document.getElementById("adminSection").classList.add("active");
                document.getElementById("adminName").textContent = currentUser.name;
                renderAdminTours();
                renderSalesReport();
            } else {
                document.getElementById("salesSection").classList.add("active");
                document.getElementById("sellerName").textContent = currentUser.name;
                if (currentUser.username === "admin") {
                    document.getElementById("sellerToAdminBtn").style.display = "inline-block";
                } else {
                    document.getElementById("sellerToAdminBtn").style.display = "none";
                }
                renderSellerTours();
                renderSellerStats();
            }
        }
        function logout() {
            currentUser = null;
            document.getElementById("loginSection").classList.add("active");
            document.getElementById("adminSection").classList.remove("active");
            document.getElementById("salesSection").classList.remove("active");
            document.getElementById("loginUsername").value = "";
            document.getElementById("loginPassword").value = "";
        }
        function goToSeller() {
            if (!currentUser || currentUser.role !== "admin") {
                alert("Sadece admin!");
                return;
            }
            document.getElementById("adminSection").classList.remove("active");
            document.getElementById("salesSection").classList.add("active");
            document.getElementById("sellerName").textContent = currentUser.name;
            if (currentUser.username === "admin") {
                document.getElementById("sellerToAdminBtn").style.display = "inline-block";
            }
            renderSellerTours();
            renderSellerStats();
        }
        function goToAdmin() {
            if (!currentUser || currentUser.username !== "admin") {
                alert("Sadece admin geri dönebilir!");
                return;
            }
            document.getElementById("salesSection").classList.remove("active");
            document.getElementById("adminSection").classList.add("active");
            renderAdminTours();
            renderSalesReport();
        }

        /* ================== 5. Admin Şifre Değiştir ================== */
        function changeAdminPass() {
            if (!currentUser || currentUser.username !== "admin") {
                alert("Sadece admin!");
                return;
            }
            const np = document.getElementById("newAdminPass").value.trim();
            if (!np) {
                alert("Boş olamaz");
                return;
            }
            let adm = users.find(u => u.username === "admin");
            adm.password = np;
            alert("Admin şifre değişti => " + np);
        }

        /* ================== 6. Firestore onSnapshot: Turlar, Satışlar, Sellers ================== */
        toursCollection.onSnapshot(snap => {
            tours = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (currentUser) {
                if (currentUser.role === "admin") {
                    renderAdminTours();
                    renderSalesReport();
                } else {
                    renderSellerTours();
                    renderSellerStats();
                }
            }
        });
        salesCollection.onSnapshot(snap => {
            salesHistory = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (currentUser) {
                if (currentUser.role === "admin") {
                    renderSalesReport();
                } else if (currentUser.role === "seller") {
                    renderSellerStats();
                }
            }
        });
        sellersCollection.onSnapshot(snap => {
            sellers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if (currentUser && currentUser.role === "admin") {
                listSellers();
            }
        });

        /* ================== 7. Admin: Tur Ekleme (Foto Yükleme) ================== */
        async function uploadImagesAndCreateTour() {
            const name = document.getElementById("addTourName").value.trim();
            const desc = document.getElementById("addTourDesc").value.trim();
            const date = document.getElementById("addTourDate").value;
            const start = document.getElementById("addTourStart").value;
            const end = document.getElementById("addTourEnd").value;
            const priceStr = document.getElementById("addTourPrice").value.trim();
            const stopsStr = document.getElementById("addTourStops").value.trim();
            const location = document.getElementById("addTourLocation").value.trim();
            const guide = document.getElementById("addTourGuide").value.trim();
            const seatsStr = document.getElementById("addTourSeats").value.trim();
            const codeVal = document.getElementById("addTourCode").value;
            const alternativeTourName = document.getElementById("alternativeTourName")?.value?.trim() || "Yok";

            const dayPlans = document.getElementById("dayPlans")?.value || "";
            const stayPlan = document.getElementById("stayPlan")?.value || "";
            const packagePrice = parseFloat(document.getElementById("packagePrice")?.value || "0");
            const currency = document.getElementById("currency")?.value || "TL";

            if (!name || !desc || !date || !start || !end || !priceStr || !stopsStr || !location || !guide || !seatsStr || !codeVal) {
                alert("❗ Tüm alanları doldurun!");
                return;
            }

            const price = parseFloat(priceStr);
            const seats = parseInt(seatsStr);
            if (isNaN(price) || isNaN(seats)) {
                alert("❌ Fiyat veya koltuk sayısı hatalı!");
                return;
            }

            const stops = stopsStr.split(",").map(x => x.trim()).filter(x => x);
            const autoCode = "TUR-" + Date.now();
            let imageUrls = [];

            const fileInput = document.getElementById("addTourImages");
            if (fileInput.files.length > 0) {
                alert("📤 Görseller yükleniyor...");
                imageUrls = await uploadFilesToFirebaseStorage(fileInput.files, autoCode);
            }

            const newTour = {
                name,
                description: desc,
                date,
                startTime: start,
                endTime: end,
                price,
                stops,
                location,
                guide,
                seats,
                soldSeats: 0,
                video: document.getElementById("addTourVideo").value.trim() || "",
                images: imageUrls,
                isSaved: false,
                code: codeVal,
                tourCode: autoCode,
                savedBy: [],
                alternativeTour: alternativeTourName,
                dayPlans: codeVal === "3" ? dayPlans : "",
                stayPlan: codeVal === "3" ? stayPlan : "",
                packagePrice: codeVal === "3" ? packagePrice : null,
                currency: codeVal === "3" ? currency : ""
            };

            console.log("📝 Firebase'e eklenecek veri:", newTour);

            try {
                await toursCollection.add(newTour);
                alert("✅ Tur başarıyla eklendi!");
                renderAdminTours();
                renderSellerTours();

                document.getElementById("addTourForm")?.reset?.();
            } catch (err) {
                console.error("🔥 Tur ekleme hatası:", err);
                alert("❌ Tur eklenirken hata oluştu: " + err.message);
            }
        }

        function tourCodeChange() {
            const code = document.getElementById("addTourCode").value;
            const packageDetails = document.getElementById("packageDetails");
            packageDetails.style.display = (code === "3") ? "block" : "none";
        }


        async function uploadFilesToFirebaseStorage(files, tourCode) {
            const storageRef = firebase.storage().ref();
            let uploadedUrls = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileRef = storageRef.child(`tour_images/${tourCode}_${i}_${file.name}`);
                try {
                    const snapshot = await fileRef.put(file);
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    uploadedUrls.push(downloadURL);
                } catch (err) {
                    console.error("Görsel yükleme hatası:", err);
                    alert("Görsel yüklenirken hata: " + err.message);
                }
            }
            return uploadedUrls;
        }

        /* ================== 8. Admin: Turlar Listele, Filtre, Satış Raporu ================== */
        function renderAdminTours() {
            let c = document.getElementById("adminTourList");
            c.innerHTML = "";
            let arr = filterAdminTours(true);
            if (!arr.length) {
                c.innerHTML = "<p>Tur yok.</p>";
                return;
            }

            arr.forEach(t => {
                let dv = document.createElement("div");
                dv.classList.add("tour-item");
                dv.setAttribute("data-tour-id", t.id);
                dv.classList.add("code-" + t.code);

                let totalSeats = t.seats || 0;
                let soldSeats = t.soldSeats || 0;
                let freeSeats = totalSeats - soldSeats;

                dv.innerHTML = `
      <h3>${t.name}</h3>
      <p><strong>Kod (Kategori):</strong> ${t.code} <strong>TourCode:</strong> ${t.tourCode}</p>
      <p><strong>Tarih/Saat:</strong> ${t.date} ${t.startTime}-${t.endTime}</p>
      <p><strong>Fiyat:</strong> ${t.price} TL</p>
      <p><strong>Koltuk:</strong> Toplam: ${totalSeats}, Satılan: ${soldSeats}, Boş: ${freeSeats}</p>
      <p><strong>Duraklar:</strong> ${t.stops.join(", ")}</p>
      <p><strong>Konum:</strong> ${t.location}, <strong>Rehber:</strong> ${t.guide}</p>
      <p>${t.description}</p>
    `;

                if (t.code === "3") {
                    dv.innerHTML += `
    <div style="margin-top:10px; padding:10px; background:#fffde7; border-radius:8px;">
      <p><strong>📅 Program:</strong><br>${t.dayPlans ? t.dayPlans : "Yok"}</p>
      <p><strong>🏨 Konaklama:</strong><br>${t.stayPlan || "-"}</p>
      <p><strong>💰 Fiyat:</strong> ${t.packagePrice || "?"} ${t.currency || "TL"}</p>
    </div>
  `;
                }
                // Alternatif tur ve medya içerikleri
                dv.innerHTML += `
      <div class="alternative-tour" id="alternative_${t.id}">
        <span>🔁 Alternatif Tur: <strong>${t.alternativeTour || "yok"}</strong></span>
      </div>

      <div class="tour-images" id="admin_img_${t.id}"></div>
      ${t.video ?
                        `<div class="tour-video">
          <iframe src="${t.video}"
          allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen></iframe>
        </div>` : ""}



      <div class="geriSayim" data-tarih="${t.date}T${t.startTime}"></div>


      <button onclick='saveTour("${t.id}")'>Turu Kaydet</button>
      <button style='background:#f44336;' onclick='deleteTour("${t.id}")'>Sil</button>
      <button style='background:#ff9800;' onclick='editTour("${t.id}")'>Düzenle</button>
      <button style='background:#9c27b0;color:#fff;' onclick='shareTour("${t.id}")'>Paylaş</button>
      <button style='background:#009688;color:#fff;' onclick='whatsappTour("${t.id}")'>WhatsApp</button>
      <button style='background:#795548;color:#fff;' onclick='openSoldSeatsModal("${t.id}")'>Satılmış Koltuklar</button>
    `;

                // HTML kartı sayfaya ekle
                c.appendChild(dv);

                // Görselleri ekle
                let imgDiv = dv.querySelector(`#admin_img_${t.id}`);
                if (t.images && t.images.length) {
                    t.images.forEach(src => {
                        let im = document.createElement("img");
                        im.src = src;
                        im.onclick = () => openImageModal(src);
                        imgDiv.appendChild(im);
                    });
                }
            });
        }


        function filterAdminTours(returnArray = false) {
            let nameF = (document.getElementById("adminTourFilterName").value || "").trim().toLowerCase();
            let codeF = (document.getElementById("adminTourFilterCode").value || "").trim();
            let startF = document.getElementById("adminTourFilterStart").value;
            let endF = document.getElementById("adminTourFilterEnd").value;
            let locF = (document.getElementById("adminTourFilterLocation")?.value || "").trim().toLowerCase();
            // Yeni filtre alanları:
            let priceMin = parseFloat(document.getElementById("adminFilterPriceMin")?.value || "0");
            let priceMax = parseFloat(document.getElementById("adminFilterPriceMax")?.value || "9999999");
            let minSeats = parseInt(document.getElementById("adminFilterSeats")?.value || "0");
            let onlyAvailable = document.getElementById("adminFilterOnlyAvailable")?.checked;

            let arr = [...tours];
            if (nameF) arr = arr.filter(t => t.name.toLowerCase().includes(nameF));
            if (codeF) arr = arr.filter(t => t.code === codeF);
            if (startF) {
                let s = new Date(startF).getTime();
                arr = arr.filter(t => new Date(t.date).getTime() >= s);
            }
            if (endF) {
                let e = new Date(endF).getTime();
                arr = arr.filter(t => new Date(t.date).getTime() <= e);
            }
            if (locF) arr = arr.filter(t => (t.location || "").toLowerCase().includes(locF));
            arr = arr.filter(t => t.price >= priceMin && t.price <= priceMax);
            arr = arr.filter(t => t.seats >= minSeats);
            if (onlyAvailable) {
                arr = arr.filter(t => (t.seats - (t.soldSeats || 0)) > 0);
            }

            if (returnArray) return arr;



            renderAdminTours();
        }
        // Admin Satış Raporu Yenilenmiş Script

        /* === 1) DETAY MODALI === */
        function showSaleDetailModal(saleData) {
            const overlay = document.getElementById("saleDetailModalOverlay");
            const modal = document.getElementById("saleDetailModal");

            if (!overlay || !modal) return;

            // Modal içeriğini dolduralım
            modal.querySelector("#saleDetailContent").innerHTML = `
    <p><strong>Satıcı:</strong> ${saleData.sellerName || "-"} </p>
    <p><strong>Müşteri (Ana Katılımcı):</strong> ${saleData.buyerName || "-"} </p>
    <p><strong>Adres:</strong> ${saleData.address || "-"} </p>
    <p><strong>Alternatif Tur:</strong> ${saleData.alternativeTour || "-"} </p>
    <p><strong>Ülke:</strong> ${saleData.buyerCountry || "-"} </p>
    <p><strong>İletişim:</strong> ${saleData.buyerContact || "-"} </p>
    <p><strong>E-Mail:</strong> ${saleData.buyerEmail || "-"} </p>
    <hr/>
    <h4>Katılımcılar</h4>
    ${(saleData.occupants && saleData.occupants.length)
                    ? saleData.occupants.map((o, i) => `
          <div style="border:1px solid #ccc; padding:5px; margin-bottom:5px; border-radius:4px;">
            <strong>Kişi #${i + 1}</strong><br/>
            Ad: ${o.name || "-"} <br/>
            Belge Tipi: ${o.docType || "-"} <br/>
            Belge No: ${o.docNo || "-"} <br/>
            Ülke: ${o.country || "-"}
          </div>
        `).join("")
                    : "<p>Kişi yok.</p>"
                }
  `;

            overlay.style.display = "flex";
        }
        function closeSaleDetailModal() {
            document.getElementById("saleDetailModalOverlay").style.display = "none";
        }

        /* === 2) TABLO RENDER === */


        function renderSalesReport() {
            const container = document.getElementById("salesReportTable");
            const header = document.getElementById("salesReportHeader");
            if (!container || !salesHistory || !salesHistory.length) return;

            const sorted = [...salesHistory].sort((a, b) => new Date(b.date) - new Date(a.date));

            let html = `
   <div style="overflow-x:auto; width:100%; max-width:1400px; margin: 0 auto; padding: 0 20px;">
<div style="margin-bottom:10px;">
    <button onclick="exportSelectedToExcel()" style="background:#4caf50; color:#fff; padding:8px 14px; border:none; border-radius:6px; margin-right:10px; cursor:pointer;">
      📥 Excel'e Aktar
    </button>

  </div>    <table style="min-width:1000px; border-collapse:collapse; width:100%; background:#fff; box-shadow:0 0 10px rgba(0,0,0,0.1); border-radius:8px; overflow:hidden;">
      <thead style="background:#2e3b4e; color:#fff;">
        <tr>
          <th style="padding:10px;">✔</th>
          <th>👤 Satıcı</th>
          <th>🧍 Müşteri</th>
          <th>📅 Satış</th>
          <th>🗓️ Tur Tarihi</th>
          <th>🎯 Tur Adı</th>
          <th>Belge Tipi/No</th>
          <th>👥 Katılımcılar</th>
          <th>🌍 Ülke</th>
          <th>📞 İletişim</th>
          <th>📧 Email</th>
          <th>📍 Adres</th>
          <th>🏨 Konaklama</th>
          <th style="background:#ffeb3b; color:#000;">🔁 Alternatif Tur</th>
          <th>Toplam Tutar</th>
          <th>Ödeme Türü</th>
          <th>📋 Detay</th>
          <th>💬 WhatsApp</th>
        </tr>
        <tr style="background:#f0f0f0;">
  <th></th>
  <th><input oninput="tableFilter(1, this.value)" placeholder="Satıcı..." /></th>
  <th><input oninput="tableFilter(2, this.value)" placeholder="Müşteri..." /></th>
  <th><input oninput="tableFilter(3, this.value)" placeholder="Satış..." /></th>
  <th><input oninput="tableFilter(4, this.value)" placeholder="Tur Tarihi..." /></th>
  <th><input oninput="tableFilter(5, this.value)" placeholder="Tur Adı..." /></th>
  <th><input oninput="tableFilter(3, this.value)" placeholder="Belge No..." /></th>
  <th><input oninput="tableFilter(6, this.value)" placeholder="Katılımcı..." /></th>
  <th><input oninput="tableFilter(7, this.value)" placeholder="Ülke..." /></th>
  <th><input oninput="tableFilter(8, this.value)" placeholder="İletişim..." /></th>
  <th><input oninput="tableFilter(9, this.value)" placeholder="Email..." /></th>
  <th><input oninput="tableFilter(10, this.value)" placeholder="Adres..." /></th>
  <th><input oninput="tableFilter(11, this.value)" placeholder="Konaklama..." /></th>
  <th><input oninput="tableFilter(12, this.value)" placeholder="Alternatif Tur..." /></th>
  <th><input oninput="tableFilter(12, this.value)" placeholder="Toplam Tutar..." /></th>
  <th><input oninput="tableFilter(12, this.value)" placeholder="Ödeme Türü...r..." /></th>
  <th></th>
  <th></th>
</tr>

      </thead>
      <tbody>
  `;


            sorted.forEach(sale => {
                const occ = (sale.occupants || []).map(o => `${o.name || "?"} (${o.docType || "-"}: ${o.docNo || "-"})`).join(", ") || "-";
                const belge = `${sale.docType || sale.buyerDocType || "-"}: ${sale.docNo || sale.buyerDocNo || "-"}`;

                html += `
      <tr style="border-bottom:1px solid #eee;">
        <td style="text-align:center;"><input type="checkbox" class="saleCheck" data-id="${sale.id}" /></td>
        <td>${sale.sellerName || "-"}</td>
        <td>${sale.buyerName || "-"}</td>
        <td>${new Date(sale.date).toLocaleString()}</td>
        <td>${sale.tourDate || "-"}</td>
        <td>${sale.tourName || "-"}</td>
         <td>${belge}</td>
        <td>${occ}</td>
        <td>${sale.buyerCountry || "-"}</td>
        <td>${sale.buyerContact || "-"}</td>
        <td>${sale.buyerEmail || "-"}</td>
        <td>${sale.address || "-"}</td>
        <td>${sale.stayType || "-"}</td>

        <td style="background:#fff176; font-weight:bold;">${sale.alternativeTour || "-"}</td>
         <td>${sale.totalPrice || "-"} TL</td>
        <td>${sale.paymentType || "-"}</td>
        <td>
          <button onclick="openSaleDetailModal('${sale.id}')" style="background:#ff9800;color:#fff;padding:4px 8px;border:none;border-radius:4px;">Detay</button>
        </td>
        <td>
          <button onclick="sendWhatsApp('${sale.id}')" style="background:#25D366;color:#fff;padding:4px 8px;border:none;border-radius:4px;">WhatsApp</button>
        </td>
      </tr>
    `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }
        function tableFilter(colIndex, filterVal) {
            filterVal = filterVal.toLowerCase();
            const table = document.getElementById("salesReportTable");
            if (!table) return;
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(row => {
                const text = (row.cells[colIndex]?.innerText || "").toLowerCase();
                row.style.display = text.includes(filterVal) ? "" : "none";
            });
        }

        function openSaleDetailModal(saleId) {
            const sale = salesHistory.find(s => s.id === saleId);
            if (!sale) return alert("Kayıt bulunamadı!");
            const tour = tours.find(t => t.id === sale.tourId) || {};
            const occ = (sale.occupants || []).map((o, i) => `👤 ${o.name} (${o.docType}: ${o.docNo})`).join("<br>");
            const belge = `${sale.docType || sale.buyerDocType || "-"}: ${sale.docNo || sale.buyerDocNo || "-"}`;

            const content = `
    <p><strong>🧍 Müşteri:</strong> ${sale.buyerName}</p>
    <p><strong>🪪 Belge:</strong> ${belge}</p>
    <p><strong>📞 İletişim:</strong> ${sale.buyerContact}</p>
    <p><strong>📧 Email:</strong> ${sale.buyerEmail}</p>
    <p><strong>🌍 Ülke:</strong> ${sale.buyerCountry}</p>
    <p><strong>📅 Satış Tarihi:</strong> ${new Date(sale.date).toLocaleString()}</p>
    <p><strong>🗓️ Tur Tarihi:</strong> ${sale.tourDate || "-"}</p>
    <p><strong>🕐 Saat:</strong> ${sale.startTime || "-"} - ${sale.endTime || "-"}</p>
    <p><strong>📌 Tur Adı:</strong> ${sale.tourName}</p>
    <p><strong>📍 Adres:</strong> ${sale.address}</p>
    <p><strong>🏨 Konaklama:</strong> ${sale.stayType}</p>
    <p><strong>🔁 Alternatif Tur:</strong> ${sale.alternativeTour}</p>
    <p><strong>💰 Tutar:</strong> ${sale.totalPrice} TL</p>
    <p><strong>💳 Ödeme:</strong> ${sale.paymentType}</p>
    <hr><p><strong>👥 Katılımcılar:</strong><br>${occ}</p>
  `;

            document.getElementById("saleDetailContent").innerHTML = content;
            document.getElementById("saleDetailModalOverlay").style.display = "flex";
        }

        function sendWhatsApp(saleId) {
            const sale = salesHistory.find(s => s.id === saleId);
            if (!sale) return alert("Kayıt bulunamadı!");
            const tour = tours.find(t => t.id === sale.tourId) || {};
            const occ = (sale.occupants || []).map((o, i) => `👤 ${o.name} (${o.docType}: ${o.docNo})`).join("\n") || "-";
            const belge = `${sale.docType || sale.buyerDocType || "-"}: ${sale.docNo || sale.buyerDocNo || "-"}`;

            const msg = `
📋 *Satış Bilgisi*

👤 *Satıcı:* ${sale.sellerName || "-"}
🧍 *Müşteri:* ${sale.buyerName || "-"}
🪪 *Belge:* ${belge}
📞 *İletişim:* ${sale.buyerContact || "-"}
📧 *Email:* ${sale.buyerEmail || "-"}
🌍 *Ülke:* ${sale.buyerCountry || "-"}
📅 *Satış Tarihi:* ${new Date(sale.date).toLocaleString()}
🗓️ *Tur Tarihi:* ${sale.tourDate || "-"}
🕐 *Saat:* ${sale.startTime || "-"} - ${sale.endTime || "-"}
📌 *Tur Adı:* ${sale.tourName || "-"}
📍 *Adres:* ${sale.address || "-"}
🏨 *Konaklama:* ${sale.stayType || "-"}
🔁 *Alternatif Tur:* ${sale.alternativeTour || "-"}
💰 *Tutar:* ${sale.totalPrice || "-"} TL
💳 *Ödeme:* ${sale.paymentType || "-"}

👥 *Katılımcılar:*
${occ}`;

            const wpLink = `https://api.whatsapp.com/send?text=${encodeURIComponent(msg)}`;
            window.open(wpLink, '_blank');
        }



        /* === 4) WHATSAPP (mevcut fonksiyonun varsa koru) === */
        function whatsappSale(saleId) {
            const sale = salesHistory.find(x => x.id === saleId);
            if (!sale) { alert("Satış yok!"); return; }
            let tur = tours.find(t => t.id === sale.tourId);
            let msg = `
*Satış Bilgisi*:
Müşteri: ${sale.buyerName || "-"}
Ülke: ${sale.buyerCountry || "-"}
İletişim: ${sale.buyerContact || "-"}
Tur: ${sale.tourName || "-"}
Tarih: ${sale.tourDate || "-"}
Saat: ${(tur?.startTime || "-")} - ${(tur?.endTime || "-")}
Alternatif Tur: ${sale.alternativeTour || "-"}

Katılımcılar:
${(sale.occupants || []).map(o => (o.name || "?") + " (" + (o.docNo || "?") + ")").join(", ")}

Ödeme: ${sale.paymentType || "-"}
`;
            let url = "https://api.whatsapp.com/send?text=" + encodeURIComponent(msg);
            window.open(url, "_blank");
        }

        // ✅ Excel çıktısı: Tur bazlı grup başlığı + Satır satır satış listesi + İyi turlar dileriz
        function exportSelectedToExcel() {
            const checks = document.querySelectorAll(".saleCheck:checked");
            if (!checks.length) {
                alert("Hiç satır seçmediniz!");
                return;
            }

            const grouped = {};
            checks.forEach((chk, index) => {
                const saleId = chk.dataset.id;
                const sale = salesHistory.find(s => s.id === saleId);
                if (!sale) return;
                const key = `${sale.tourId}_${sale.tourDate}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push({ ...sale, index: index + 1 });
            });

            const tourNames = new Set();
            const dates = new Set();
            Object.values(grouped).forEach(group => {
                group.forEach(s => {
                    tourNames.add(s.tourName);
                    dates.add(s.tourDate);
                });
            });

            const tourAdStr = [...tourNames].join(", ");
            const dateStr = [...dates].map(d => {
                const dt = new Date(d);
                return `${String(dt.getDate()).padStart(2, "0")}.${String(dt.getMonth() + 1).padStart(2, "0")}.${dt.getFullYear()}`;
            }).join(", ");
            const fileName = `${dateStr} - ${tourAdStr}.xls`;

            let html = `<html><head><meta charset='UTF-8'></head><body style="font-family:sans-serif;">`;

            Object.entries(grouped).forEach(([key, sales]) => {
                const tour = tours.find(t => t.id === sales[0].tourId) || {};
                html += `
      <h1 style="margin-top:40px; font-size:22px;">🚍 ${sales[0].tourName}</h1>
      <p><strong>🧭 Rehber:</strong> ${tour.guide || "-"}</p>
      <p><strong>⏰ Saat:</strong> ${tour.startTime || "-"} - ${tour.endTime || "-"}</p>
      <table border="1" style="border-collapse:collapse; width:100%; margin-top:10px; margin-bottom:20px;">
        <thead style="background:#eeeeee;">
          <tr>
            <th>🆔 No</th>
            <th>👤 Müşteri</th>
            <th>🪪 Belge</th>
            <th>🌍 Ülke</th>
            <th>📞 İletişim</th>
            <th>📧 Email</th>
            <th>📍 Adres</th>
            <th>🏨 Konaklama</th>
            <th>🔁 Alternatif Tur</th>
            <th>👥 Katılımcılar</th>
            <th>💰 Tutar</th>
            <th>💳 Ödeme</th>
          </tr>
        </thead>
        <tbody>
    `;

                sales.forEach(sale => {
                    const belgeStr = `${sale.docType || sale.buyerDocType || "-"}: ${sale.docNo || sale.buyerDocNo || "-"}`;
                    const katilimci = (sale.occupants || []).map(o => `${o.name} (${o.docType}:${o.docNo})`).join(", ") || "-";

                    html += `
        <tr>
          <td>${sale.index}</td>
          <td>${sale.buyerName || "-"}</td>
          <td>${belgeStr}</td>
          <td>${sale.buyerCountry || "-"}</td>
          <td>${sale.buyerContact || "-"}</td>
          <td>${sale.buyerEmail || "-"}</td>
          <td>${sale.address || "-"}</td>
          <td>${sale.stayType || "-"}</td>
          <td>${sale.alternativeTour || "-"}</td>
          <td>${katilimci}</td>
          <td>${sale.totalPrice || "-"} TL</td>
          <td>${sale.paymentType || "-"}</td>
        </tr>
      `;
                });

                html += `</tbody></table>`;
            });

            html += `<p style="text-align:center; font-weight:bold; padding-top:20px;">🚌 İyi Turlar Dileriz</p>`;
            html += `</body></html>`;

            const blob = new Blob([html], { type: "application/vnd.ms-excel" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }


        /* === 6) SÜTUN FİLTRE (Excel'deki gibi açılan popup input) === */
        function toggleFilterPopup(event) {
            event.stopPropagation();
            // .filter-popup a ulaş
            const popup = event.target.nextElementSibling;
            if (!popup) return;
            // Görünür/görünmez toggle
            popup.style.display = (popup.style.display === "block") ? "none" : "block";
        }
        document.addEventListener("click", () => {
            // Sayfada herhangi bir yere tıklayınca popup'ları kapatalım
            const allPopups = document.querySelectorAll(".filter-popup");
            allPopups.forEach(p => p.style.display = "none");
        });

        function columnFilter(event, colIndex) {
            const searchVal = event.target.value.toLowerCase();
            const table = document.getElementById("salesReportTable");
            if (!table) return;
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(r => {
                const text = (r.cells[colIndex]?.innerText || "").toLowerCase();
                r.style.display = text.includes(searchVal) ? "" : "none";
            });
        }
        function clearColumnFilter(colIndex) {
            const table = document.getElementById("salesReportTable");
            if (!table) return;
            // İlgili popup içindeki input'u sıfırla
            const popup = table.querySelectorAll("thead tr.header-row th")[colIndex].querySelector(".filter-popup input");
            if (popup) {
                popup.value = "";
            }
            // Tüm satırları geri aç
            const rows = table.querySelectorAll("tbody tr");
            rows.forEach(r => r.style.display = "");
        }

        async function exportExcelAndShareWhatsApp() {
            const checks = document.querySelectorAll(".saleCheck:checked");
            if (!checks.length) return alert("Hiç satır seçmediniz!");

            let tourSet = new Set();
            let dateSet = new Set();

            checks.forEach(chk => {
                const saleId = chk.dataset.id;
                const sale = salesHistory.find(s => s.id === saleId);
                if (sale) {
                    tourSet.add(sale.tourName || "-");
                    dateSet.add(sale.tourDate || "-");
                }
            });

            const tourNames = [...tourSet].join(", ");
            const tourDates = [...dateSet].map(d => {
                const dt = new Date(d);
                return `${String(dt.getDate()).padStart(2, "0")}.${String(dt.getMonth() + 1).padStart(2, "0")}.${dt.getFullYear()}`;
            }).join(", ");
            const fileName = `${tourDates} - ${tourNames}.xls`.replaceAll("/", ".").replaceAll(":", ".");

            let html = `<html><head><meta charset="UTF-8"></head><body><table border="1"><tr><th>No</th><th>Müşteri</th><th>Ülke</th><th>İletişim</th><th>Email</th><th>Adres</th><th>Alternatif</th><th>Katılımcılar</th></tr>`;

            checks.forEach((chk, i) => {
                const saleId = chk.dataset.id;
                const sale = salesHistory.find(s => s.id === saleId);
                const occ = (sale.occupants || []).map(o => `${o.name} (${o.docNo})`).join(", ");
                html += `<tr><td>${i + 1}</td><td>${sale.buyerName}</td><td>${sale.buyerCountry}</td><td>${sale.buyerContact}</td><td>${sale.buyerEmail}</td><td>${sale.address}</td><td>${sale.alternativeTour}</td><td>${occ}</td></tr>`;
            });

            html += `</table><p style="text-align:center">🚌 İyi Turlar Dileriz</p></body></html>`;

            const blob = new Blob([html], { type: "application/vnd.ms-excel" });

            // 📦 1) Dosyayı indir
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);

            // 📲 2) Eğer mobil tarayıcı destekliyorsa paylaştır
            if (navigator.canShare && navigator.canShare({ files: [new File([blob], fileName)] })) {
                const file = new File([blob], fileName, { type: "application/vnd.ms-excel" });
                try {
                    await navigator.share({
                        files: [file],
                        title: 'Tur Listesi',
                        text: '📥 İşte Excel tur listesi. A.İT Belgesi ektedir.'
                    });
                } catch (err) {
                    alert("Paylaşım iptal edildi veya desteklenmiyor.");
                }
            } else {
                alert("🟡 Dosya indirildi. WhatsApp'tan elle paylaşabilirsiniz.\nMobil cihazda tarayıcıdan girersen doğrudan paylaşım yapılır.");
            }
        }





        // Satıcı adına tıklayınca o satıcının yaptığı tüm satışları görmek için fonksiyon
        function showSellerSales(sellerName) {
            const sellerSales = salesHistory.filter(s =>
                s.sellerUsername === sellerName || s.sellerName === sellerName
            );

            if (!sellerSales.length) {
                alert(`${sellerName} için satış bulunamadı.`);
                return;
            }

            let totalAmount = sellerSales.reduce((sum, s) => sum + s.totalPrice, 0);
            let details = `📌 ${sellerName} Satış Detayları:\n\n`;

            sellerSales.forEach(s => {
                details += `
🚌 Tur: ${s.tourName}
📅 Tarih: ${new Date(s.date).toLocaleString()}
💺 Koltuk: ${s.seatsSold}
💰 Tutar: ${s.totalPrice} TL
👨‍💼 Müşteri: ${s.buyerName}
---
`;
            });

            details += `\n📈 Toplam Satış: ${sellerSales.length}\n💰 Toplam Gelir: ${totalAmount} TL`;

            alert(details);
        }

        // Satış detayları fonksiyonu (bütün bilgiler):
        function showSaleDetails(saleId) {
            const sale = salesHistory.find(s => s.id === saleId);
            if (!sale) {
                alert("Satış bulunamadı!");
                return;
            }

            const details = `
📌 Detaylı Satış Bilgisi:

👤 Satıcı: ${sale.sellerName || sale.sellerUsername}
🚌 Tur: ${sale.tourName}
📅 Tur Tarihi: ${sale.tourDate || '-'}
🗓️ Satış Tarihi: ${new Date(sale.date).toLocaleString()}
💺 Koltuk Sayısı: ${sale.seatsSold}
💳 Ödeme Türü: ${sale.paymentType}
💰 Tutar: ${sale.totalPrice} TL

👨‍💼 Müşteri Bilgileri:
• İsim: ${sale.buyerName}
• İletişim: ${sale.buyerContact || '-'}
• Ülke: ${sale.buyerCountry || '-'}
• Konaklama: ${sale.stayType || '-'}

📌 Rezervasyon ID: ${saleId}
  `;

            alert(details);
        }

        function whatsappSale(saleId) {
            let s = salesHistory.find(x => x.id === saleId);
            if (!s) {
                alert("Satış bulunamadı!");
                return;
            }

            let tur = tours.find(t => t.id === s.tourId);

            let msg = `
📌 *Yeni Tur Satışı Detayları*

👤 *Satıcı:* ${s.sellerName || s.sellerUsername || "-"}
👨‍💼 *Müşteri Adı:* ${s.buyerName || "-"}
📞 *İletişim:* ${s.buyerContact || "-"}
🌍 *Ülke:* ${s.buyerCountry || "-"}
📧 *E-mail:* ${s.buyerEmail || "-"}

🚌 *Tur Adı:* ${s.tourName || "-"}
🎟️ *Tur Kodu:* ${s.tourCode || "-"}
📅 *Tur Tarihi:* ${tur ? tur.date : "-"}
⏰ *Başlangıç - Bitiş:* ${tur ? (tur.startTime + " - " + tur.endTime) : "-"}

💺 *Satılan Koltuk:* ${s.seatsSold || "-"}
💳 *Ödeme Tipi:* ${s.paymentType || "-"}
💰 *Toplam Tutar:* ${s.totalPrice || "-"} TL
🗓️ *Satış Tarihi:* ${new Date(s.date).toLocaleString()}

🏠 *Konaklama Tipi:* ${s.stayType || "-"}
📌 *Adres/Oda Bilgisi:* ${s.stayDetails || "-"}

🤝 İyi çalışmalar!
`;

            let url = "https://api.whatsapp.com/send?text=" + encodeURIComponent(msg);
            window.open(url, "_blank");
        }



        // Satıcı istatistiklerini göster
        function showSellerSalesStats(sellerName) {
            let sellerSales = salesHistory.filter(s => s.sellerName === sellerName);
            if (!sellerSales.length) {
                alert(sellerName + " için satış yok.");
                return;
            }

            let totalAmount = sellerSales.reduce((sum, sale) => sum + parseFloat(sale.totalPrice), 0);
            let html = `
    <h3>${sellerName} Satışları</h3>
    <table class="acc-details-table">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Tur</th>
          <th>Koltuk</th>
          <th>Tutar</th>
          <th>Müşteri</th>
          <th>Ödeme</th>
        </tr>
      </thead>
      <tbody>
  `;

            sellerSales.forEach(sale => {
                html += `
      <tr>
        <td>${new Date(sale.date).toLocaleString()}</td>
        <td>${sale.tourName}</td>
        <td>${sale.seatsSold}</td>
        <td>${sale.totalPrice} TL</td>
        <td>${sale.paymentType}</td>
        <td>${sale.buyerName}</td>
      </tr>`;
            });

            html += `
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3"><strong>Toplam Tutar</strong></td>
          <td colspan="2"><strong>${totalAmount.toFixed(2)} TL</strong></td>
        </tr>
      </tfoot>
    </table>`;

            document.getElementById("sellerSalesStats").innerHTML = html;
            document.getElementById("sellerSalesStats").style.display = "block";
        }





        function filterAdminSales() {
            let sellerVal = (document.getElementById("adminFilterSeller").value || "").trim().toLowerCase();
            let nameVal = (document.getElementById("adminFilterName").value || "").trim().toLowerCase();
            let tourVal = (document.getElementById("adminFilterTour").value || "").trim().toLowerCase();
            let startDate = document.getElementById("adminFilterStartDate").value;
            let endDate = document.getElementById("adminFilterEndDate").value;
            let altTourVal = (document.getElementById("adminFilterAltTour")?.value || "").toLowerCase();
            let locationVal = (document.getElementById("adminFilterLocation")?.value || "").toLowerCase();


            let filtered = [...salesHistory];
            if (sellerVal) {
                filtered = filtered.filter(s => s.sellerName && s.sellerName.toLowerCase().includes(sellerVal));
            }
            if (nameVal) {
                filtered = filtered.filter(s =>
                    (s.buyerName && s.buyerName.toLowerCase().includes(nameVal)) ||
                    (s.sellerName && s.sellerName.toLowerCase().includes(nameVal))
                );
            }
            if (tourVal) {
                filtered = filtered.filter(s => s.tourName && s.tourName.toLowerCase().includes(tourVal));
            }
            if (startDate) {
                let sd = new Date(startDate + "T00:00:00").getTime();
                filtered = filtered.filter(s => new Date(s.date).getTime() >= sd);
            }
            if (endDate) {
                let ed = new Date(endDate + "T23:59:59").getTime();
                filtered = filtered.filter(s => new Date(s.date).getTime() <= ed);
            }
            if (altTourVal) {
                filtered = filtered.filter(s => (s.alternativeTour || "").toLowerCase().includes(altTourVal));
            }

            if (locationVal) {
                const t = tours.find(t => t.id === s.tourId);
                if (t && t.location && !t.location.toLowerCase().includes(locationVal)) return false;
            }


            let c = document.getElementById("salesReport");
            if (!filtered.length) {
                c.innerHTML = "<p>Filtre sonucu satış yok.</p>";
                return;
            }

            let html = `
        <table>
          <thead>
            <tr>
              <th>Satıcı</th>
              <th>Tur</th>
              <th>Kod</th>
              <th>Koltuk</th>
              <th>Ödeme</th>
              <th>Tutar</th>
              <th>Tarih</th>
              <th>İsim</th>
              <th>İletişim</th>
              <th>Ülke</th>
              <th>Konaklama</th>
              <th>Detay</th>
              <th>WhatsApp</th>
            </tr>
          </thead>
          <tbody>
      `;
            filtered.forEach(s => {
                html += `
<tr>
  <td>${s.sellerName || "İsim Yok"}</td>
  <td>${s.tourName}</td>
  <td>${s.tourCode || ""}</td>
  <td>${s.seatsSold}</td>
  <td>${s.paymentType}</td>
  <td>${s.totalPrice} TL</td>
  <td>${new Date(s.date).toLocaleString()}</td>
  <td>${s.buyerName}</td>
  <td>${s.buyerContact}</td>
  <td>${s.buyerCountry}</td>
  <td>${s.stayType}</td>
  <td><button onclick='showSaleDetails("${s.id}")'>Detay</button></td>
  <td><button onclick="whatsappSale('${s.id}')">WhatsApp</button></td>


</tr>
`;

            });
            html += "</tbody></table>";
            c.innerHTML = html;
        }
        function toggleSellerDetails(sellerName) {
            const elem = document.getElementById("sellerSalesStats");
            if (elem.style.display === "block") {
                elem.style.display = "none";
            } else {
                showSellerSalesStats(sellerName);
            }
        }
        function showSellerSalesStats(sellerName) {
            let sellerSales = salesHistory.filter(s => s.sellerName === sellerName);
            if (!sellerSales.length) {
                alert(sellerName + " için satış yok.");
                return;
            }
            let totalAmount = 0, totalCount = sellerSales.length;
            let breakdown = {};
            sellerSales.forEach(s => {
                totalAmount += s.totalPrice || 0;
                let tName = s.tourName || "Bilinmiyor";
                breakdown[tName] = (breakdown[tName] || 0) + (s.totalPrice || 0);
            });
            let html = `
        <h3>${sellerName} Satış İstatistikleri</h3>
        <p><strong>Toplam Satış Adedi:</strong> ${totalCount}</p>
        <p><strong>Toplam Satış Tutarı:</strong> ${totalAmount} TL</p>
        <h4>Tur Bazında Dağılım</h4>
        <table>
          <thead><tr><th>Tur</th><th>Tutar</th></tr></thead>
          <tbody>
      `;
            for (let t in breakdown) {
                html += `<tr><td>${t}</td><td>${breakdown[t]} TL</td></tr>`;
            }
            html += "</tbody></table>";
            let elem = document.getElementById("sellerSalesStats");
            elem.innerHTML = html;
            elem.style.display = "block";
        }

        /* ================== 9. Admin: Satıcı Yönetimi (Firestore) ================== */
        function listSellers() {
            let c = document.getElementById("sellerManagementList");
            if (!c) return;
            if (!sellers.length) {
                c.innerHTML = "<p>Hiç satıcı yok.</p>";
                return;
            }
            let html = "<ul>";
            sellers.forEach(s => {
                if (s.role === "seller") {
                    let usern = s.id;
                    let nm = s.name || usern;
                    html += `
            <li>
              <strong>@${usern}</strong> / ${nm}
              <button onclick="deleteSellerDB('${usern}')"
                style="float:right;background:#f44336;margin-left:8px;">Sil</button>
            </li>
          `;
                }
            });
            html += "</ul>";
            c.innerHTML = html;
        }

        /* ================== 10. Satıcı Profil Güncelleme ================== */
        function sellerUpdateProfile() {
            if (!currentUser || currentUser.role !== "seller") {
                alert("Sadece satıcı!");
                return;
            }
            let nn = document.getElementById("sellerNewName").value.trim();
            let np = document.getElementById("sellerNewPass").value.trim();
            if (!nn && !np) return;

            currentUser.name = nn || currentUser.name;
            currentUser.password = np || currentUser.password;
            document.getElementById("sellerName").textContent = currentUser.name;

            sellersCollection.doc(currentUser.username).update({
                name: currentUser.name,
                password: currentUser.password
            }).then(() => {
                alert("Satıcı güncellendi => " + currentUser.username);
            }).catch(err => {
                console.error("Satıcı güncelleme hatası:", err);
                alert("Güncelleme hatası => " + err);
            });
        }

        /* ================== 11. Satıcı: Tur Listeleme (Tüm Turlar) ================== */
        function renderSellerTours() {
            let c = document.getElementById("sellerTourList");
            c.innerHTML = "";
            let arr = [...tours];

            // Aktif turlar isterseniz:
            // let now = Date.now();
            // arr = arr.filter(t => new Date(t.date).getTime() >= now);

            let nameF = (document.getElementById("sellerTourFilterName").value || "").trim().toLowerCase();
            let codeF = (document.getElementById("sellerTourFilterCode").value || "").trim();
            let startF = document.getElementById("sellerTourFilterStart").value;
            let endF = document.getElementById("sellerTourFilterEnd").value;
            let locF = (document.getElementById("sellerTourFilterLocation")?.value || "").trim().toLowerCase();
            // Yeni filtre alanları:
            let priceMin = parseFloat(document.getElementById("adminFilterPriceMin")?.value || "0");
            let priceMax = parseFloat(document.getElementById("adminFilterPriceMax")?.value || "9999999");
            let minSeats = parseInt(document.getElementById("adminFilterSeats")?.value || "0");
            let onlyAvailable = document.getElementById("adminFilterOnlyAvailable")?.checked;


            if (nameF) arr = arr.filter(t => t.name.toLowerCase().includes(nameF));
            if (codeF) arr = arr.filter(t => t.code === codeF);
            if (startF) {
                let s = new Date(startF).getTime();
                arr = arr.filter(t => new Date(t.date).getTime() >= s);
            }
            if (endF) {
                let e = new Date(endF).getTime();
                arr = arr.filter(t => new Date(t.date).getTime() <= e);
            }
            if (locF) arr = arr.filter(t => (t.location || "").toLowerCase().includes(locF));

            if (!arr.length) {
                c.innerHTML = "<p>Tur yok (filtreye takılmış olabilir).</p>";
                return;
            }
            arr = arr.filter(t => t.price >= priceMin && t.price <= priceMax);
            arr = arr.filter(t => t.seats >= minSeats);
            if (onlyAvailable) {
                arr = arr.filter(t => (t.seats - (t.soldSeats || 0)) > 0);
            }
            arr.forEach(t => {
                let dv = document.createElement("div");
                dv.classList.add("tour-item");
                dv.setAttribute("data-tour-id", t.id); // ✅ scroll için gerekli

                if (t.code === "1") dv.classList.add("code-1");
                else if (t.code === "2") dv.classList.add("code-2");
                else if (t.code === "3") dv.classList.add("code-3");

                let totalSeats = t.seats || 0;
                let soldSeats = t.soldSeats || 0;

                dv.innerHTML = `
          <h3>${t.name}</h3>
          <p><strong>Kod:</strong> ${t.code} | <strong>TourCode:</strong> ${t.tourCode}</p>
          <p><strong>Tarih:</strong> ${t.date} ${t.startTime}-${t.endTime}</p>
          <p><strong>Fiyat:</strong> ${t.price} TL</p>
        <p><strong>Koltuk:</strong> Toplam: ${totalSeats}, Satılan: ${soldSeats}, Boş: ${totalSeats - soldSeats}</p>
          <p><strong>Duraklar:</strong> ${t.stops.join(", ")}</p>
          <p><strong>Konum:</strong> ${t.location}, <strong>Rehber:</strong> ${t.guide}</p>
          <p>${t.description}</p>

          ${t.code === "3" ? `
        <div class="package-details">
          <h4>Paket Tur Detayları</h4>
          <p><strong>📅 Program:</strong> ${t.dayPlans}</p>
          <p><strong>🏨 Konaklama:</strong> ${t.stayPlan}</p>
          <p><strong>💰 Paket Fiyat:</strong> ${t.packagePrice} ${t.currency}</p>
        </div>
      ` : ""}

          <div class="alternative-tour" id="alternative_${t.id}">
          <span>🔁 Alternatif Tur: <strong>${t.alternativeTour || "Yok"}</strong></span>
          </div>


          <div class="tour-images" id="seller_img_${t.id}"></div>
          ${t.video ?
                        `<div class="tour-video">
             <iframe src="${t.video}"
             allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture; web-share"
             allowfullscreen></iframe>


           </div>`
                        : ""}



          <button style="background:#9c27b0;color:#fff;" onclick="shareTour('${t.id}')">Paylaş</button>
          <button style="background:#009688;color:#fff;" onclick="whatsappTour('${t.id}')">WhatsApp</button>
          <button style="background:#4CAF50;color:#fff;" onclick="showReservation('${t.id}')">Turu Sat</button>
          <button style='background:#795548;color:#fff;' onclick='openSoldSeatsModal("${t.id}")'>Satılmış Koltuklar</button>
           <div class="geriSayim" data-tarih="${t.date}T${t.startTime}"></div>

          <div id="reservation_${t.id}" class="reservation-info">
            <h4>Rezervasyon Formu</h4>
            <label>Ad Soyad (Ana Alıcı):</label>
            <input type="text" id="buyerName_${t.id}" />
            <label>Belge Tipi:</label>
            <select id="buyerDocType_${t.id}">
              <option value="TC">TC</option>
              <option value="Passport">Pasaport</option>
            </select>
            <label>Belge No:</label>
            <input type="text" id="buyerDocNo_${t.id}" />
            <label>İletişim:</label>
            <input type="text" id="buyerContact_${t.id}" />
            <label>Ülke:</label>
            <input type="text" id="buyerCountry_${t.id}" />
            <!-- Yeni eklenen alan -->
            <label>Alternatif Tur:</label>
            <input type="text" id="alternativeTour_${t.id}" placeholder="Alternatif tur adı giriniz..." />
           <!-- 📍 Adres Tipi -->
<label>Adres Tipi:</label>
<select id="addressType_${t.id}" onchange="toggleAddressFields('${t.id}')">
  <option value="Ev">Ev</option>
  <option value="Otel">Otel</option>
  <option value="Ofis">Ofis</option>
  <option value="Diğer">Diğer</option>
</select>

<!-- 🎯 Adres Alanları -->
<div id="addressFields_${t.id}" class="address-fields" style="margin-top:10px;"></div>

            <label>Kaç koltuk?</label>
           <input type="number" min="1" max="${totalSeats - soldSeats}" id="seatCount_${t.id}" value="1" oninput="updateTotalPrice('${t.id}', ${t.price})" />
            <label>Ödeme Tipi:</label>
            <div class="payment-section">
           <h4>💳 Ödeme Bilgileri</h4>
          <div class="total-confirm">
           <p>💰 <strong>Toplam Tutar:</strong> <span id="totalPrice_${t.id}" data-unitprice="${t.price}">${t.price.toFixed(2)} TL</span>
</p>
           <button onclick="confirmTotalPrice('${t.id}')">✅ Tutarı Onayla</button>
          </div>

          <div id="paymentOptions_${t.id}" class="payment-options" style="display:none;">
           <label>📌 Ödeme Tipi:</label>
         <select id="payment_${t.id}" onchange="togglePaymentExtra('${t.id}')">
          <option value="">-- Seçin --</option>
           <option value="Araçta Ödeme">🚌 Araçta Ödeme (Satıcı Öder)</option>
           <option value="Banka Havalesi">🏦 Banka Havalesi</option>
           <option value="Kredi Kartı">💳 Kredi Kartı</option>
         </select>
         <div id="paymentExtra_${t.id}" class="payment-extra"></div>
        </div>
       </div>

 <!-- KVKK ve Mesafeli Satış Sözleşmesi Butonları -->
<div style="margin-top: 10px;">
  <button onclick="toggleKvkk('${t.id}')" style="background:#2196f3; color:white; padding:6px 10px; border:none; border-radius:6px;">📄 KVKK Sözleşmesi</button>
  <button onclick="toggleContract('${t.id}')" style="background:#03a9f4; color:white; padding:6px 10px; border:none; border-radius:6px;">📄 Mesafeli Satış Sözleşmesi</button>
</div>

<!-- KVKK Metni (BAŞLANGIÇTA GİZLİ) -->
<div id="kvkkBox_${t.id}" style="display:none; margin-top:8px; padding:10px; border:1px solid #ccc; border-radius:8px;">
  <h4>✨🔒 KVKK Aydınlatma Metni</h4>
  <ul style="font-size:14px; line-height:1.6;">
    <li><strong>1. Amaç ve Kapsam:</strong> Bu aydınlatma metni 6698 sayılı KVKK kapsamındadır.</li>
    <li><strong>2. Veri Sorumlusu:</strong> Cebeci Travel, Kurankursu Caddesi Toklu Mahallesi No:1, Trabzon / Ortahisar adresindedir.</li>
    <li><strong>3. İşlenen Kişisel Veriler:</strong> Ad soyad, iletişim bilgileri, ödeme bilgileri, seyahat geçmişi vb...</li>
    <li><strong>4. Hukuki Sebepler:</strong> Online formlar, çağrı merkezi, e-posta vs.</li>
    <li><strong>5. Amaçlar:</strong> Rezervasyon, ödeme, müşteri desteği, kampanya bilgilendirmeleri…</li>
    <li><strong>6. Haklarınız:</strong> KVKK’nın 11. maddesi uyarınca bilgi talep edebilirsiniz…</li>
  </ul>
</div>

<!-- MESAFELİ SATIŞ Metni (BAŞLANGIÇTA GİZLİ) -->
<div id="contractBox_${t.id}" style="display:none; margin-top:8px; padding:10px; border:1px solid #ccc; border-radius:8px;">
  <h4>📝 Mesafeli Satış Sözleşmesi</h4>
  <p>Bu sözleşme, <strong>CEBECİLER OTOMOTİV İNŞ. NAK. TURZ. ve TİC. LTD. ŞTİ.</strong> ile tur satın alan “Alıcı” arasında elektronik ortamda düzenlenmiştir.</p>
  <ul style="font-size:14px; line-height:1.6;">
    <li><strong>1. Satıcı Bilgileri:</strong> Kurankursu Cd. No:1, Trabzon. Tel: 0462 888 20 20</li>
    <li><strong>2. Konu:</strong> Günübirlik, konaklamalı veya özel tur satışları…</li>
    <li><strong>3. Cayma Hakkı:</strong> 48 saat kala iptal hakkı vardır. Aksi halde ücret iadesi yapılmaz.</li>
    <li><strong>4. Yetkili Mahkeme:</strong> Trabzon Tüketici Hakem Heyetleri yetkilidir.</li>
  </ul>
</div>

<!-- KVKK ve Mesafeli Satış Onay Kutuları -->
<div style="margin-top: 12px; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
  <label>
    <input type="checkbox" id="kvkkcheckbox_${t.id}">
    KVKK metnini okudum ve kabul ediyorum.
  </label>
  <br>
  <label>
    <input type="checkbox" id="mesafelicheckbox_${t.id}">
    Mesafeli Satış Sözleşmesini kabul ediyorum.
  </label>
</div>

<!-- Satın Al Butonu -->
<button class="finalize-btn" onclick="confirmFinalSale('${t.id}')">
  Satın Al
</button>
            <div class="occupant-list" id="occList_${t.id}">
              <h5>Ek Kişiler</h5>
              <button type="button" onclick="addOccupant('${t.id}')" style="background:#00acc1;">Kişi Ekle</button>

        `;
                c.appendChild(dv);
                if (t.code === "5") {
                    const stayType = dv.querySelector(`#stayType_${t.id}`);
                    const stayDetails = dv.querySelector(`#stayDetails_${t.id}`);
                    if (stayType) stayType.style.display = "none";
                    if (stayDetails) stayDetails.style.display = "none";
                }


                // Resimler
                let imgDiv = dv.querySelector(`#seller_img_${t.id}`);
                if (t.images && t.images.length) {
                    t.images.forEach(src => {
                        let im = document.createElement("img");
                        im.src = src;
                        im.onclick = () => openImageModal(src);
                        imgDiv.appendChild(im);
                    });
                }
            });



        }
        function showReservation(tid) {
            const tur = tours.find(t => t.id === tid);
            if (!tur) {
                alert("Tur bulunamadı!");
                return;
            }

            const now = new Date();
            const tourDateTime = new Date(`${tur.date}T${tur.startTime}`);

            if (tourDateTime <= now) {
                const uygunTurlar = tours.filter(t => {
                    const tTime = new Date(`${t.date}T${t.startTime}`);
                    return (
                        t.id !== tid &&
                        t.location.toLowerCase() === tur.location.toLowerCase() &&
                        t.date === tur.date &&
                        tTime > now
                    );
                });

                if (uygunTurlar.length > 0) {
                    let container = document.createElement("div");
                    container.style.padding = "16px";
                    container.style.background = "#fff";
                    container.style.border = "2px solid #f44336";
                    container.style.borderRadius = "12px";
                    container.style.margin = "20px";
                    container.style.maxWidth = "90%";
                    container.style.position = "fixed";
                    container.style.top = "100px";
                    container.style.left = "50%";
                    container.style.transform = "translateX(-50%)";
                    container.style.zIndex = "5000";
                    container.innerHTML = `<h4>⛔ Bu turun süresi geçti.</h4><p>📍 Aynı şehirde başka aktif turlar:</p>`;

                    uygunTurlar.forEach(t => {
                        let btn = document.createElement("button");
                        btn.textContent = `Git → ${t.name} (${t.startTime})`;
                        btn.style.margin = "6px";
                        btn.style.padding = "6px 10px";
                        btn.style.border = "none";
                        btn.style.background = "#03a9f4";
                        btn.style.color = "#fff";
                        btn.style.borderRadius = "6px";
                        btn.style.cursor = "pointer";
                        btn.onclick = () => {
                            container.remove(); // mesaj kapanır
                            const kart = document.querySelector(`[data-tour-id="${t.id}"]`);
                            if (kart) kart.scrollIntoView({ behavior: "smooth", block: "center" });
                        };
                        container.appendChild(btn);
                    });

                    // Kapatma butonu
                    let kapat = document.createElement("button");
                    kapat.textContent = "❌ Kapat";
                    kapat.style.marginTop = "10px";
                    kapat.style.padding = "6px 10px";
                    kapat.style.background = "#f44336";
                    kapat.style.color = "#fff";
                    kapat.style.border = "none";
                    kapat.style.borderRadius = "6px";
                    kapat.onclick = () => container.remove();
                    container.appendChild(kapat);

                    document.body.appendChild(container);
                } else {
                    alert(`⛔ Bu turun süresi geçti ve aynı şehirde aktif başka tur bulunamadı.`);
                }

                return;
            }

            // ⏳ Tur aktifse rezervasyon formunu aç
            const f = document.getElementById("reservation_" + tid);
            if (!f) return;
            f.classList.toggle("active");
        }




        function addOccupant(tid) {
            let c = document.getElementById(`occList_${tid}`);
            if (!c) return;
            let idx = c.querySelectorAll(".occRow").length;
            let div = document.createElement("div");
            div.classList.add("occRow");
            div.style.marginTop = "10px";
            div.style.border = "1px solid #ccc";
            div.style.padding = "8px";
            div.style.borderRadius = "6px";
            div.innerHTML = `
        <h6>Kişi ${idx + 1} <button type="button" style="float:right;background:#f44336;" onclick="this.parentNode.parentNode.remove()">X</button></h6>
        <label>İsim:</label>
        <input type="text" id="occName_${tid}_${idx}" />
        <label>Belge Tipi:</label>
        <select id="occDocType_${tid}_${idx}">
          <option value="TC">TC</option>
          <option value="Passport">Pasaport</option>
        </select>
        <label>Belge No:</label>
        <input type="text" id="occDocNo_${tid}_${idx}" />
        <label>Ülke:</label>
        <input type="text" id="occCountry_${tid}_${idx}" />
      `;
            c.appendChild(div);
        }

        async function finalizeSale(tid) {
            try {
                // 1. Güncel tur verisini al
                const tourDoc = await db.collection("tours").doc(tid).get();
                if (!tourDoc.exists) return alert("❌ Tur bulunamadı!");

                const tour = tourDoc.data();
                const totalSeats = parseInt(tour.seats || 0);
                const soldSeats = parseInt(tour.soldSeats || 0);
                const remainingSeats = totalSeats - soldSeats;

                // 2. Form verileri
                const buyerName = document.getElementById(`buyerName_${tid}`)?.value.trim();
                const contact = document.getElementById(`buyerContact_${tid}`)?.value.trim();
                const buyerCountry = document.getElementById(`buyerCountry_${tid}`)?.value.trim();
                const alternativeTour = document.getElementById(`alternativeTour_${tid}`)?.value.trim();
                const seatCount = parseInt(document.getElementById(`seatCount_${tid}`)?.value || "1");
                const docType = document.getElementById(`buyerDocType_${tid}`)?.value;
                const docNo = document.getElementById(`buyerDocNo_${tid}`)?.value.trim();
                const paymentType = document.getElementById(`payment_${tid}`)?.value;
                const address = getFormattedAddress(tid); // ✅ adres direkt burada

                const pricePerSeat = parseFloat(tour.price || 0);
                const totalPrice = pricePerSeat * seatCount;

                // 3. Katılımcılar
                const occupants = [];
                document.querySelectorAll(`#occList_${tid} .occRow`).forEach((row, i) => {
                    occupants.push({
                        name: document.getElementById(`occName_${tid}_${i}`)?.value.trim() || "-",
                        docType: document.getElementById(`occDocType_${tid}_${i}`)?.value || "-",
                        docNo: document.getElementById(`occDocNo_${tid}_${i}`)?.value.trim() || "-",
                        country: document.getElementById(`occCountry_${tid}_${i}`)?.value.trim() || "-"
                    });
                });

                const totalPeople = occupants.length + 1;

                // 4. Kontroller
                if (!buyerName || !contact || !buyerCountry || !paymentType) {
                    return alert("❗ Lütfen zorunlu alanları doldurun!");
                }

                if (seatCount < totalPeople) {
                    return alert(`❗ ${totalPeople} kişi girdiniz ama sadece ${seatCount} koltuk yazdınız.`);
                }

                const freshDoc = await db.collection("tours").doc(tid).get();
                const fresh = freshDoc.data();
                const freshRemainingSeats = parseInt(fresh.seats) - parseInt(fresh.soldSeats || 0);

                if (seatCount > freshRemainingSeats) {
                    return alert(`⛔ Bu turda sadece ${freshRemainingSeats} koltuk kaldı.`);
                }

                // 5. KVKK ve Mesafeli Onay Kutuları
                const kvkk = document.getElementById(`kvkkcheckbox_${tid}`);
                const contract = document.getElementById(`mesafelicheckbox_${tid}`);
                if (!kvkk?.checked || !contract?.checked) {
                    return alert("📌 Lütfen KVKK ve Mesafeli Satış kutularını işaretleyin.");
                }

                // 6. Satış nesnesi
                const paymentStatus = paymentType === "Araçta Ödeme" ? "-" : "pending";
                const sale = {
                    tourId: tid,
                    tourName: tour.name,
                    tourDate: tour.date,
                    startTime: tour.startTime,
                    endTime: tour.endTime,
                    tourCode: tour.tourCode,
                    sellerName: currentUser?.name || "-",
                    sellerUsername: currentUser?.username || "-",
                    buyerName,
                    buyerContact: contact,
                    buyerCountry,
                    buyerEmail: "-",
                    docType,
                    docNo,
                    address, // ✅ sadece bu var
                    alternativeTour,
                    paymentType,
                    seatsSold: seatCount,
                    totalPrice,
                    occupants,
                    date: new Date().toISOString(),
                    paymentStatus
                };

                // 7. Firestore'a kaydet
                const createdSalesHistory = await db.collection("salesHistory").add(sale);

                if (paymentStatus !== "pending") {
                    await db.collection("tours").doc(tid).update({
                        soldSeats: firebase.firestore.FieldValue.increment(seatCount)
                    });

                    showSaleSuccessModal(); // ✅ Teşekkür modalı
                    renderSellerTours();
                } else {
                    const formData = new FormData();
                    formData.append('oid', createdSalesHistory.id);
                    formData.append('amount', totalPrice);

                    const response = await fetch(`https://dailytur-backend.onrender.com`, {
                        method: 'POST',
                        body: formData
                    });

                    console.log("Ödeme sayfasına yönlendirme yanıtı:", response);

                    if (response.ok) {
                        const paymentPageHtml = await response.text();
                        const newWindow = window.open();
                        newWindow.document.open();
                        newWindow.document.write(paymentPageHtml); // HTML içeriğini yeni pencerede render et
                        newWindow.document.close();
                    } else {
                        alert(`❌ Ödeme sayfasına yönlendirme başarısız: ${error.message}`);
                    }
                }


            } catch (err) {
                console.error("🔥 finalizeSale hatası:", err);
                alert("❌ Satış yapılamadı: " + err.message);
            }
        }

        function showSaleSuccessModal() {
            const modal = document.createElement("div");
            modal.style = `
    position: fixed; top: 30%; left: 50%; transform: translateX(-50%);
    background: white; border-radius: 12px; padding: 30px; z-index: 9999;
    box-shadow: 0 6px 20px rgba(0,0,0,0.3); text-align: center;
    font-size: 18px; font-weight: bold; color: green;
  `;
            modal.innerHTML = `✅ Satış başarıyla tamamlandı!<br>📩 Rezervasyon bilgileriniz en kısa sürede iletilecektir.`;
            document.body.appendChild(modal);
            setTimeout(() => modal.remove(), 5000);
        }



        function getFormattedAddress(tid) {
            const type = document.getElementById(`addressType_${tid}`)?.value;

            if (type === "Otel") {
                const otelAd = document.querySelector(`#addressFields_${tid} input[placeholder='Otel adı']`)?.value || "-";
                const otelAdr = document.querySelector(`#addressFields_${tid} input[placeholder='Adres']`)?.value || "-";
                const odaNo = document.querySelector(`#addressFields_${tid} input[placeholder='Oda numarası']`)?.value || "-";
                return `Otel Adı: ${otelAd}, Adres: ${otelAdr}, Oda No: ${odaNo}`;
            }
            if (type === "Ev") {
                const evAd = document.querySelector(`#addressFields_${tid} input`)?.value || "-";
                return `Ev: ${evAd}`;
            }
            if (type === "Ofis") {
                const ofis = document.querySelector(`#addressFields_${tid} input[placeholder='Firma/Ofis adı']`)?.value || "-";
                const ofisAdr = document.querySelector(`#addressFields_${tid} input[placeholder='Ofis adresi']`)?.value || "-";
                return `Ofis: ${ofis}, Adres: ${ofisAdr}`;
            }
            if (type === "Diğer") {
                const diger = document.querySelector(`#addressFields_${tid} input, #addressFields_${tid} textarea`)?.value || "-";
                return `Adres: ${diger}`;
            }

            return "-";
        }


        /* ================== 12. Satıcı: Tur Kaydet, Satıcı İstatistik, Muhasebe ================== */
        async function saveTour(tid) {
            if (!currentUser || currentUser.role !== "seller") {
                alert("Sadece satıcı!");
                return;
            }
            try {
                await toursCollection.doc(tid).update({
                    savedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.username)
                });
                alert("Tur kaydedildi.");
            } catch (e) {
                console.error(e);
                alert("Kaydetme hatası: " + e);
            }
        }
        function renderSellerStats() {
            if (!currentUser || currentUser.role !== "seller") return;
            let c = document.getElementById("sellerStatsContent");
            let count = salesHistory.filter(x => x.sellerName === currentUser.name).length;
            c.textContent = `Toplam ${count} satış yaptınız.`;
        }
        function showSellerAccounting() {
            let box = document.getElementById("sellerAccounting");
            box.style.display = (!box.style.display || box.style.display === "none") ? "block" : "none";
            if (box.style.display === "block") filterSellerAccounting();
        }
        function filterSellerAccounting() {
            const c = document.getElementById("sellerAccountingContent");
            c.innerHTML = "";

            let arr = salesHistory.filter(s => s.sellerName === currentUser.name);

            const tourF = document.getElementById("accFilterTour").value.toLowerCase();
            const startF = document.getElementById("accFilterStart").value;
            const endF = document.getElementById("accFilterEnd").value;
            const payF = document.getElementById("accFilterPayType").value;
            const locF = document.getElementById("accFilterLocation").value.toLowerCase();

            if (tourF) arr = arr.filter(s => s.tourName.toLowerCase().includes(tourF));
            if (startF) {
                let s = new Date(startF + "T00:00:00").getTime();
                arr = arr.filter(sale => new Date(sale.date).getTime() >= s);
            }
            if (endF) {
                let e = new Date(endF + "T23:59:59").getTime();
                arr = arr.filter(sale => new Date(sale.date).getTime() <= e);
            }
            if (payF) arr = arr.filter(s => s.paymentType === payF);
            if (locF) {
                arr = arr.filter(sale => {
                    const tour = tours.find(t => t.id === sale.tourId);
                    return tour && tour.location.toLowerCase().includes(locF);
                });
            }

            // Toplamlar
            const now = Date.now();
            const oneDay = 86400000, oneWeek = 7 * oneDay, oneMonth = 30 * oneDay;
            let ds = 0, dc = 0, ws = 0, wc = 0, ms = 0, mc = 0;
            arr.forEach(sale => {
                const diff = now - new Date(sale.date).getTime();
                const amount = sale.totalPrice || 0;
                if (diff <= oneDay) { ds += amount; dc++; }
                if (diff <= oneWeek) { ws += amount; wc++; }
                if (diff <= oneMonth) { ms += amount; mc++; }
            });

            // Tablo
            let html = `
    <p><strong>📅 1 Günlük Satış:</strong> ${ds} TL (${dc} satış)</p>
    <p><strong>🗓️ 1 Haftalık Satış:</strong> ${ws} TL (${wc} satış)</p>
    <p><strong>📆 1 Aylık Satış:</strong> ${ms} TL (${mc} satış)</p>

    <h4>🧾 Satış Listesi</h4>
    <table class="acc-details-table">
      <thead>
        <tr>
          <th>📅 Tarih</th>
          <th>🚌 Tur</th>
          <th>👤 Müşteri</th>
          <th>💳 Ödeme</th>
          <th>💰 Tutar</th>
        </tr>
      </thead>
      <tbody>
  `;

            let total = 0;
            let commission = 0;

            arr.forEach(s => {
                html += `
      <tr>
        <td>${new Date(s.date).toLocaleString()}</td>
        <td>${s.tourName}</td>
        <td>${s.buyerName}</td>
        <td>${s.paymentType}</td>
        <td>${s.totalPrice} TL</td>
      </tr>
    `;
                total += s.totalPrice;
            });
            commission = total * 0.10;

            html += `
  </tbody>
  <tfoot>
    <tr>
      <td colspan="4"><strong>Toplam (Filtreye göre):</strong></td>
      <td><strong>${total.toFixed(2)} TL</strong></td>
    </tr>
    <tr>
      <td colspan="4"><strong>🧾 Komisyon (%10):</strong></td>
      <td><strong>${commission.toFixed(2)} TL</strong></td>
    </tr>
  </tfoot>
</table>`;

            c.innerHTML = html;
        }

        function toggleSellerSavedTours() {
            let c = document.getElementById("sellerSavedList");
            if (!c.style.display || c.style.display === "none") {
                c.style.display = "block";
                c.innerHTML = "";
                let saved = tours.filter(t => (t.savedBy || []).includes(currentUser.username));
                if (!saved.length) {
                    c.innerHTML = "<p>Kaydedilen tur yok.</p>";
                } else {
                    saved.forEach(t => {
                        let dv = document.createElement("div");
                        dv.classList.add("tour-item");
                        if (t.code === "1") dv.classList.add("code-1");
                        else if (t.code === "2") dv.classList.add("code-2");
                        else if (t.code === "3") dv.classList.add("code-3");
                        dv.innerHTML = `
              <h4>${t.name}</h4>
              <p><strong>Kod:</strong> ${t.code}, <strong>TourCode:</strong> ${t.tourCode}</p>
              <p>${t.date} ${t.startTime}-${t.endTime}</p>
            `;
                        c.appendChild(dv);
                    });
                }
            } else {
                c.style.display = "none";
            }
            // 🔥 Paket Tura özel içerik
            if (t.code === "3") {
                dv.innerHTML += `
        <div style="margin-top:10px; padding:10px; background:#fffde7; border-radius:8px;">
          <p><strong>📅 Program:</strong><br>${t.dayPlans || "-"}</p>
          <p><strong>🏨 Konaklama:</strong><br>${t.stayPlan || "-"}</p>
          <p><strong>💰 Fiyat:</strong> ${t.packagePrice || "?"} ${t.currency || "TL"}</p>
        </div>
      `;
            }
        }

        /* ================== 13. Modaller: Satılmış Koltuklar, Görsel Büyütme ================== */
        function openSoldSeatsModal(tid) {
            let tur = tours.find(x => x.id === tid);
            if (!tur) {
                alert("Tur yok!");
                return;
            }


            let arr = salesHistory.filter(s => s.tourId === tid);
            let html = `
    <p><strong>Tur:</strong> ${tur.name}</p>
    <p><strong>Koltuk:</strong> Toplam: ${tur.seats}, Satılmış: ${tur.soldSeats}</p>
  `;

            if (!arr.length) {
                html += "<p>Henüz satış yok!</p>";
            } else {
                arr.forEach((sale, idx) => {
                    let buyerFirstName = (sale.buyerName || "").split(" ")[0];
                    html += `<div style="border:1px solid #ccc; padding:6px; margin:6px 0; border-radius:4px;">
        <p><strong>Satış #${idx + 1}:</strong> ${buyerFirstName} ****** (${sale.buyerCountry}) - ${sale.seatsSold} koltuk</p>
      `;

                    if (sale.occupants && sale.occupants.length) {
                        html += "<ul>";
                        sale.occupants.forEach((o, i) => {
                            let ad = (o.name || "").split(" ")[0];
                            html += `<li>#${i + 1}: ${ad} ****** / ${o.country} / ${o.docType}</li>`;
                        });
                        html += "</ul>";
                    }

                    html += "</div>";
                });
            }

            document.getElementById("soldSeatsList").innerHTML = html;
            document.getElementById("modalOverlay").style.display = "block";
            document.getElementById("soldSeatsModal").style.display = "block";
        }

        function closeSoldSeatsModal() {
            document.getElementById("modalOverlay").style.display = "none";
            document.getElementById("soldSeatsModal").style.display = "none";
        }
        function openImageModal(src) {
            let overlay = document.getElementById("imageModalOverlay");
            let img = document.getElementById("imageModalImg");
            img.src = src;
            overlay.style.display = "flex";
        }
        function closeImageModal() {
            document.getElementById("imageModalOverlay").style.display = "none";
        }

        /* ================== 14. DELETE, EDIT, SHARE, WHATSAPP, ETC. ================== */
        async function deleteTour(tid) {
            if (!confirm("Bu tur silinsin mi?")) return;
            try {
                await toursCollection.doc(tid).delete();
                alert("Tur silindi.");
            } catch (e) {
                console.error(e);
                alert("Tur silinemedi: " + e);
            }
        }
        function editTour(tid) {
            alert("Tur düzenleme fonksiyonu (demo). Firestore doc.update() ile uyarlayabilirsiniz. ID:" + tid);
        }
        function shareTour(tid) {
            let tur = tours.find(x => x.id === tid);
            if (!tur) { alert("Tur yok!"); return; }
            if (navigator.share) {
                navigator.share({
                    title: "Tur Paylaşımı",
                    text: `${tur.name} turu, ${tur.price} TL.`,
                    url: location.href
                }).catch(e => console.log("Paylaşım iptal:", e));
            } else {
                alert("Paylaş => " + tur.name);
            }
        }
        function whatsappTour(tourId) {
            const tur = tours.find(t => t.id === tourId);
            if (!tur) {
                alert("Tur bulunamadı!");
                return;
            }

            let msg = `
✨ *Harika bir tur sizi bekliyor!* ✨

🚌 *${tur.name}* turuna katılmak ister misiniz?

📅 *Tarih:* ${tur.date}
⏰ *Saat:* ${tur.startTime} - ${tur.endTime}
📍 *Konum:* ${tur.location || "-"}

📍 *Duraklar:* ${tur.stops.join(", ")}

💰 *Fiyat:* ${tur.price} TL
👨‍✈️ *Rehber:* ${tur.guide}

📝 Hemen yerinizi ayırtmak için aşağıdaki mini formu doldurabilirsiniz:
👉 https://seninwebsiten.com/mini-form?tourId=${tur.id}

🤝 Rezervasyonunuz sonrası sizinle iletişime geçeceğiz.

İyi eğlenceler! 🌟
`;

            let url = "https://api.whatsapp.com/send?text=" + encodeURIComponent(msg);
            window.open(url, "_blank");
        }



        function showSaleDetails(saleId) {
            let s = salesHistory.find(x => x.id === saleId);
            if (!s) { alert("Kayıt yok!"); return; }
            alert(JSON.stringify(s, null, 2));
        }

        /* ================== 15. Konaklama & Ödeme Extra ================== */
        function toggleStayDetails(tid) {
            const type = document.getElementById(`stayType_${tid}`).value;
            const box = document.getElementById(`stayDetails_${tid}`);
            if (!box) return;

            let html = "";

            if (type === "Ev") {
                html = `
      <label>Ev Adresi:</label>
      <input type="text" placeholder="Ev adresini yazın" />
    `;
            } else if (type === "Otel") {
                html = `
      <label>Otel Adı:</label>
      <input type="text" placeholder="Otel adı">
      <label>Otel Adresi:</label>
      <input type="text" placeholder="Adres">
      <label>Oda No:</label>
      <input type="text" placeholder="101">
    `;
            } else if (type === "Ofis") {
                html = `
      <label>Ofis Adı:</label>
      <input type="text" placeholder="Ofis ismi">
      <label>Adres:</label>
      <input type="text" placeholder="Ofis adresi">
    `;
            } else if (type === "Diğer") {
                html = `
      <label>Açık Adres:</label>
      <textarea rows="3" placeholder="Açık adresi girin..."></textarea>
    `;
            }
            function getLocation(tid) {
                if (!navigator.geolocation) {
                    alert("Tarayıcı konum özelliğini desteklemiyor.");
                    return;
                }

                navigator.geolocation.getCurrentPosition(pos => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    const link = `https://www.google.com/maps?q=${lat},${lon}`;
                    document.getElementById(`locationInput_${tid}`).value = link;
                }, () => {
                    alert("Konum alınamadı, izin verilmedi.");
                });
            }
            if (t.code === "5") {
                dv.innerHTML += `<p style="color:gray;">🌐 Yurtdışı turlarda adres bilgisi alınmaz.</p>`;
            } else {
                // stayType ve stayDetails div’lerini ekle
            }


            box.innerHTML = html;
        }

        function togglePaymentExtra(tid) {
            const method = document.getElementById(`payment_${tid}`).value;
            const container = document.getElementById(`paymentExtra_${tid}`);
            if (!container) return;

            container.innerHTML = ""; // önce temizle

            if (method === "Kredi Kartı") {
                container.innerHTML = `
      <div style="margin-top: 10px;">
        <label>💳 Kart Numarası:</label>
        <input type="text" placeholder="XXXX XXXX XXXX XXXX" />
        <label>📆 Son Kullanma:</label>
        <input type="text" placeholder="MM/YY" />
  </div>
    `;


            } else if (method === "Banka Havalesi") {
                container.innerHTML = `
      <label>🏦 IBAN:</label>
      <input type="text" placeholder="TR820006200015800006291815"/>
       <label>Şirket Adına :</label>
      <input type="text" placeholder="Cebeciler Otomotıv İnşaat nak. tur. tic ltd şti. olarak yazın " />
      <label>👤 Gönderen Ad:</label>
      <input type="text" placeholder="Ad Soyad" />
    `;
            } else if (method === "Araçta Ödeme") {
                container.innerHTML = `<p style="color:green;">🚌 Araçta ödeme seçildi. Satıcıya bilgi verilecektir.</p>`;
            }
        }



        /* ================== 16. Dil Seçici (tr, en, ar, ka) ================== */
        const translations = {
            tr: {
                header_title: "Gelişmiş Tur Satış Sistemi",
                header_subtitle: "Admin: admin/12345 - Satıcı: satici1/12345",
                login_title: "Giriş Yap",
                login_user: "Kullanıcı Adı",
                login_pass: "Şifre",
                login_button: "Giriş",
                login_info: "Örnek: admin/12345 veya satici1/12345",
                admin_goSeller: "Satıcı Ekranına Geç",
                admin_panel_title: "Admin Paneli",
                admin_panel_subtitle: "Merhaba <span id='adminName'></span>. Burada turları ekleyip, satış raporuna bakabilirsiniz.",
                admin_changePass: "Admin Şifre Değiştir",
                admin_newPass: "Yeni Şifre:",
                admin_passBtn: "Değiştir",
                admin_newTour: "Tur Ekle",
                admin_tourName: "Tur Adı:",
                admin_tourDesc: "Açıklama:",
                admin_tourDate: "Tarih (Gün):",
                admin_tourStart: "Başlangıç Saati:",
                admin_tourEnd: "Bitiş Saati:",
                admin_tourPrice: "Fiyat (TL):",
                admin_tourStops: "Duraklar (virgülle):",
                admin_tourLoc: "Konum Bilgisi:",
                admin_tourGuide: "Rehber Bilgisi:",
                admin_tourSeats: "Toplam Koltuk:",
                admin_tourCode: "Tur Kod (1=Günübirlik,2=VIP,3=Paket):",
                admin_tourImages: "Tur Görselleri (max 10):",
                admin_tourBtn: "Turu Ekle",
                admin_savedToursBtn: "Kayıtlı Turlar",
                admin_salesReport: "Satış Raporu",
                admin_logout: "Çıkış",
                seller_panel: "Satıcı Paneli",
                seller_panel_sub: "Merhaba <span id='sellerName'></span>. Tüm turları görüp, satış yapabilirsiniz.",
                seller_stats: "Satıcı İstatistikleri",
                seller_logout: "Çıkış",
                seller_activeTours: "Tüm Turlar"
            },
            en: {
                header_title: "Advanced Tour Sales System",
                header_subtitle: "Admin: admin/12345 - Seller: satici1/12345",
                login_title: "Login",
                login_user: "Username",
                login_pass: "Password",
                login_button: "Login",
                login_info: "Example: admin/12345 or satici1/12345",
                admin_goSeller: "Go to Seller Screen",
                admin_panel_title: "Admin Panel",
                admin_panel_subtitle: "Hello <span id='adminName'></span>. You can add tours and view the sales report.",
                admin_changePass: "Change Admin Password",
                admin_newPass: "New Password:",
                admin_passBtn: "Change",
                admin_newTour: "Add Tour",
                admin_tourName: "Tour Name:",
                admin_tourDesc: "Description:",
                admin_tourDate: "Date (Day):",
                admin_tourStart: "Start Time:",
                admin_tourEnd: "End Time:",
                admin_tourPrice: "Price (TL):",
                admin_tourStops: "Stops (comma):",
                admin_tourLoc: "Location Info:",
                admin_tourGuide: "Guide Info:",
                admin_tourSeats: "Total Seats:",
                admin_tourCode: "Tour Code (1=Daily,2=VIP,3=Package):",
                admin_tourImages: "Tour Images (max 10):",
                admin_tourBtn: "Add Tour",
                admin_savedToursBtn: "Saved Tours",
                admin_salesReport: "Sales Report",
                admin_logout: "Logout",
                seller_panel: "Seller Panel",
                seller_panel_sub: "Hello <span id='sellerName'></span>. You can view all tours and make sales.",
                seller_stats: "Seller Stats",
                seller_logout: "Logout",
                seller_activeTours: "All Tours"
            },
            ar: {
                header_title: "نظام بيع الرحلات المتقدم",
                header_subtitle: "المسؤول: admin/12345 - البائع: satici1/12345",
                login_title: "تسجيل الدخول",
                login_user: "اسم المستخدم",
                login_pass: "كلمة المرور",
                login_button: "دخول",
                login_info: "مثال: admin/12345 أو satici1/12345",
                admin_goSeller: "الانتقال إلى شاشة البائع",
                admin_panel_title: "لوحة المسؤول",
                admin_panel_subtitle: "مرحبًا <span id='adminName'></span>. يمكنك إضافة الجولات وعرض تقرير المبيعات.",
                admin_changePass: "تغيير كلمة مرور المسؤول",
                admin_newPass: "كلمة المرور الجديدة:",
                admin_passBtn: "تغيير",
                admin_newTour: "إضافة جولة",
                admin_tourName: "اسم الجولة:",
                admin_tourDesc: "الوصف:",
                admin_tourDate: "التاريخ (اليوم):",
                admin_tourStart: "وقت البدء:",
                admin_tourEnd: "وقت الانتهاء:",
                admin_tourPrice: "السعر (TL):",
                admin_tourStops: "المحطات (بالفاصلة):",
                admin_tourLoc: "معلومات الموقع:",
                admin_tourGuide: "معلومات المرشد:",
                admin_tourSeats: "عدد المقاعد:",
                admin_tourCode: "رمز الجولة (1=يوم واحد,2=VIP,3=حزمة):",
                admin_tourImages: "صور الجولة (max 10):",
                admin_tourBtn: "أضف جولة",
                admin_savedToursBtn: "الجولات المحفوظة",
                admin_salesReport: "تقرير المبيعات",
                admin_logout: "خروج",
                seller_panel: "لوحة البائع",
                seller_panel_sub: "مرحبًا <span id='sellerName'></span>. يمكنك مشاهدة جميع الجولات وإجراء المبيعات.",
                seller_stats: "إحصائيات البائع",
                seller_logout: "خروج",
                seller_activeTours: "جميع الجولات"
            },
            ka: {
                header_title: "გაუმჯობესებული ტურის გაყიდვების სისტემა",
                header_subtitle: "ადმინ: admin/12345 - გამყიდველი: satici1/12345",
                login_title: "შესვლა",
                login_user: "მომხმარებლის სახელი",
                login_pass: "პაროლი",
                login_button: "შესვლა",
                login_info: "მაგალითი: admin/12345 ან satici1/12345",
                admin_goSeller: "გაყიდვების ეკრანზე გადასვლა",
                admin_panel_title: "ადმინის პანელი",
                admin_panel_subtitle: "გამარჯობა <span id='adminName'></span>. აქ შეგიძლიათ დაამატოთ ტურები და ნახოთ გაყიდვების ანგარიში.",
                admin_changePass: "ადმინის პაროლის შეცვლა",
                admin_newPass: "ახალი პაროლი:",
                admin_passBtn: "ცვლა",
                admin_newTour: "ტურის დამატება",
                admin_tourName: "ტურის სახელი:",
                admin_tourDesc: "აღწერა:",
                admin_tourDate: "თარიღი (დღე):",
                admin_tourStart: "დაწყების დრო:",
                admin_tourEnd: "დასასრული დრო:",
                admin_tourPrice: "ფასი (TL):",
                admin_tourStops: "შეჩერებები (მძიმით):",
                admin_tourLoc: "მდებარეობის ინფორმაცია:",
                admin_tourGuide: "გიდის ინფორმაცია:",
                admin_tourSeats: "სულ ადგილები:",
                admin_tourCode: "ტურის კოდი (1=ერთდღიანი,2=VIP,3=პაკეტი):",
                admin_tourImages: "ტურის სურათები (max 10):",
                admin_tourBtn: "ტურის დამატება",
                admin_savedToursBtn: "შენახული ტურები",
                admin_salesReport: "გაყიდვების ანგარიში",
                admin_logout: "გასვლა",
                seller_panel: "გამყიდველის პანელი",
                seller_panel_sub: "გამარჯობა <span id='sellerName'></span>. აქ შეგიძლიათ ნახოთ ყველა ტური და გაყიდოთ.",
                seller_stats: "გამყიდველის სტატისტიკა",
                seller_logout: "გასვლა",
                seller_activeTours: "ყველა ტური"
            },
            de: { // Almanca
                header_title: "Erweitertes Tour-Verkaufssystem",
                header_subtitle: "Admin: admin/12345 - Verkäufer: satici1/12345",
                login_title: "Einloggen",
                login_user: "Benutzername",
                login_pass: "Passwort",
                login_button: "Einloggen",
                login_info: "Beispiel: admin/12345 oder satici1/12345",
                admin_goSeller: "Zur Verkäuferseite wechseln",
                admin_panel_title: "Admin-Panel",
                admin_panel_subtitle: "Hallo <span id='adminName'></span>. Hier können Sie Touren hinzufügen und Verkaufsberichte ansehen.",
                admin_changePass: "Admin-Passwort ändern",
                admin_newPass: "Neues Passwort:",
                admin_passBtn: "Ändern",
                admin_newTour: "Tour hinzufügen",
                admin_tourName: "Tour-Name:",
                admin_tourDesc: "Beschreibung:",
                admin_tourDate: "Datum (Tag):",
                admin_tourStart: "Startzeit:",
                admin_tourEnd: "Endzeit:",
                admin_tourPrice: "Preis (TL):",
                admin_tourStops: "Haltestellen (mit Komma):",
                admin_tourLoc: "Standortinformationen:",
                admin_tourGuide: "Reiseführer:",
                admin_tourSeats: "Gesamtsitze:",
                admin_tourCode: "Tourcode (1=Tagestour,2=VIP,3=Paket):",
                admin_tourImages: "Tourbilder (max 10):",
                admin_tourBtn: "Tour hinzufügen",
                admin_savedToursBtn: "Gespeicherte Touren",
                admin_salesReport: "Verkaufsbericht",
                admin_logout: "Abmelden",
                seller_panel: "Verkäuferpanel",
                seller_panel_sub: "Hallo <span id='sellerName'></span>. Hier können Sie alle Touren sehen und verkaufen.",
                seller_stats: "Verkäuferstatistiken",
                seller_logout: "Abmelden",
                seller_activeTours: "Alle Touren"
            },
            ru: { // Rusça
                header_title: "Продвинутая Система Продаж Туров",
                header_subtitle: "Админ: admin/12345 - Продавец: satici1/12345",
                login_title: "Вход",
                login_user: "Имя пользователя",
                login_pass: "Пароль",
                login_button: "Войти",
                login_info: "Пример: admin/12345 или satici1/12345",
                admin_goSeller: "Перейти к продавцу",
                admin_panel_title: "Панель администратора",
                admin_panel_subtitle: "Здравствуйте, <span id='adminName'></span>. Здесь вы можете добавить туры и просмотреть отчёты.",
                admin_changePass: "Изменить пароль",
                admin_newPass: "Новый пароль:",
                admin_passBtn: "Изменить",
                admin_newTour: "Добавить тур",
                admin_tourName: "Название тура:",
                admin_tourDesc: "Описание:",
                admin_tourDate: "Дата (день):",
                admin_tourStart: "Время начала:",
                admin_tourEnd: "Время окончания:",
                admin_tourPrice: "Цена (TL):",
                admin_tourStops: "Остановки (через запятую):",
                admin_tourLoc: "Информация о месте:",
                admin_tourGuide: "Гид:",
                admin_tourSeats: "Всего мест:",
                admin_tourCode: "Код тура (1=Однодневный,2=VIP,3=Пакет):",
                admin_tourImages: "Фото тура (max 10):",
                admin_tourBtn: "Добавить тур",
                admin_savedToursBtn: "Сохранённые туры",
                admin_salesReport: "Отчёт продаж",
                admin_logout: "Выйти",
                seller_panel: "Панель продавца",
                seller_panel_sub: "Здравствуйте, <span id='sellerName'></span>. Здесь вы можете просмотреть и продавать туры.",
                seller_stats: "Статистика продавца",
                seller_logout: "Выйти",
                seller_activeTours: "Все туры"
            },
            fa: { // Farsça
                header_title: "سیستم پیشرفته فروش تور",
                header_subtitle: "مدیر: admin/12345 - فروشنده: satici1/12345",
                login_title: "ورود",
                login_user: "نام کاربری",
                login_pass: "رمز عبور",
                login_button: "ورود",
                login_info: "مثال: admin/12345 یا satici1/12345",
                admin_goSeller: "رفتن به صفحه فروشنده",
                admin_panel_title: "پنل مدیریت",
                admin_panel_subtitle: "سلام <span id='adminName'></span>. در اینجا می‌توانید تور اضافه کنید و گزارشات را ببینید.",
                admin_changePass: "تغییر رمز مدیریت",
                admin_newPass: "رمز جدید:",
                admin_passBtn: "تغییر",
                admin_newTour: "افزودن تور",
                admin_tourName: "نام تور:",
                admin_tourDesc: "توضیحات:",
                admin_tourDate: "تاریخ (روز):",
                admin_tourStart: "ساعت شروع:",
                admin_tourEnd: "ساعت پایان:",
                admin_tourPrice: "قیمت (لیر):",
                admin_tourStops: "ایستگاه‌ها (با ویرگول):",
                admin_tourLoc: "اطلاعات مکان:",
                admin_tourGuide: "راهنما:",
                admin_tourSeats: "تعداد صندلی:",
                admin_tourCode: "کد تور (1=روزانه،2=VIP،3=پکیج):",
                admin_tourImages: "تصاویر تور (max 10):",
                admin_tourBtn: "افزودن تور",
                admin_savedToursBtn: "تورهای ذخیره شده",
                admin_salesReport: "گزارش فروش",
                admin_logout: "خروج",
                seller_panel: "پنل فروشنده",
                seller_panel_sub: "سلام <span id='sellerName'></span>. در اینجا می‌توانید تمام تورها را ببینید و بفروشید.",
                seller_stats: "آمار فروشنده",
                seller_logout: "خروج",
                seller_activeTours: "تمام تورها"
            }
        };


        function switchLanguage(lang) {
            if (lang === "ar") {
                document.body.setAttribute("dir", "rtl");
            } else {
                document.body.setAttribute("dir", "ltr");
            }
            const nodes = document.querySelectorAll("[data-key]");
            nodes.forEach(n => {
                let key = n.getAttribute("data-key");
                if (translations[lang] && translations[lang][key]) {
                    n.innerHTML = translations[lang][key];
                }
            });
        }
        document.getElementById("languageSelect").addEventListener("change", function () {
            switchLanguage(this.value);
        });

        /* ================== 17. Canlı Chat (demo) ================== */
        function toggleLiveChat() {
            let chat = document.getElementById("liveChat");
            chat.style.display = (chat.style.display === "none" || !chat.style.display) ? "flex" : "none";
        }
        function getEmbedUrl(url) {
            if (url.includes("watch?v=")) {
                let videoId = url.split("watch?v=")[1];
                if (videoId.includes("&")) {
                    videoId = videoId.split("&")[0];
                }
                return "https://www.youtube.com/embed/" + videoId;
            }
            return url; // Eğer zaten embed ise olduğu gibi döner.
        }

        function sendLiveChat() {
            let msgBox = document.getElementById("liveChatInput");
            let msg = msgBox.value.trim();
            if (!msg) return;
            let chatArea = document.getElementById("liveChatMessages");
            let p = document.createElement("p");
            p.textContent = "Kullanıcı: " + msg;
            chatArea.appendChild(p);
            msgBox.value = "";
        }

        /* ================== 18. Sayfa Yüklenince ================== */
        window.addEventListener("load", () => {
            document.getElementById("loginSection").classList.add("active");
        });
        // Satıcıları dropdown'a yükleme
        async function loadSellers() {
            const sellerSelect = document.getElementById('selectedSeller');
            sellerSelect.innerHTML = '<option value="">Tüm Satıcılar</option>';

            let sellerSet = new Set();

            salesHistory.forEach(sale => {
                if (sale.sellerName) sellerSet.add(sale.sellerName);
                if (sale.sellerUsername) sellerSet.add(sale.sellerUsername);
            });

            sellerSet.forEach(seller => {
                sellerSelect.innerHTML += `<option value="${seller}">${seller}</option>`;
            });
        }

        // Filtreleme Fonksiyonu


        // Sonuçları tabloya render etme
        function renderSalesTable(sales) {
            let html = `
    <table class="acc-details-table">
      <thead>
        <tr>
          <th>Satıcı</th>
          <th>Tur Adı</th>
          <th>Tur Kodu</th>
          <th>Tarih</th>
          <th>Başlama Saati</th>
          <th>Koltuk</th>
          <th>Tutar</th>
          <th>Müşteri Adı</th>
          <th>Ülke</th>
        </tr>
      </thead>
      <tbody>
  `;

            sales.forEach(sale => {
                html += `
      <tr>
        <td>${sale.sellerName || sale.sellerUsername}</td>
        <td>${sale.tourName}</td>
        <td>${sale.tourCode}</td>
        <td>${new Date(sale.tourDate).toLocaleDateString()}</td>
        let tourDetails = tours.find(t => t.id === sale.tourId);
        <td>${tourDetails ? tourDetails.startTime : "-"}</td>
        <td>${sale.seatsSold}</td>
        <td>${sale.totalPrice} TL</td>
        <td>${sale.buyerName}</td>
        <td>${sale.buyerCountry}</td>
      </tr>
    `;
            });

            html += `</tbody></table>`;

            document.getElementById('sellerAccountingAdminResults').innerHTML = html;
        }

        // Satıcıları sayfa yüklendiğinde otomatik yükle
        window.addEventListener('DOMContentLoaded', () => {
            populateSellerDropdown();
        });


        async function populateSellerDropdown() {
            const sellerSelect = document.getElementById('selectedSeller');
            sellerSelect.innerHTML = '<option value="">Tüm Satıcılar</option>';

            const sellersSnapshot = await sellersCollection.get();
            sellersSnapshot.docs.forEach(doc => {
                const seller = doc.data();
                const option = document.createElement('option');
                option.value = seller.username;
                option.textContent = seller.name || seller.username;
                sellerSelect.appendChild(option);
            });
        }

        window.addEventListener('DOMContentLoaded', populateSellerDropdown);





        function filterSales() {
            const selectedSeller = document.getElementById('selectedSeller').value;
            const tourName = document.getElementById('filterTourName').value.trim().toLowerCase();
            const tourCode = document.getElementById('filterTourCode').value.trim();
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;

            const filteredSales = salesHistory.filter(sale => {
                return (!selectedSeller || [sale.sellerUsername, sale.sellerName].includes(selectedSeller)) &&
                    (!tourName || sale.tourName.toLowerCase().includes(tourName)) &&
                    (!tourCode || sale.tourCode === tourCode) &&
                    (!startDate || new Date(sale.tourDate) >= new Date(startDate)) &&
                    (!endDate || new Date(sale.tourDate) <= new Date(endDate));
            });

            renderSalesTable(filteredSales);
        }


        function renderSalesTable(sales) {
            let html = `
    <table class="acc-details-table">
      <thead>
        <tr>
          <th>Satıcı</th>
          <th>Tur Adı</th>
          <th>Tur Kodu</th>
          <th>Tarih</th>
          <th>Başlama Saati</th>
          <th>Koltuk</th>
          <th>Tutar</th>
          <th>Müşteri Adı</th>
          <th>Ülke</th>
        </tr>
      </thead>
      <tbody>
  `;

            sales.forEach(sale => {
                const tourDetails = tours.find(t => t.id === sale.tourId) || {};
                html += `
      <tr>
        <td>${sale.sellerName || sale.sellerUsername}</td>
        <td>${sale.tourName}</td>
        <td>${sale.tourCode}</td>
        <td>${new Date(sale.tourDate).toLocaleDateString()}</td>
        <td>${tourDetails ? tourDetails.startTime : "-"}</td>
        <td>${sale.seatsSold}</td>
        <td>${sale.totalPrice} TL</td>
        <td>${sale.buyerName}</td>
        <td>${sale.buyerCountry}</td>
      </tr>
    `;
            });

            html += `</tbody></table>`;

            document.getElementById('sellerAccountingAdminResults').innerHTML = html;
        }

        // DOM yüklendikten sonra satıcıları yükle
        window.addEventListener('DOMContentLoaded', () => {
            populateSellerDropdown();
        });
        function toggleChat() {
            const chatBody = document.getElementById('chatBody');
            chatBody.style.display = chatBody.style.display === 'flex' ? 'none' : 'flex';
        }

        function sendMessage() {
            const userInput = document.getElementById('userMessage');
            const message = userInput.value.trim();
            if (!message) return;

            const chatMessages = document.getElementById('chatMessages');

            const userMsg = document.createElement('div');
            userMsg.classList.add('message', 'user');
            userMsg.textContent = message;
            chatMessages.appendChild(userMsg);

            userInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            setTimeout(() => replyBot(message), 800);
        }

        function replyBot(message) {
            const chatMessages = document.getElementById('chatMessages');
            const botMsg = document.createElement('div');
            botMsg.classList.add('message', 'bot');

            // Basit yanıt mantığı
            if (message.includes('fiyat') || message.includes('ücret')) {
                botMsg.textContent = '📌 Fiyat bilgisi için size hemen yardımcı oluyorum. Lütfen turun adını belirtin.';
            } else if (message.includes('merhaba')) {
                botMsg.textContent = '👋 Merhaba, size nasıl yardımcı olabilirim?';
            } else {
                botMsg.textContent = '🧐 Sorunuzla ilgili hemen destek sağlıyoruz, birazdan sizinle iletişime geçeceğiz.';
            }

            chatMessages.appendChild(botMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }




        function geriSayimBaslat() {
            setInterval(function () {
                const geriSayimlar = document.querySelectorAll('.geriSayim');

                geriSayimlar.forEach(function (eleman) {
                    const bitisZamani = new Date(eleman.getAttribute('data-tarih')).getTime();
                    const simdi = new Date().getTime();
                    const kalanSure = bitisZamani - simdi;

                    if (kalanSure > 0) {
                        let gun = Math.floor(kalanSure / (1000 * 60 * 60 * 24));
                        let saat = Math.floor((kalanSure % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        let dakika = Math.floor((kalanSure % (1000 * 60 * 60)) / (1000 * 60));
                        let saniye = Math.floor((kalanSure % (1000 * 60)) / 1000);

                        eleman.innerHTML = `⏳ Başlangıca kalan: <strong>${gun}g ${saat}s ${dakika}dk ${saniye}sn</strong>`;
                        eleman.style.color = 'red';
                    } else {
                        eleman.innerHTML = "🛑 Bu tur başladı veya bitti!";
                        eleman.style.color = 'red';
                    }
                });

            }, 1000); // Her saniye güncellenir
        }

        // Sayfa yüklendiğinde geri sayımı başlat
        document.addEventListener("DOMContentLoaded", geriSayimBaslat);
        arr.forEach(t => {
            let dv = document.createElement("div");
            dv.classList.add("tour-item");

            dv.innerHTML = `
    <h3>${t.name}</h3>
    <p><strong>Tarih/Saat:</strong> ${t.date} ${t.startTime}-${t.endTime}</p>
      <div class="geriSayim" data-tarih="${t.date}T${t.startTime}"></div>
  `;

            c.appendChild(dv);
        });

        document.querySelectorAll(".tour-item").forEach(tourCard => {
            let alternativeTour = tourCard.getAttribute("data-alternative") || "";
            let altTourDiv = tourCard.querySelector(".alternative-tour");

            if (!altTourDiv) {
                console.warn("Alternative Tour div bulunamadı! Kart ID:", tourCard.getAttribute("data-tour-id"));
                return;
            }

            if (alternativeTour.trim() !== "") {
                altTourDiv.innerHTML = `<span>🔁 Alternatif Tur: <strong>${alternativeTour}</strong></span>`;
                altTourDiv.style.display = "flex";
            } else {
                altTourDiv.style.display = "none";
            }
        });
        document.addEventListener("DOMContentLoaded", function () {
            let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            if (isIOS) {
                console.log("Bu sayfa iOS cihazında açılıyor.");
            } else {
                console.log("Bu sayfa iOS dışında açılıyor.");
            }
        });

        function initCountdown() {
            const counters = document.querySelectorAll(".geriSayim");
            counters.forEach(counter => {
                const endTime = new Date(counter.getAttribute('data-tarih')).getTime();

                const interval = setInterval(() => {
                    const now = new Date().getTime();
                    const remaining = endTime - now;

                    if (remaining <= 0) {
                        counter.innerHTML = "Tur Başladı!";
                        clearInterval(interval);
                        return;
                    }

                    const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((remaining / (1000 * 60 * 60)) % 24);
                    const minutes = Math.floor((remaining / (1000 * 60)) % 60);
                    const seconds = Math.floor((remaining / 1000) % 60);

                    counter.innerHTML = `⏳ ${days} gün ${hours} saat ${minutes} dakika ${seconds} saniye`;
                }, 1000);
            });
        }

        window.addEventListener('DOMContentLoaded', initCountdown);



        document.getElementById('reservationSaveBtn').addEventListener('click', async () => {
            const reservation = {
                tourName: document.getElementById('tourName').value,
                tourDate: document.getElementById('tourDate').value,
                personCount: document.getElementById('personCount').value,
                customerName: document.getElementById('customerName').value,
                customerSurname: document.getElementById('customerSurname').value,
                country: document.getElementById('country').value,
                phone: document.getElementById('phone').value,
                notes: document.getElementById('notes').value,
                createdAt: serverTimestamp(),
            };

            try {
                await addDoc(collection(db, "ileriRezervasyonlar"), reservation);
                alert('✅ Rezervasyon başarıyla kaydedildi!');
            } catch (e) {
                alert('❌ Rezervasyon kaydedilirken hata oluştu: ' + e.message);
            }
        });





        // Rezervasyon ekleme butonu
        document.getElementById('reservationSaveBtn').addEventListener('click', async () => {
            const reservation = {
                tourName: document.getElementById('tourName').value,
                tourDate: document.getElementById('tourDate').value,
                personCount: document.getElementById('personCount').value,
                customerName: document.getElementById('customerName').value,
                customerSurname: document.getElementById('customerSurname').value,
                country: document.getElementById('country').value,
                phone: document.getElementById('phone').value,
                notes: document.getElementById('notes').value,
                createdAt: serverTimestamp(),
            };

            try {
                await addDoc(collection(db, "ileriRezervasyonlar"), reservation);
                alert('✅ Rezervasyon başarıyla kaydedildi!');
                loadReservations(); // Yeniden verileri yükle
            } catch (e) {
                alert('❌ Hata oluştu: ' + e.message);
            }
        });

        async function loadReservations() {
            const tbody = document.getElementById("reservationsList");
            tbody.innerHTML = "";

            const snapshot = await db.collection("ileriRezervasyonlar").orderBy("createdAt", "desc").get();

            snapshot.forEach(doc => {
                const r = doc.data();

                // Gün farkı hesapla
                const today = new Date();
                const tourDate = new Date(r.tourDate);
                const fark = Math.floor((tourDate - today) / (1000 * 60 * 60 * 24));

                // Satır rengi belirle
                let rowColor = "white";
                if (fark < 7) rowColor = "#ffcccc";        // kırmızı
                else if (fark < 15) rowColor = "#fff9c4";  // sarı
                else if (fark < 30) rowColor = "#ffe0b2";  // turuncu

                const tr = document.createElement("tr");
                tr.style.background = rowColor;

                tr.innerHTML = `
      <td>📌 ${r.tourName || "-"}</td>
      <td>📅 ${r.tourDate || "-"}</td>
      <td>👥 ${r.personCount || "-"}</td>
      <td>🧍 ${r.customerName || ""} ${r.customerSurname || ""}</td>
      <td>👤 ${r.sellerName || "-"}</td>
      <td>🌍 ${r.country || "-"}</td>
      <td>📞 ${r.phone || "-"}</td>
      <td>📝 ${r.notes || "-"}</td>
      <td><a href="https://wa.me/${r.phone}" target="_blank">💬</a></td>
    `;

                tbody.appendChild(tr);
            });
        }


        // İlk açılışta rezervasyonları yükle
        window.onload = loadReservations;




        function sendDetailedWhatsAppNotification(data) {
            const accountSid = 'AC2915403b6e11bcc0442780dc0093e024';
            const authToken = '6867084da550ef902543a0e6c693addc';

            const messageBody = `
📢 *Yeni Tur Rezervasyonu Yapıldı!* 🎯

🔹 *Tur Adı:* ${data.tourName}
📆 *Tur Tarihi:* ${data.tourDate}
📍 *Tur Lokasyonu:* ${data.tourLocation}

👤 *Müşteri:* ${data.customerName} ${data.customerSurname}
🌍 *Ülke:* ${data.customerCountry}
📞 *Telefon:* ${data.customerPhone}

💼 *Satıcı:* ${data.sellerName}

💵 *Kişi Sayısı:* ${data.personCount}
💳 *Kişi Başı Ücret:* ${data.unitPrice} ₺
💰 *Toplam Tutar:* ${data.totalPrice} ₺

📝 *Notlar:* ${data.notes || "Yok"}

🕒 *Rezervasyon Zamanı:* ${new Date().toLocaleString('tr-TR')}

✨ *Satışınız bol olsun!* ✨
  `;

            fetch(`https://api.twilio.com/2010-04-01/Accounts/${accountSid}/Messages.json`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Basic ' + btoa(`${accountSid}:${authToken}`),
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    From: 'whatsapp:+14155238886',
                    To: 'whatsapp:+905467212888', // buraya kendi numaranı yaz
                    Body: messageBody
                })
            })
                .then(response => response.json())
                .then(data => console.log('✅ WhatsApp mesajı gönderildi!', data))
                .catch(err => console.error('❌ Hata:', err));
        }
        let numbers = ["+905467212888", "+905551112233"]; // İkinci numara örneği





        // Sayfa açılırken rezervasyonları yükle
        document.addEventListener('DOMContentLoaded', loadReservations);


        const ileriRezervasyonlar = db.collection("ileriRezervasyonlar");

        document.getElementById('reservationSaveBtn').addEventListener('click', async () => {
            const reservation = {
                tourName: document.getElementById('tourName').value,
                tourDate: document.getElementById('tourDate').value,
                personCount: document.getElementById('personCount').value,
                customerName: document.getElementById('customerName').value,
                customerSurname: document.getElementById('customerSurname').value,
                country: document.getElementById('country').value,
                phone: document.getElementById('phone').value,
                notes: document.getElementById('notes').value,
                createdAt: new Date()  // ⛔ serverTimestamp yerine
            };

            try {
                await ileriRezervasyonlar.add(reservation);
                alert('✅ Rezervasyon kaydedildi!');
                loadReservations(); // tabloyu yenile
            } catch (e) {
                console.error('Hata:', e);
                alert('❌ Rezervasyon sırasında hata oluştu: ' + e.message);
            }
        });

        async function loadReservations() {
            const tbody = document.getElementById('reservationsList');
            tbody.innerHTML = "";

            try {
                const snapshot = await ileriRezervasyonlar.orderBy("createdAt", "desc").get();
                snapshot.forEach(doc => {
                    const r = doc.data();
                    const tr = document.createElement("tr");

                    tr.innerHTML = `
          <td>${r.tourName}</td>
          <td>${r.tourDate}</td>
          <td>${r.personCount}</td>
          <td>${r.customerName} ${r.customerSurname}</td>
          <td>${r.country}</td>
          <td>${r.phone}</td>
          <td>${r.notes || "-"}</td>
          <td><a href="https://wa.me/${r.phone}" target="_blank">💬 WhatsApp</a></td>
        `;

                    tbody.appendChild(tr);
                });
            } catch (err) {
                console.error("Veriler alınamadı:", err);
            }
        }

        document.addEventListener("DOMContentLoaded", loadReservations);


        function loadReservations() {
            const tbody = document.getElementById("reservationsList");
            tbody.innerHTML = "";

            firebase.firestore().collection("ileriRezervasyonlar")
                .orderBy("createdAt", "desc")
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const r = doc.data();
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
          <td>${r.tourName}</td>
          <td>${r.tourDate}</td>
          <td>${r.personCount}</td>
          <td>${r.customerName} ${r.customerSurname}</td>
          <td>${r.country}</td>
          <td>${r.phone}</td>
          <td>${r.notes || '-'}</td>
          <td><a href="https://wa.me/${r.phone}" target="_blank">💬</a></td>
        `;
                        tbody.appendChild(tr);
                    });
                })
                .catch((err) => {
                    console.error("Veri çekilemedi:", err);
                });
        }
        document.getElementById('reservationSaveBtn').addEventListener('click', function () {
            const reservation = {
                tourName: document.getElementById('tourName').value,
                tourDate: document.getElementById('tourDate').value,
                personCount: document.getElementById('personCount').value,
                customerName: document.getElementById('customerName').value,
                customerSurname: document.getElementById('customerSurname').value,
                country: document.getElementById('country').value,
                phone: document.getElementById('phone').value,
                notes: document.getElementById('notes').value,
                createdAt: new Date()
            };

            firebase.firestore().collection("ileriRezervasyonlar")
                .add(reservation)
                .then(() => {
                    alert("✅ Rezervasyon başarıyla kaydedildi!");
                    loadReservations();
                })
                .catch((error) => {
                    console.error("❌ Hata:", error);
                    alert("❌ Rezervasyon sırasında hata oluştu: " + error.message);
                });
        });
        document.addEventListener("DOMContentLoaded", loadReservations);


        function saveReservation() {
            const reservation = {
                tourName: document.getElementById('tourName').value,
                tourDate: document.getElementById('tourDate').value,
                personCount: document.getElementById('personCount').value,
                customerName: document.getElementById('customerName').value,
                customerSurname: document.getElementById('customerSurname').value,
                country: document.getElementById('country').value,
                phone: document.getElementById('phone').value,
                notes: document.getElementById('notes').value,
                sellerName: currentUser?.name || "Bilinmiyor", // ✅ Bu satırı mutlaka ekle
                createdAt: new Date()
            };

            firebase.firestore().collection("ileriRezervasyonlar")
                .add(reservation)
                .then(() => {
                    alert("✅ Rezervasyon başarıyla kaydedildi!");
                    loadReservations(); // tabloyu güncelle
                })
                .catch((error) => {
                    console.error("❌ Rezervasyon hatası:", error);
                    alert("❌ Kayıt hatası: " + error.message);
                });
        }
        function loadReservations() {
            const tbody = document.getElementById("reservationsList");
            tbody.innerHTML = "";

            firebase.firestore().collection("ileriRezervasyonlar")
                .orderBy("createdAt", "desc")
                .get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const r = doc.data();
                        const tr = document.createElement("tr");
                        tr.innerHTML = `
          <td>${r.tourName}</td>
          <td>${r.tourDate}</td>
          <td>${r.personCount}</td>
          <td>${r.customerName} ${r.customerSurname}</td>
          <td>${r.country}</td>
          <td>${r.phone}</td>
          <td>${r.notes || '-'}</td>
          <td><a href="https://wa.me/${r.phone}" target="_blank">💬</a></td>
        `;
                        tbody.appendChild(tr);
                    });
                });
        }

        querySnapshot.forEach((doc) => {
            const r = doc.data();
            const tr = document.createElement('tr');

            tr.innerHTML = `
    <td>${r.tourName}</td>
    <td>${r.tourDate}</td>
    <td>${r.personCount}</td>
    <td>${r.customerName} ${r.customerSurname}</td>
    <td>${r.country}</td>
    <td>${r.phone}</td>
    <td>${r.notes || "-"}</td>
    <td><a href="https://wa.me/${r.phone}" target="_blank">💬</a></td>
  `;

            // 👇 TIKLAMA OLAYI EKLE
            tr.onclick = () => {
                alert(`
📋 REZERVASYON DETAYI

📍 Tur: ${r.tourName}
📅 Tarih: ${r.tourDate}
👥 Kişi: ${r.personCount}
👤 Müşteri: ${r.customerName} ${r.customerSurname}
🌍 Ülke: ${r.country}
📞 Telefon: ${r.phone}
📝 Not: ${r.notes || "Yok"}
    `);
            };

            tbody.appendChild(tr);
        });




        document.addEventListener("DOMContentLoaded", () => {
            loadFilteredReservations();

            const closeBtn = document.getElementById("closeAdvancedPanel");
            const panel = document.querySelector(".reservations-report");

            if (closeBtn && panel) {
                closeBtn.addEventListener("click", () => {
                    panel.classList.add("fadeOut");
                    setTimeout(() => {
                        panel.style.display = "none";
                        panel.classList.remove("fadeOut");
                    }, 300);
                });
            }
        });
        function editTour(tid) {
            const tur = tours.find(t => t.id === tid);
            if (!tur) {
                alert("Tur bulunamadı!");
                return;
            }

            // Formu aç ve alanları doldur
            document.getElementById("editTourForm").style.display = "block";
            document.getElementById("editTourId").value = tid;
            document.getElementById("editTourName").value = tur.name || "";
            document.getElementById("editTourDesc").value = tur.description || "";
            document.getElementById("editTourDate").value = tur.date || "";
            document.getElementById("editTourStart").value = tur.startTime || "";
            document.getElementById("editTourEnd").value = tur.endTime || "";
            document.getElementById("editTourPrice").value = tur.price || "";
            document.getElementById("editTourGuide").value = tur.guide || "";
        }
        async function saveTourEdits() {
            const id = document.getElementById("editTourId").value;
            const updatedData = {
                name: document.getElementById("editTourName").value,
                description: document.getElementById("editTourDesc").value,
                date: document.getElementById("editTourDate").value,
                startTime: document.getElementById("editTourStart").value,
                endTime: document.getElementById("editTourEnd").value,
                price: parseFloat(document.getElementById("editTourPrice").value),
                guide: document.getElementById("editTourGuide").value
            };

            try {
                await toursCollection.doc(id).update(updatedData);
                alert("✅ Tur başarıyla güncellendi!");
                document.getElementById("editTourForm").style.display = "none";
                renderAdminTours(); // Listeyi güncelle
            } catch (err) {
                console.error("Güncelleme hatası:", err);
                alert("❌ Güncelleme başarısız: " + err.message);
            }
        }

        function editTour(tid) {
            const tur = tours.find(t => t.id === tid);
            if (!tur) {
                alert("Tur bulunamadı!");
                return;
            }

            // Değerleri inputlara doldur
            document.getElementById("editTourId").value = tid;
            document.getElementById("editTourName").value = tur.name || "";
            document.getElementById("editTourDesc").value = tur.description || "";
            document.getElementById("editTourDate").value = tur.date || "";
            document.getElementById("editTourStart").value = tur.startTime || "";
            document.getElementById("editTourEnd").value = tur.endTime || "";
            document.getElementById("editTourPrice").value = tur.price || "";
            document.getElementById("editTourGuide").value = tur.guide || "";
            document.getElementById("editTourSeats").value = tur.seats || 0;



            // Modalı aç
            document.getElementById("editTourModal").style.display = "block";
        }
        async function saveTourEdits() {
            const id = document.getElementById("editTourId").value;

            const updatedData = {
                name: document.getElementById("editTourName").value,
                description: document.getElementById("editTourDesc").value,
                date: document.getElementById("editTourDate").value,
                startTime: document.getElementById("editTourStart").value,
                endTime: document.getElementById("editTourEnd").value,
                price: parseFloat(document.getElementById("editTourPrice").value),
                guide: document.getElementById("editTourGuide").value,
                seats: parseInt(document.getElementById("editTourSeats").value),


            };

            try {
                await toursCollection.doc(id).update(updatedData);
                alert("✅ Tur başarıyla güncellendi!");
                document.getElementById("editTourModal").style.display = "none";
                renderAdminTours(); // listeyi yenile
            } catch (err) {
                alert("❌ Hata: " + err.message);
            }
        }
        function closeEditModal() {
            document.getElementById("editTourModal").style.display = "none";
        }

        document.addEventListener('DOMContentLoaded', function () {
            const codeSelect = document.getElementById('addTourCode');
            const continueBtn = document.getElementById('continueBtn');
            const packageFields = document.getElementById('packageTourDetails');

            continueBtn.addEventListener('click', () => {
                if (codeSelect.value === '3') {
                    packageFields.style.display = 'block';
                } else {
                    packageFields.style.display = 'none';
                }
            });
        });
        function togglePackageFields() {
            const packageFields = document.getElementById("packageFields");
            const code = document.getElementById("tourCode").value;
            packageFields.style.display = (code === "3") ? "block" : "none";
        }
        // onchange olayı tur kodu seçince tetiklenecek
        function tourCodeChange() {
            let code = document.getElementById("tourCode").value;
            document.getElementById("packageDetails").style.display = code === "3" ? "block" : "none";
        }

        // Tur ekleme fonksiyonun (submitTour)
        function submitTour() {

            let tour = {
                name: document.getElementById("tourName").value,
                price: document.getElementById("tourPrice").value,
                guide: document.getElementById("tourGuide").value,
                location: document.getElementById("tourLocation").value,
                seats: document.getElementById("tourSeats").value,
                code: document.getElementById("tourCode").value,
                alternativeTour: document.getElementById("alternativeTourName").value,
                date: document.getElementById("tourDate").value,
                startTime: document.getElementById("tourStartTime").value,
                endTime: document.getElementById("tourEndTime").value,
                stops: document.getElementById("tourStops").value.split(","),
                video: document.getElementById("tourVideo").value
            };

            // Kod 3 (Paket tur) özel detayları
            if (tour.code === "3") {
                tour.dayPlan = document.getElementById("dayPlan").value;
                tour.stayPlan = document.getElementById("stayPlan").value;
                tour.packagePrice = document.getElementById("packagePrice").value;
                tour.currency = document.getElementById("currency").value;
            }

            firebase.firestore().collection("tours").add(tour)
                .then(() => {
                    alert("Tur Başarıyla Eklendi");
                    renderSellerTours();
                })
                .catch(e => alert("Hata: " + e));
        }

        function tourCodeChange() {
            const code = document.getElementById("addTourCode").value;
            const packageDetails = document.getElementById("packageDetails");
            if (code === "3") {
                packageDetails.style.display = "block";
            } else {
                packageDetails.style.display = "none";
            }
        }
        async function populateSellerDropdown() {
            const select = document.getElementById("selectedSeller");
            select.innerHTML = "<option value=''>Tüm Satıcılar</option>";

            const sellersSnapshot = await sellersCollection.get();
            sellersSnapshot.forEach(doc => {
                const seller = doc.data();
                const opt = document.createElement("option");
                opt.value = seller.username;
                opt.textContent = seller.name || seller.username;
                select.appendChild(opt);
            });
        }
        window.addEventListener("DOMContentLoaded", populateSellerDropdown);

        // Yeni Admin Detaylı Satıcı Muhasebesi Sistemi
        function renderAdminAccountingPanel() {
            const container = document.getElementById("sellerAccountingAdminResults");
            container.innerHTML = "";

            const selectedSeller = document.getElementById("selectedSeller").value;
            const tourName = document.getElementById("filterTourName").value.trim().toLowerCase();
            const tourCode = document.getElementById("filterTourCode").value;
            const startDate = document.getElementById("filterStartDate").value;
            const endDate = document.getElementById("filterEndDate").value;

            let filtered = [...salesHistory];

            if (selectedSeller) {
                filtered = filtered.filter(s =>
                    s.sellerUsername === selectedSeller || s.sellerName === selectedSeller
                );
            }
            if (tourName) {
                filtered = filtered.filter(s => s.tourName.toLowerCase().includes(tourName));
            }
            if (tourCode) {
                filtered = filtered.filter(s => s.tourCode === tourCode);
            }
            if (startDate) {
                const s = new Date(startDate).getTime();
                filtered = filtered.filter(s => new Date(s.date).getTime() >= s);
            }
            if (endDate) {
                const e = new Date(endDate).getTime();
                filtered = filtered.filter(s => new Date(s.date).getTime() <= e);
            }

            let totalAmount = 0;
            let html = `
    <table class="acc-details-table">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>Tur</th>
          <th>Koltuk</th>
          <th>Tutar</th>
          <th>Ödeme</th>
          <th>Müşteri</th>
          <th>Alternatif Tur</th>
        </tr>
      </thead>
      <tbody>
  `;

            filtered.forEach(sale => {
                totalAmount += sale.totalPrice;
                html += `
      <tr>
        <td>${new Date(sale.date).toLocaleDateString()}</td>
        <td>${sale.tourName}</td>
        <td>${sale.seatsSold}</td>
        <td>${sale.totalPrice} TL</td>
        <td>${sale.paymentType}</td>
        <td>${sale.buyerName}</td>
        <td>${sale.alternativeTour || '-'}</td>
      </tr>
    `;
            });

            html += `</tbody></table>`;

            html += `
    <p><strong>Toplam Tutar:</strong> ${totalAmount} TL</p>
    <p><strong>Komisyon (%10):</strong> ${(totalAmount * 0.10).toFixed(2)} TL</p>
    <button style="margin-top:10px; background:#03a9f4; color:#fff; border:none; padding:10px 15px; border-radius:6px;" onclick="createAdminCommissionInvoice(${totalAmount})">
      Tahsilat Fişi Oluştur
    </button>
  `;

            container.innerHTML = html;
        }
        function confirmTotalPrice(tid) {
            const count = parseInt(document.getElementById(`seatCount_${tid}`).value || "1");
            const unitPrice = parseFloat(document.getElementById(`totalPrice_${tid}`).dataset.unitprice || "0");
            const total = unitPrice * count;

            // Yukarıdaki toplamı güncelle
            document.getElementById(`totalPrice_${tid}`).textContent = total.toFixed(2) + " TL";

            // 💳 Aşağıdaki amount input’una aynı değeri yaz
            const amountInput = document.getElementById("amount");
            if (amountInput) {
                amountInput.value = total.toFixed(2);
            }

            // Ödeme seçeneklerini göster
            document.getElementById(`paymentOptions_${tid}`).style.display = "block";
        }




        function updateTotalPrice(tid, unitPrice) {
            const count = parseInt(document.getElementById(`seatCount_${tid}`).value) || 1;
            const total = unitPrice * count;
            document.getElementById(`totalPrice_${tid}`).textContent = total.toFixed(2) + " TL";
        }
        function togglePaymentExtra(tid) {
            let pay = document.getElementById(`payment_${tid}`).value;
            let box = document.getElementById(`paymentExtra_${tid}`);
            if (!box) return;
            if (pay === "Kredi Kartı") {
                box.style.display = "block";
                box.innerHTML = `
          Satın al butonuna bastığınızda, banka ödeme sayfasına yönlendirileceksiniz.
        `;
            } else if (pay === "Banka Havalesi") {
                box.style.display = "block";
                box.innerHTML = `
          <label>IBAN:</label>
          <input type="text" placeholder="TR00..." />
        `;
            } else {
                box.style.display === "none";
                box.innerHTML = "";
            }
            if (pay === "Kredi Kartı") {
                const currentTotal = document.getElementById(`totalPrice_${tid}`)?.textContent || "0 TL";
                const onlyNumber = parseFloat(currentTotal.replace("TL", "").trim());
                setTimeout(() => {
                    const amountInput = document.getElementById("amount");
                    if (amountInput) {
                        amountInput.value = onlyNumber.toFixed(2);
                    }
                }, 50); // input eklenir eklenmez yazması için minik gecikme
            }

        }
        function hideSellerFilter() {
            const filterBox = document.getElementById("sellerAccountingFilterBox");
            if (filterBox) {
                filterBox.style.display = "none";
            }
        }

        function editTour(tid) {
            const tur = tours.find(t => t.id === tid);
            if (!tur) {
                alert("Tur bulunamadı!");
                return;
            }

            document.getElementById("editTourId").value = tid;
            document.getElementById("editTourName").value = tur.name || "";
            document.getElementById("editTourDesc").value = tur.description || "";
            document.getElementById("editTourDate").value = tur.date || "";
            document.getElementById("editTourStart").value = tur.startTime || "";
            document.getElementById("editTourEnd").value = tur.endTime || "";
            document.getElementById("editTourPrice").value = tur.price || "";
            document.getElementById("editTourGuide").value = tur.guide || "";
            document.getElementById("editTourSeats").value = tur.seats || "";

            // Modalı göster
            document.getElementById("editTourModal").style.display = "block";
        }

        function closeEditModal() {
            document.getElementById("editTourModal").style.display = "none";
        }

        async function saveTourEdits() {
            const id = document.getElementById("editTourId").value;

            const updatedData = {
                name: document.getElementById("editTourName").value,
                description: document.getElementById("editTourDesc").value,
                date: document.getElementById("editTourDate").value,
                startTime: document.getElementById("editTourStart").value,
                endTime: document.getElementById("editTourEnd").value,
                price: parseFloat(document.getElementById("editTourPrice").value),
                guide: document.getElementById("editTourGuide").value,
                seats: parseInt(document.getElementById("editTourSeats").value)
            };

            try {
                await toursCollection.doc(id).update(updatedData);
                alert("✅ Tur başarıyla güncellendi!");
                document.getElementById("editTourModal").style.display = "none";
                renderAdminTours(); // listeyi güncelle
            } catch (err) {
                alert("❌ Güncelleme başarısız: " + err.message);
                console.error("Güncelleme hatası:", err);
            }
        }
        // Şifre Göster/Gizle
        function togglePassword() {
            const input = document.getElementById("advancedSellerPassword");
            input.type = input.type === "password" ? "text" : "password";
        }

        // ✅ JavaScript: Gelişmiş Satıcı Yönetimi Fonksiyonları + Gelişmiş Özellikler + Gruplama + Excel Aktarma + Satış Bazlı Ekip Analizi

        // 1️⃣ Satıcıyı Firestore'a kaydetme
        async function addSellerAdvanced() {
            const username = document.getElementById("advancedSellerUsername").value.trim();
            const password = document.getElementById("advancedSellerPassword").value.trim();
            const fullName = document.getElementById("advancedSellerName").value.trim();
            const city = document.getElementById("advancedSellerCity").value.trim();
            const idNumber = document.getElementById("advancedSellerID").value.trim();
            const bankAccount = document.getElementById("advancedSellerIBAN").value.trim();
            const team = document.getElementById("advancedSellerTeam").value.trim();

            if (!username || !password || !fullName || !city || !idNumber || !bankAccount || !team) {
                alert("Lütfen tüm alanları doldurun!");
                return;
            }

            const sellerRef = firebase.firestore().collection("sellers").doc(username);
            const existing = await sellerRef.get();
            if (existing.exists) {
                alert("Bu kullanıcı adı zaten mevcut. Lütfen farklı bir ad seçin.");
                return;
            }

            await sellerRef.set({
                username,
                password,
                name: fullName,
                city,
                idNumber,
                bankAccount,
                team,
                role: "seller"
            });

            alert("✅ Satıcı başarıyla eklendi.");
            document.getElementById("advancedSellerForm").reset();
            renderAdvancedSellerList();
            renderTeamSalesStats(); // Yeni fonksiyonu da çağır
        }

        // 2️⃣ Satıcıları gruplu listele + filtre uygula
        async function renderAdvancedSellerList(groupFilter = "", cityFilter = "") {
            const container = document.getElementById("advancedSellerListGroups");
            container.innerHTML = "";
            const snapshot = await firebase.firestore().collection("sellers").get();

            let data = [];
            snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));

            if (groupFilter) data = data.filter(s => (s.team || "").toLowerCase().includes(groupFilter.toLowerCase()));
            if (cityFilter) data = data.filter(s => (s.city || "").toLowerCase().includes(cityFilter.toLowerCase()));

            if (!data.length) {
                container.innerHTML = `<p>🔍 Hiç sonuç bulunamadı</p>`;
                return;
            }

            const grouped = {};
            data.forEach(s => {
                const group = s.team || "Belirsiz Ekip";
                if (!grouped[group]) grouped[group] = [];
                grouped[group].push(s);
            });

            Object.entries(grouped).forEach(([groupName, sellers]) => {
                const wrapper = document.createElement("div");
                wrapper.className = "group-wrapper";

                wrapper.innerHTML = `
      <details open>
        <summary><strong>${groupName}</strong> (${sellers.length})</summary>
        <table class="seller-table">
          <thead>
            <tr>
              <th>Ad Soyad</th><th>Şehir</th><th>ID</th><th>IBAN</th><th>Kullanıcı</th><th>İşlem</th>
            </tr>
          </thead>
          <tbody>
            ${sellers.map(s => `
              <tr>
                <td>${s.name}</td>
                <td>${s.city}</td>
                <td>${s.idNumber}</td>
                <td>${s.bankAccount}</td>
                <td>${s.username}</td>
                <td>
                  <button onclick="openEditSellerModal('${s.id}')">✏️</button>
                  <button onclick="deleteSeller('${s.id}')">🗑️</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </details>
    `;
                container.appendChild(wrapper);
            });
        }

        // 3️⃣ Excel aktarımı
        function exportSellerListToExcel() {
            const tables = document.querySelectorAll(".seller-table");
            if (!tables.length) return alert("Liste boş!");

            let csv = "";
            tables.forEach(tbl => {
                const rows = tbl.querySelectorAll("tr");
                rows.forEach(row => {
                    const cols = row.querySelectorAll("th, td");
                    csv += [...cols].map(td => td.innerText).join(",") + "\n";
                });
                csv += "\n";
            });

            const blob = new Blob([csv], { type: "text/csv" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "satici_listesi.csv";
            a.click();
        }

        // 4️⃣ Modal işlemleri
        function openEditSellerModal(id) {
            firebase.firestore().collection("sellers").doc(id).get().then(doc => {
                if (!doc.exists) return alert("Satıcı bulunamadı.");
                const s = doc.data();
                document.getElementById("editSellerId").value = id;
                document.getElementById("editSellerName").value = s.name || "";
                document.getElementById("editSellerCity").value = s.city || "";
                document.getElementById("editSellerID").value = s.idNumber || "";
                document.getElementById("editSellerIBAN").value = s.bankAccount || "";
                document.getElementById("editSellerTeam").value = s.team || "";
                document.getElementById("editSellerPassword").value = "";
                document.getElementById("editSellerModal").style.display = "flex";
            });
        }

        function closeEditSellerModal() {
            document.getElementById("editSellerModal").style.display = "none";
        }

        async function saveSellerEdits() {
            const id = document.getElementById("editSellerId").value;
            const updates = {
                name: document.getElementById("editSellerName").value,
                city: document.getElementById("editSellerCity").value,
                idNumber: document.getElementById("editSellerID").value,
                bankAccount: document.getElementById("editSellerIBAN").value,
                team: document.getElementById("editSellerTeam").value
            };
            const newPass = document.getElementById("editSellerPassword").value;
            if (newPass) updates.password = newPass;

            await firebase.firestore().collection("sellers").doc(id).update(updates);
            alert("✅ Satıcı güncellendi.");
            closeEditSellerModal();
            renderAdvancedSellerList();
            renderTeamSalesStats();
        }

        async function deleteSeller(id) {
            if (!confirm("Satıcı silinsin mi?")) return;
            await firebase.firestore().collection("sellers").doc(id).delete();
            alert("🗑️ Silindi");
            renderAdvancedSellerList();
            renderTeamSalesStats();
        }

        // 5️⃣ Yeni: Ekip Bazlı Satış İstatistikleri
        async function renderTeamSalesStats() {
            const sales = await firebase.firestore().collection("salesHistory").get();
            const allSales = sales.docs.map(doc => doc.data());

            const grouped = {};
            for (let sale of allSales) {
                const seller = sale.sellerName || sale.sellerUsername || "-";
                const sellerDoc = await firebase.firestore().collection("sellers").where("name", "==", seller).get();
                let team = "Bilinmeyen";
                if (!sellerDoc.empty) {
                    team = sellerDoc.docs[0].data().team || "Bilinmeyen";
                }
                if (!grouped[team]) grouped[team] = [];
                grouped[team].push(sale);
            }

            let output = "";
            Object.entries(grouped).forEach(([team, sales]) => {
                const teamTotal = sales.reduce((sum, s) => sum + (s.totalPrice || 0), 0);
                const sortedSellers = {};
                sales.forEach(s => {
                    const k = s.sellerName || s.sellerUsername || "-";
                    if (!sortedSellers[k]) sortedSellers[k] = 0;
                    sortedSellers[k] += s.totalPrice || 0;
                });

                const sortedArray = Object.entries(sortedSellers).sort((a, b) => b[1] - a[1]);

                output += `<h4>${team} (${sales.length} satış) - Toplam: ${teamTotal.toFixed(2)} TL</h4><ol>`;
                sortedArray.forEach(([name, total], index) => {
                    output += `<li>🥇 ${name} - ${total.toFixed(2)} TL (Komisyon: ${(total * 0.10).toFixed(2)} TL)</li>`;
                });
                output += `</ol><hr/>`;
            });

            const statsDiv = document.getElementById("teamStats");
            if (statsDiv) statsDiv.innerHTML = output;
        }

        document.addEventListener("DOMContentLoaded", () => {
            renderAdvancedSellerList();
            renderTeamSalesStats();
            document.getElementById("filterTeam").addEventListener("input", () => {
                const val = document.getElementById("filterTeam").value;
                const city = document.getElementById("filterCity").value;
                renderAdvancedSellerList(val, city);
            });
            document.getElementById("filterCity").addEventListener("input", () => {
                const team = document.getElementById("filterTeam").value;
                const val = document.getElementById("filterCity").value;
                renderAdvancedSellerList(team, val);
            });
        });
        function updatePaymentFields(tid) {
            const seatInput = document.getElementById(`seatCount_${tid}`);
            const occupantCount = document.querySelectorAll(`#occList_${tid} .occRow`).length + 1;
            const paymentType = document.getElementById(`payment_${tid}`);
            const finalizeBtn = document.querySelector(`#reservation_${tid} button.finalize-btn`);
            const payBox = document.getElementById(`paymentExtra_${tid}`);
            const confirmBtn = document.getElementById(`confirmTotalBtn_${tid}`);
            const kvkkCheckbox = document.getElementById(`kvkk_${tid}`);

            // 🧾 Tutar onaylandı mı?
            const isConfirmed = confirmBtn?.classList.contains("confirmed");

            // 💳 Ödeme yöntemi seçildi mi?
            const isPaymentSelected = paymentType?.value !== "";

            // 📋 Ödeme detayları girildi mi?
            const isPaymentFilled = payBox && payBox.innerHTML.trim() !== "";

            // 📌 KVKK kutusu işaretli mi?
            const isKvkkChecked = kvkkCheckbox?.checked;

            // ✨ Tüm şartlar tamam mı?
            const allReady = isConfirmed && isPaymentSelected && isPaymentFilled && isKvkkChecked;

            // 🟢 Butonu aktif/pasif yap
            finalizeBtn.disabled = !allReady;
            finalizeBtn.classList.toggle("disabled", !allReady);
            finalizeBtn.disabled = !(paymentReady && kvkkOk);
            finalizeBtn.classList.toggle("disabled", !(paymentReady && kvkkOk));





        }
        // Her önemli alanda tetiklenmeli
        document.getElementById(`payment_${tid}`).addEventListener("change", () => updatePaymentFields(tid));
        document.getElementById(`kvkk_${tid}`).addEventListener("change", () => updatePaymentFields(tid));
        document.getElementById(`seatCount_${tid}`).addEventListener("input", () => updatePaymentFields(tid));
        document.querySelector(`#occList_${tid}`).addEventListener("input", () => updatePaymentFields(tid));
        function updatePaymentFields(tid) {
            const seatInput = document.getElementById(`seatCount_${tid}`);
            const occupantCount = document.querySelectorAll(`#occList_${tid} .occRow`).length + 1;
            const paymentType = document.getElementById(`payment_${tid}`);
            const finalizeBtn = document.getElementById(`finalizeBtn_${tid}`);
            const payBox = document.getElementById(`paymentExtra_${tid}`);
            const confirmBtn = document.getElementById(`confirmTotalBtn_${tid}`);
            const kvkkCheckbox = document.getElementById(`kvkk_${tid}`);

            let seatCount = parseInt(seatInput.value);

            if (occupantCount > seatCount) {
                alert("📌 Kişi sayısı koltuk sayısından fazla. Koltuk sayısı otomatik güncellendi.");
                seatInput.value = occupantCount;
                seatCount = occupantCount;
            } else if (occupantCount < seatCount) {
                const proceed = confirm("⚠️ Koltuk sayısı kişi sayısından fazla. Devam etmek istiyor musunuz?");
                if (!proceed) {
                    seatInput.value = occupantCount;
                    seatCount = occupantCount;
                }
            }

            const tur = tours.find(t => t.id === tid);
            const total = seatCount * (tur.price || 0);

            // Toplam tutarı göster
            let totalArea = document.getElementById(`totalPayArea_${tid}`);
            if (!totalArea) {
                totalArea = document.createElement("div");
                totalArea.id = `totalPayArea_${tid}`;
                totalArea.style = "margin: 10px 0; font-weight: bold; color: #444;";
                confirmBtn.parentNode.insertBefore(totalArea, confirmBtn);
            }
            totalArea.innerHTML = `💵 Toplam Tutar: <strong>${total} TL</strong>`;

            // Ödeme tipi seçilemezse disable
            paymentType.disabled = !confirmBtn.classList.contains("confirmed");

            // Tüm şartlar sağlandıysa buton aktif olsun
            const isReady = (
                confirmBtn.classList.contains("confirmed") &&
                paymentType.value &&
                payBox.innerHTML.trim() !== "" &&
                kvkkCheckbox?.checked
            );

            finalizeBtn.disabled = !isReady;
            finalizeBtn.classList.toggle("disabled", !isReady);
        }

        function setupReservationForm(tid) {
            document.getElementById(`seatCount_${tid}`).addEventListener("input", () => updatePaymentFields(tid));
            document.querySelector(`#occList_${tid}`).addEventListener("input", () => updatePaymentFields(tid));
            document.getElementById(`payment_${tid}`).addEventListener("change", () => togglePaymentExtra(tid));
            document.getElementById(`kvkk_${tid}`).addEventListener("change", () => updatePaymentFields(tid));
            updatePaymentFields(tid);
        }
        function confirmFinalSale(tid) {
            const seatInput = document.getElementById(`seatCount_${tid}`);
            const seatCount = parseInt(seatInput.value);
            const tur = tours.find(t => t.id === tid);
            const total = seatCount * (tur.price || 0);

            const message = `🧾 *${tur.name}* turuna *${seatCount} kişi* için toplam *${total} TL* ödeme yapılacak.\n\n✅ Onaylıyor musunuz?`;

            if (confirm(message)) {
                finalizeSale(tid); // Gerçek satış işlemini başlatır
            } else {
                alert("🚫 Satış iptal edildi.");
            }
        }
        finalizeBtn.disabled = !(paymentReady && kvkkOk);
        finalizeBtn.classList.toggle("disabled", !(paymentReady && kvkkOk));

        const finalizeBtn = document.querySelector(`#reservation_${tid} button.finalize-btn`);
        const paymentReady = paymentType.value && payBox.innerHTML.trim() !== "";
        const kvkkOk = kvkkCheckbox?.checked;

        finalizeBtn.disabled = !(paymentReady && kvkkOk);
        finalizeBtn.classList.toggle("disabled", !(paymentReady && kvkkOk));


        function checkFinalizeEligibility(tid) {
            const seatInput = document.getElementById(`seatCount_${tid}`);
            const confirmBtn = document.getElementById(`confirmTotalBtn_${tid}`);
            const paymentType = document.getElementById(`payment_${tid}`);
            const payBox = document.getElementById(`paymentExtra_${tid}`);
            const kvkk = document.getElementById(`kvkk_${tid}`);
            const finalizeBtn = document.querySelector(`#reservation_${tid} button.finalize-btn`);

            const occCount = document.querySelectorAll(`#occList_${tid} .occRow`).length + 1;
            const seatCount = parseInt(seatInput.value);

            // Uyarı metni için div varsa temizle
            let warnBox = document.getElementById(`warnBox_${tid}`);
            if (!warnBox) {
                warnBox = document.createElement("div");
                warnBox.id = `warnBox_${tid}`;
                warnBox.style = "margin-top:6px; color:red; font-size:13px;";
                finalizeBtn?.parentNode.insertBefore(warnBox, finalizeBtn);
            }

            warnBox.innerHTML = ""; // temizle

            if (!confirmBtn.classList.contains("confirmed")) {
                warnBox.innerHTML += "📌 Tutarı onaylayın.<br>";
            }

            if (!paymentType.value) {
                warnBox.innerHTML += "📌 Ödeme tipi seçin.<br>";
            }

            if (payBox.innerText.trim() === "") {
                warnBox.innerHTML += "📌 Ödeme bilgileri eksik.<br>";
            }

            if (!kvkk.checked) {
                warnBox.innerHTML += "📌 KVKK onayı gerekiyor.<br>";
            }

            if (occCount !== seatCount) {
                warnBox.innerHTML += `📌 Kişi (${occCount}) ile koltuk (${seatCount}) sayısı eşit değil.<br>`;
            }

            const isOk =
                confirmBtn.classList.contains("confirmed") &&
                paymentType.value &&
                payBox.innerText.trim() !== "" &&
                kvkk.checked &&
                occCount === seatCount;

            finalizeBtn.disabled = !isOk;
            finalizeBtn.classList.toggle("disabled", !isOk);
        }
        const tourFilter = document.getElementById("filterTourName").value.toLowerCase();
        filtered = filtered.filter(s => (s.tourName || "").toLowerCase().includes(tourFilter));

        document.getElementById("createCustomTourForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const tour = {
                name: document.getElementById("customTourName").value,
                description: document.getElementById("customTourDesc").value,
                location: document.getElementById("customTourStartLoc").value,
                date: document.getElementById("customTourDate").value,
                seats: parseInt(document.getElementById("customTourSeats").value),
                price: parseFloat(document.getElementById("customTourPrice").value),
                contact: document.getElementById("customContactInfo").value,
                video: document.getElementById("customTourVideo").value,
                seller: document.getElementById("customSellerName").value,
                participants: document.getElementById("customParticipants").value.split("\n").filter(x => x.trim() !== ""),
                status: "pending",
                createdAt: new Date().toISOString()
            };

            try {
                await firebase.firestore().collection("customTours").add(tour);
                document.getElementById("customTourSuccessMsg").innerText = "✅ Tur talebiniz alındı, onay bekleniyor.";
                document.getElementById("customTourSuccessMsg").style.display = "block";
                document.getElementById("createCustomTourForm").reset();
            } catch (err) {
                alert("❌ Hata: " + err.message);
            }
        });
        function toggleAddressFields(tid) {
            const type = document.getElementById(`addressType_${tid}`).value;
            const container = document.getElementById(`addressFields_${tid}`);
            const tour = tours.find(t => t.id === tid);

            if (tour.code === "5") {
                container.innerHTML = `<em>✈️ Yurtdışı turlarda adres bilgisi alınmaz.</em>`;
                return;
            }

            let html = "";

            if (type === "Ev") {
                html = `<label>Ev Adresi:</label>
            <input type="text" placeholder="Mahalle, Cadde, No...">`;
            } else if (type === "Otel") {
                html = `<label>Otel Adı:</label>
            <input type="text" placeholder="Otel adı">
            <label>Adres:</label>
            <input type="text" placeholder="Adres">
            <label>Oda No:</label>
            <input type="text" placeholder="Oda numarası">`;
            } else if (type === "Ofis") {
                html = `<label>Ofis İsmi:</label>
            <input type="text" placeholder="Firma/Ofis adı">
            <label>Adres:</label>
            <input type="text" placeholder="Ofis adresi">`;
            } else if (type === "Diğer") {
                html = `<label>Açık Adres:</label>
            <input type="text" placeholder="Lütfen açık adres belirtin">`;
            }

            container.innerHTML = html;
        }
        // Satın Al Butonu Aktifleştirme Kontrolü
        function checkFinalizeAvailability(tid) {
            const seatInput = document.getElementById(`seatCount_${tid}`);
            const totalConfirmed = document.getElementById(`totalConfirmed_${tid}`)?.classList.contains("confirmed");
            const paySelect = document.getElementById(`payment_${tid}`);
            const payType = paySelect?.value;
            const kvkk = document.getElementById(`kvkk_${tid}`)?.checked;
            const finalizeBtn = document.getElementById(`finalizeBtn_${tid}`);
            const occList = document.querySelectorAll(`#occList_${tid} .occRow`);

            let koltuk = parseInt(seatInput?.value || "0");
            let kisi = occList.length + 1;

            // ∅ Herşey eksiksizse buton aktif olur
            if (koltuk >= kisi && totalConfirmed && payType && kvkk) {
                finalizeBtn.removeAttribute("disabled");
                finalizeBtn.style.opacity = "1";
            } else {
                finalizeBtn.setAttribute("disabled", true);
                finalizeBtn.style.opacity = "0.6";
            }
        }
        // Firestore bağlantısı (senin config’in burada olmalı)

        // Bu fonksiyon, Firestore'da "salesHistory" koleksiyonuna
        // "address" ve "alternativeTour" alanlarını da içeren örnek bir satış ekler.
        async function createSampleSaleForTest() {
            const sampleDoc = {
                sellerName: "Satıcı Deneme",
                buyerName: "Müşteri Deneme",
                address: "Beyoğlu/İstanbul",            // ADRES
                alternativeTour: "VIP Deneme",         // ALTERNATİF TUR
                buyerCountry: "Türkiye",
                buyerContact: "0555 123 45 67",
                buyerEmail: "test@test.com",
                date: new Date().toISOString(),
                tourName: "Süper Boğaz Turu",
                tourDate: "2025-10-20",
                startTime: "08:00",
                endTime: "12:00",
                code: "TUR-999",                      // Tur kodu
                occupants: [
                    { name: "Ali", docNo: "T12345", docType: "TC", country: "TR" },
                    { name: "Veli", docNo: "P9876", docType: "Passport", country: "TR" }
                ]
            };

            try {
                const docRef = await db.collection("salesHistory").add(sampleDoc);
                alert("Örnek satış eklendi! ID = " + docRef.id);
            } catch (err) {
                console.error("Satış eklenemedi:", err);
                alert("Hata: " + err);
            }
        }
        function closeAdvancedPanel() {
            document.getElementById("advancedReservationPanel").style.display = "none";
        }

        function closeAdvancedPanel() {
            document.getElementById("reservationsList").innerHTML = "";
        }

        function closeReservationModal() {
            document.getElementById("reservationDetailModal").style.display = "none";
        }

        function showReservationModal(data) {
            const html = `
      <p><strong>🧍 Müşteri:</strong> ${data.customerName || ""} ${data.customerSurname || ""}</p>
      <p><strong>📞 Telefon:</strong> ${data.phone || "-"}</p>
      <p><strong>🌍 Ülke:</strong> ${data.country || "-"}</p>
      <p><strong>📅 Tur Tarihi:</strong> ${data.tourDate || "-"}</p>
      <p><strong>🚌 Tur Adı:</strong> ${data.tourName || "-"}</p>
      <p><strong>👥 Kişi Sayısı:</strong> ${data.personCount || "-"}</p>
      <p><strong>📝 Not:</strong> ${data.notes || "-"}</p>
      <p><strong>👤 Satıcı:</strong> ${data.sellerName || "-"}</p>
    `;
            document.getElementById("reservationModalContent").innerHTML = html;
            document.getElementById("reservationDetailModal").style.display = "flex";
        }

        async function loadFilteredReservations() {
            const tourName = document.getElementById("filterTourName").value.trim().toLowerCase();
            const customerName = document.getElementById("filterCustomer").value.trim().toLowerCase();
            const phone = document.getElementById("filterPhone").value.trim();
            const country = document.getElementById("filterCountry").value.trim().toLowerCase();
            const date = document.getElementById("filterDate").value;
            const sellerName = document.getElementById("filterSeller").value.trim().toLowerCase();
            const personCount = document.getElementById("filterPersonCount").value.trim();
            const notes = document.getElementById("filterNotes").value.trim().toLowerCase();

            const tbody = document.getElementById("reservationsList");
            tbody.innerHTML = "";

            const snapshot = await db.collection("ileriRezervasyonlar").orderBy("createdAt", "desc").get();

            let index = 1;

            snapshot.forEach(doc => {
                const r = doc.data();

                const matchesTour = !tourName || (r.tourName || "").toLowerCase().includes(tourName);
                const matchesCustomer = !customerName || ((r.customerName + " " + r.customerSurname).toLowerCase().includes(customerName));
                const matchesPhone = !phone || (r.phone || "").includes(phone);
                const matchesCountry = !country || (r.country || "").toLowerCase().includes(country);
                const matchesDate = !date || r.tourDate === date;
                const matchesSeller = !sellerName || (r.sellerName || "").toLowerCase().includes(sellerName);
                const matchesPersonCount = !personCount || (r.personCount || "") == personCount;
                const matchesNotes = !notes || (r.notes || "").toLowerCase().includes(notes);

                if (matchesTour && matchesCustomer && matchesPhone && matchesCountry && matchesDate && matchesSeller && matchesPersonCount && matchesNotes) {
                    const today = new Date();
                    const tourDate = new Date(r.tourDate);
                    const fark = Math.floor((tourDate - today) / (1000 * 60 * 60 * 24));
                    let rowColor = "#fff";
                    if (!isNaN(fark)) {
                        if (fark < 7) rowColor = "#ffcdd2";
                        else if (fark < 15) rowColor = "#fff9c4";
                        else if (fark < 30) rowColor = "#ffe0b2";
                    }

                    const tr = document.createElement("tr");
                    tr.style.background = rowColor;
                    tr.style.cursor = "pointer";
                    tr.onclick = () => showReservationModal(r);

                    tr.innerHTML = `
          <td><strong>${index++}</strong></td>
          <td>${r.tourName || "-"}</td>
          <td>${r.tourDate || "-"}</td>
          <td>${r.personCount || "-"}</td>
          <td>${r.customerName || ""} ${r.customerSurname || ""}</td>
          <td>${r.sellerName || "-"}</td>
          <td>${r.country || "-"}</td>
          <td>${r.phone || "-"}</td>
          <td>${r.notes || "-"}</td>
          <td><a href="https://wa.me/${r.phone}" target="_blank">💬</a></td>
        `;

                    tbody.appendChild(tr);
                }
            });
        }
        function renderSellerCards() {
            const container = document.getElementById("sellerCardList");
            container.innerHTML = "";

            firebase.firestore().collection("sellers").get().then(snapshot => {
                snapshot.forEach(doc => {
                    const seller = doc.data();
                    const id = doc.id;

                    const card = document.createElement("div");
                    card.style.border = "1px solid #ddd";
                    card.style.padding = "15px";
                    card.style.borderRadius = "12px";
                    card.style.background = "#fafafa";
                    card.style.marginBottom = "10px";

                    card.innerHTML = `
        <h4>👤 ${seller.name}</h4>
        <p>👨‍💻 Kullanıcı Adı: ${seller.username}</p>
        <p>📞 Telefon: ${seller.phone || "-"}</p>
        <p>🏙️ ${seller.city || "-"} / 🌍 ${seller.country || "-"}</p>
        <p>👥 Ekip: ${seller.team || "-"}</p>
        <p>🆔 TC/Vergi No: ${seller.idNumber || "-"}</p>
        <p>💳 IBAN: ${seller.bankAccount || "-"}</p>
        <div style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
          <button onclick="openSellerEditModal('${id}', '${seller.name}', '${seller.city}', '${seller.phone}', '${seller.country}', '${seller.bankAccount || ""}')">✏️ Düzenle</button>
          <button onclick="deleteSeller('${id}')">🗑️ Sil</button>
          <button onclick="showSellerStats('${seller.username}', '${seller.name}')">📊 Satış Verisi</button>
        </div>
      `;

                    container.appendChild(card);
                });
            });
        }



        // ➕ Kaydet
        function saveSeller() {
            const s = {
                username: document.getElementById("sellerUsername").value,
                password: document.getElementById("sellerPassword").value,
                name: document.getElementById("sellerName").value,
                phone: document.getElementById("sellerPhone").value,
                idNumber: document.getElementById("sellerTC").value,
                bankAccount: document.getElementById("sellerIBAN").value,
                team: document.getElementById("sellerTeam").value,
                city: document.getElementById("sellerCity").value,
                country: document.getElementById("sellerCountry").value,
                role: "seller"
            };
            if (!s.username || !s.password || !s.name) return alert("Zorunlu alanları doldur!");
            db.collection("sellers").doc(s.username).set(s).then(() => {
                alert("✅ Kaydedildi");
                document.getElementById("sellerForm").reset();
                renderSellers();
            });
        }

        // ✏️ Güncelle
        function editSeller(id, name, phone, city, country, iban) {
            document.getElementById("editSellerId").value = id;
            document.getElementById("editSellerName").value = name;
            document.getElementById("editSellerPhone").value = phone;
            document.getElementById("editSellerCity").value = city;
            document.getElementById("editSellerCountry").value = country;
            document.getElementById("editSellerIBAN").value = iban;
            document.getElementById("sellerEditModal").style.display = "flex";
        }

        function updateSeller() {
            const id = document.getElementById("editSellerId").value;
            const updates = {
                name: document.getElementById("editSellerName").value,
                phone: document.getElementById("editSellerPhone").value,
                city: document.getElementById("editSellerCity").value,
                country: document.getElementById("editSellerCountry").value,
                bankAccount: document.getElementById("editSellerIBAN").value
            };
            const newPass = document.getElementById("editSellerPassword").value;
            if (newPass) updates.password = newPass;
            db.collection("sellers").doc(id).update(updates).then(() => {
                alert("✔️ Güncellendi");
                closeEditModal();
                renderSellers();
            });
        }

        function closeEditModal() {
            document.getElementById("sellerEditModal").style.display = "none";
        }

        // 🗑️ Sil
        function deleteSeller(id) {
            if (!confirm("Silinsin mi?")) return;
            db.collection("sellers").doc(id).delete().then(() => {
                alert("🗑️ Silindi");
                renderSellers();
            });
        }

        // 🔍 Filtrele
        function filterSellers() {
            const nameF = document.getElementById("filterName").value.toLowerCase();
            const teamF = document.getElementById("filterTeam").value.toLowerCase();
            const cityF = document.getElementById("filterCity").value.toLowerCase();
            const countryF = document.getElementById("filterCountry").value.toLowerCase();
            const list = document.getElementById("sellerList");
            list.innerHTML = "";

            db.collection("sellers").get().then(snap => {
                snap.forEach(doc => {
                    const d = doc.data();
                    const id = doc.id;
                    if (
                        (!nameF || d.name?.toLowerCase().includes(nameF)) &&
                        (!teamF || d.team?.toLowerCase().includes(teamF)) &&
                        (!cityF || d.city?.toLowerCase().includes(cityF)) &&
                        (!countryF || d.country?.toLowerCase().includes(countryF))
                    ) {
                        const div = document.createElement("div");
                        div.innerHTML = `
            <h4>${d.name}</h4>
            <p>📞 ${d.phone || "-"}</p>
            <p>${d.city || "-"} / ${d.country || "-"}</p>
            <p>👥 ${d.team || "-"}</p>
            <div style="margin-top:8px;">
              <button onclick="editSeller('${id}', '${d.name}', '${d.phone}', '${d.city}', '${d.country}', '${d.bankAccount || ""}')">✏️</button>
              <button onclick="deleteSeller('${id}')">🗑️</button>
              <button onclick="showStats('${id}', '${d.name}')">📊</button>
            </div>
          `;
                        list.appendChild(div);
                    }
                });
            });
        }

        function resetFilters() {
            document.getElementById("filterName").value = "";
            document.getElementById("filterTeam").value = "";
            document.getElementById("filterCity").value = "";
            document.getElementById("filterCountry").value = "";
            renderSellers();
        }

        // 📊 Satış Verisi
        let chart, chartType = 'bar', currentSellerId = null;
        function showStats(id, name) {
            currentSellerId = id;
            document.getElementById("sellerStats").style.display = "block";
            document.getElementById("sellerStatsSummary").innerHTML = `<p>📌 ${name}</p>`;
            loadStats("1w");
        }

        function loadStats(range) {
            const now = new Date();
            let start = new Date();
            if (range === "1d") start.setDate(now.getDate() - 1);
            else if (range === "1w") start.setDate(now.getDate() - 7);
            else if (range === "1m") start.setMonth(now.getMonth() - 1);
            else if (range === "custom") {
                start = new Date(document.getElementById("customStart").value);
                now.setTime(new Date(document.getElementById("customEnd").value).getTime());
            }

            db.collection("salesHistory").get().then(snap => {
                const data = snap.docs.map(d => d.data()).filter(s => {
                    const d = new Date(s.date);
                    return (s.sellerUsername === currentSellerId || s.sellerName === currentSellerId) && d >= start && d <= now;
                });

                const total = data.length;
                const amount = data.reduce((sum, s) => sum + (s.totalPrice || 0), 0);
                const komisyon = amount * 0.1;

                document.getElementById("sellerStatsSummary").innerHTML += `
        <p>🧾 Satış: ${total}</p>
        <p>💰 Tutar: ${amount.toFixed(2)} TL</p>
        <p>💸 Komisyon: ${komisyon.toFixed(2)} TL</p>
      `;

                const tourMap = {};
                data.forEach(s => {
                    const t = s.tourName || "Diğer";
                    tourMap[t] = (tourMap[t] || 0) + 1;
                });

                drawChart(tourMap);
            });
        }

        function drawChart(data) {
            const ctx = document.getElementById("sellerChart").getContext("2d");
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: "Tur Bazlı Satış",
                        data: Object.values(data),
                        backgroundColor: "#03a9f4"
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function switchChart() {
            chartType = chartType === "bar" ? "pie" : "bar";
            loadStats("1w");
        }

        function printStats() {
            const div = document.getElementById("sellerStats").innerHTML;
            const win = window.open("", "", "width=800,height=600");
            win.document.write(`<html><head><title>Satış Raporu</title></head><body>${div}</body></html>`);
            win.document.close();
            win.print();
        }

        function loadSellerSales(range) {
            if (!currentSellerStatsId) return;
            const now = new Date();
            let startDate = new Date();

            if (range === "1d") startDate.setDate(now.getDate() - 1);
            else if (range === "1w") startDate.setDate(now.getDate() - 7);
            else if (range === "1m") startDate.setMonth(now.getMonth() - 1);
            else if (range === "custom") {
                const cStart = document.getElementById("customStart").value;
                const cEnd = document.getElementById("customEnd").value;
                if (!cStart || !cEnd) return alert("Tarih aralığı eksik!");
                startDate = new Date(cStart);
                now.setTime(new Date(cEnd).getTime());
            }

            firebase.firestore().collection("salesHistory").get().then(snapshot => {
                const filtered = snapshot.docs.map(doc => doc.data()).filter(s => {
                    const sDate = new Date(s.date);
                    return (
                        s.sellerId === currentSellerStatsId ||
                        s.sellerUsername === currentSellerStatsId ||
                        s.sellerName === currentSellerStatsId
                    ) && sDate >= startDate && sDate <= now;
                });

                const totalSales = filtered.length;
                const totalAmount = filtered.reduce((sum, s) => sum + (s.totalPrice || 0), 0);
                const commission = totalAmount * 0.10;

                document.getElementById("sellerStatsSummary").innerHTML += `
      <p>🧾 Toplam Satış: <strong>${totalSales}</strong></p>
      <p>💰 Tutar: <strong>${totalAmount.toFixed(2)} TL</strong></p>
      <p>💸 Komisyon (10%): <strong>${commission.toFixed(2)} TL</strong></p>
    `;

                const tourCounts = {};
                filtered.forEach(s => {
                    const t = s.tourName || "-";
                    if (!tourCounts[t]) tourCounts[t] = 0;
                    tourCounts[t]++;
                });

                drawSellerChart(tourCounts);
            });
        }

        function drawSellerChart(dataObj) {
            const ctx = document.getElementById("sellerChart").getContext("2d");
            if (sellerChartInstance) sellerChartInstance.destroy();
            sellerChartInstance = new Chart(ctx, {
                type: currentChartType,
                data: {
                    labels: Object.keys(dataObj),
                    datasets: [{
                        label: "Tur Bazlı Satış",
                        data: Object.values(dataObj),
                        backgroundColor: "#03a9f4"
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function switchChartType() {
            currentChartType = currentChartType === 'bar' ? 'pie' : 'bar';
            loadSellerSales("1w");
        }

        function printSellerStats() {
            const statsPanel = document.getElementById("sellerStatsPanel").innerHTML;
            const newWindow = window.open("", "", "width=800,height=600");
            newWindow.document.write(`<html><head><title>Satıcı Performansı</title></head><body>${statsPanel}</body></html>`);
            newWindow.document.close();
            newWindow.print();
        }

        // Sayfa açıldığında satıcıları yükle
        window.onload = renderSellers;
        function showSellerStats(sellerId, sellerName) {
            currentSellerStatsId = sellerId;

            const panel = document.getElementById("sellerAccountingPanel");
            const tbody = document.getElementById("sellerAccountingBody");
            const totalAmountCell = document.getElementById("totalAmountCell");
            const commissionCell = document.getElementById("commissionCell");

            panel.style.display = "block";
            tbody.innerHTML = "";
            totalAmountCell.textContent = "0 TL";
            commissionCell.textContent = "0 TL";

            let total = 0;

            firebase.firestore().collection("salesHistory").get().then(snapshot => {
                const sales = snapshot.docs.map(doc => doc.data()).filter(s =>
                    s.sellerId === sellerId || s.sellerUsername === sellerId || s.sellerName === sellerId
                );

                sales.forEach(sale => {
                    const row = document.createElement("tr");
                    const date = new Date(sale.date).toLocaleDateString();
                    const tour = sale.tourName || "-";
                    const customer = sale.buyerName || "-";
                    const count = (sale.occupants?.length || 0) + 1;
                    const payType = sale.paymentType || "-";
                    const amount = sale.totalPrice || 0;

                    row.innerHTML = `
        <td>${date}</td>
        <td>${tour}</td>
        <td>${customer}</td>
        <td>${count}</td>
        <td>${payType}</td>
        <td>${amount.toFixed(2)} TL</td>
      `;
                    tbody.appendChild(row);
                    total += amount;
                });

                totalAmountCell.textContent = `${total.toFixed(2)} TL`;
                commissionCell.textContent = `${(total * 0.10).toFixed(2)} TL`;
            });
        }

        function showSellerStats(sellerId, sellerName) {
            document.getElementById("sellerSalesTitle").textContent = `📊 ${sellerName} Satışları`;
            document.getElementById("sellerSalesModal").style.display = "flex";

            const tbody = document.getElementById("sellerSalesBody");
            const totalCell = document.getElementById("sellerSalesTotal");
            const commissionCell = document.getElementById("sellerSalesCommission");

            tbody.innerHTML = "";
            totalCell.textContent = "0 TL";
            commissionCell.textContent = "0 TL";

            let total = 0;

            firebase.firestore().collection("salesHistory").get().then(snapshot => {
                const sales = snapshot.docs.map(d => d.data()).filter(s =>
                    s.sellerId === sellerId || s.sellerUsername === sellerId || s.sellerName === sellerId
                );

                sales.forEach(sale => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
        <td>${new Date(sale.date).toLocaleDateString()}</td>
        <td>${sale.tourName || "-"}</td>
        <td>${sale.buyerName || "-"}</td>
        <td>${(sale.occupants?.length || 0) + 1}</td>
        <td>${sale.paymentType || "-"}</td>
        <td>${(sale.totalPrice || 0).toFixed(2)} TL</td>
      `;
                    tbody.appendChild(row);
                    total += sale.totalPrice || 0;
                });

                totalCell.textContent = `${total.toFixed(2)} TL`;
                commissionCell.textContent = `${(total * 0.10).toFixed(2)} TL`;
            });
        }

        function closeSellerSalesModal() {
            document.getElementById("sellerSalesModal").style.display = "none";
        }


        // Satıcı ve satışları anlık güncellemek için onSnapshot kullanımı
        sellersCollection.onSnapshot(snap => {
            sellers = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSellerSalesList();
        });
        salesCollection.onSnapshot(snap => {
            salesHistory = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSellerSalesList();
        });
        // Eğer tur koleksiyonunu kullanıyorsanız:
        toursCollection.onSnapshot(snap => {
            tours = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        });

        // Filtreleme fonksiyonu: Filtre inputlarının değerlerine göre satıcıları filtrele
        function filterSellersSales() {
            renderSellerSalesList();
        }

        function resetSellerFilters() {
            document.getElementById("filterSellerName").value = "";
            document.getElementById("filterTeam").value = "";
            document.getElementById("filterCity").value = "";
            document.getElementById("filterCountry").value = "";
            document.getElementById("filterTourName").value = "";
            document.getElementById("filterStartDate").value = "";
            document.getElementById("filterEndDate").value = "";
            renderSellerSalesList();
        }

        // Ana render fonksiyonu: Filtrelere göre satıcı kartlarını ve o satıcının satış raporunu listele
        function renderSellerSalesList() {
            const container = document.getElementById("sellerSalesList");
            container.innerHTML = "";

            // Filtre değerlerini oku
            const filterName = document.getElementById("filterSellerName").value.trim().toLowerCase();
            const filterTeam = document.getElementById("filterTeam").value.trim().toLowerCase();
            const filterCity = document.getElementById("filterCity").value.trim().toLowerCase();
            const filterCountry = document.getElementById("filterCountry").value.trim().toLowerCase();
            const filterTourName = document.getElementById("filterTourName").value.trim().toLowerCase();
            const filterStartDate = document.getElementById("filterStartDate").value;
            const filterEndDate = document.getElementById("filterEndDate").value;

            // Filtre uygulanmış satıcı listesi
            let filteredSellers = sellers.filter(s => {
                return (!filterName || (s.name || "").toLowerCase().includes(filterName)) &&
                    (!filterTeam || (s.team || "").toLowerCase().includes(filterTeam)) &&
                    (!filterCity || (s.city || "").toLowerCase().includes(filterCity)) &&
                    (!filterCountry || (s.country || "").toLowerCase().includes(filterCountry));
            });

            // Her satıcı için kart oluştur ve altında satış rapor tablosunu ekle
            filteredSellers.forEach(seller => {
                const card = document.createElement("div");
                card.style.border = "1px solid #ddd";
                card.style.padding = "15px";
                card.style.borderRadius = "8px";
                card.style.marginBottom = "20px";
                card.style.background = "#f9f9f9";

                // Satıcı bilgileri
                card.innerHTML = `
        <h3 style="margin-bottom:8px;">👤 ${seller.name}</h3>
        <p>👨‍💻 Kullanıcı: ${seller.username}</p>
        <p>📞 Telefon: ${seller.phone || "-"}</p>
        <p>🏙️ ${seller.city || "-"} / 🌍 ${seller.country || "-"}</p>
        <p>👥 Ekip: ${seller.team || "-"}</p>
        <hr style="margin:10px 0;">
        <div id="sellerSales_${seller.id}">
          <!-- Bu alana o satıcının satış raporu tablosu gelecek -->
        </div>
      `;

                container.appendChild(card);
                renderSalesForSeller(seller);
            });
        }

        function toggleSellerFilter() {
            const box = document.getElementById("sellerFilterBox");
            if (!box) return;
            box.style.display = (box.style.display === "none" || box.style.display === "") ? "block" : "none";
        }

        /* ===================== 2) Firestore Verisi ===================== */
        // sellers ve salesHistory verileri onSnapshot ile global değişkende tutulduğunu varsayıyoruz.
        // Örneğin:
        // let sellers = [];
        // let salesHistory = [];
        // sellersCollection.onSnapshot(...);
        // salesCollection.onSnapshot(...);

        // Filtre dropdown'ı doldurmak için:
        async function populateSellerDropdown() {
            const sel = document.getElementById("filterSellerSelect");
            if (!sel) return;

            // Tüm satıcıları ekle
            sel.innerHTML = '<option value="">Tüm Satıcılar</option>';
            sellers.forEach(s => {
                const opt = document.createElement("option");
                opt.value = s.username; // veya s.id
                opt.textContent = s.name || s.username;
                sel.appendChild(opt);
            });
        }

        // onSnapshot ile sellers güncellendikçe select dolduralım
        // (bunu sellersCollection.onSnapshot içinde de çağırabilirsiniz.)
        // Örnek:
        // sellersCollection.onSnapshot(snap => {
        //   sellers = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        //   populateSellerDropdown();
        // });

        /* ===================== 3) Filtrele ve Tabloyu Yazdır ===================== */
        function filterSellerSales() {
            const sellerSelectVal = document.getElementById("filterSellerSelect").value; // username
            const sellerNameVal = document.getElementById("filterSellerName").value.toLowerCase();
            const teamVal = document.getElementById("filterTeam").value.toLowerCase();
            const cityVal = document.getElementById("filterCity").value.toLowerCase();
            const countryVal = document.getElementById("filterCountry").value.toLowerCase();
            const tourVal = document.getElementById("filterTourName").value.toLowerCase();
            const startVal = document.getElementById("filterStartDate").value;
            const endVal = document.getElementById("filterEndDate").value;

            let filtered = [...salesHistory];

            // 3.1) Satıcı Filtre
            if (sellerSelectVal) {
                // Seçilen username'e göre
                filtered = filtered.filter(sale =>
                    sale.sellerUsername === sellerSelectVal ||
                    sale.sellerName === sellerSelectVal
                );
            }
            // 3.2) Ad Soyad Filtre (metin kutusuna satıcının ad-soyadının bir kısmı girilirse)
            if (sellerNameVal) {
                filtered = filtered.filter(sale =>
                    (sale.sellerName || "").toLowerCase().includes(sellerNameVal) ||
                    (sale.sellerUsername || "").toLowerCase().includes(sellerNameVal)
                );
            }

            // 3.3) Ekip / Şehir / Ülke => Bu bilgileri satıcının "team, city, country" alanlarından çekmek için
            // sale -> satıcının user adını bul -> sellers array'inden yakala -> oradan team, city, country kontrol et
            filtered = filtered.filter(sale => {
                const sUsername = sale.sellerUsername || sale.sellerName;
                // satıcı bul
                const sat = sellers.find(x => x.username === sUsername);
                if (!sat) return true; // satıcı kaydı yoksa filtreleme atla

                const satTeam = (sat.team || "").toLowerCase();
                const satCity = (sat.city || "").toLowerCase();
                const satCountry = (sat.country || "").toLowerCase();

                if (teamVal && !satTeam.includes(teamVal)) return false;
                if (cityVal && !satCity.includes(cityVal)) return false;
                if (countryVal && !satCountry.includes(countryVal)) return false;

                return true;
            });

            // 3.4) Tur Adı Filtre
            if (tourVal) {
                filtered = filtered.filter(s =>
                    (s.tourName || "").toLowerCase().includes(tourVal)
                );
            }

            // 3.5) Tarih Aralığı (turDate veya sale.date)
            if (startVal) {
                let sTime = new Date(startVal).getTime();
                filtered = filtered.filter(x => new Date(x.tourDate || x.date).getTime() >= sTime);
            }
            if (endVal) {
                let eTime = new Date(endVal + "T23:59:59").getTime();
                filtered = filtered.filter(x => new Date(x.tourDate || x.date).getTime() <= eTime);
            }

            // Filtrelendikten sonra tabloya yaz
            renderSellerSalesTable(filtered);
        }

        /* ===================== 4) Tablo Render + Maks 10 Satır + Modal ===================== */
        function renderSellerSalesTable(salesArr) {
            const tbody = document.getElementById("sellerSalesTbody");
            const totalCell = document.getElementById("sellerSalesTotal");
            const commissionCell = document.getElementById("sellerSalesCommission");
            if (!tbody) return;

            tbody.innerHTML = "";
            let total = 0;

            // Tarihe göre sıralama (isteğe bağlı)
            salesArr.sort((a, b) => new Date(b.date) - new Date(a.date));

            // Maks. 10 satır + scrollbar
            const limited = salesArr.slice(0, 50); // 10 yerine 50 de diyebilirsiniz

            limited.forEach(sale => {
                const tr = document.createElement("tr");
                const dateStr = new Date(sale.date).toLocaleDateString();
                const turTarihi = sale.tourDate || "-";
                const musteri = sale.buyerName || "-";
                const kisiSayisi = ((sale.occupants && sale.occupants.length) || 0) + 1;
                const odeme = sale.paymentType || "-";
                const tutar = sale.totalPrice || 0;
                total += tutar;

                tr.innerHTML = `
        <td>${sale.sellerName || sale.sellerUsername || "-"}</td>
        <td>${sale.tourName || "-"}</td>
        <td>${turTarihi}</td>
        <td>${kisiSayisi}</td>
        <td>${tutar.toFixed(2)} TL</td>
        <td>${odeme}</td>
        <td>${musteri}</td>
      `;

                // Satıra tıklayınca modal aç
                tr.style.cursor = "pointer";
                tr.onclick = () => openSaleDetailModal2(sale.id);

                tbody.appendChild(tr);
            });

            totalCell.textContent = total.toFixed(2) + " TL";
            commissionCell.textContent = (total * 0.10).toFixed(2) + " TL";
        }

        /* ========== 5) Modal - Detay Gösterimi ========== */
        function openSaleDetailModal2(saleId) {
            const sale = salesHistory.find(s => s.id === saleId);
            if (!sale) {
                alert("Satış kaydı bulunamadı!");
                return;
            }
            // Modal verisini doldur
            const modalContent = document.getElementById("saleDetailModalContent2");
            let occHTML = "";
            if (sale.occupants && sale.occupants.length) {
                occHTML = "<strong>Katılımcılar:</strong><br>" + sale.occupants.map((o, i) =>
                    `#${i + 1} ${o.name || "?"} (${o.docType || "?"}: ${o.docNo || "?"})`
                ).join("<br>");
            } else {
                occHTML = "<em>Ek katılımcı yok</em>";
            }

            const dateStr = new Date(sale.date).toLocaleString();
            const turTarih = sale.tourDate || "-";
            const satici = sale.sellerName || sale.sellerUsername || "-";
            const musteri = sale.buyerName || "-";

            modalContent.innerHTML = `
      <p><strong>Satıcı:</strong> ${satici}</p>
      <p><strong>Satış Tarihi:</strong> ${dateStr}</p>
      <p><strong>Tur Adı:</strong> ${sale.tourName || "-"}</p>
      <p><strong>Tur Tarihi:</strong> ${turTarih}</p>
      <p><strong>Müşteri:</strong> ${musteri}</p>
      <p><strong>Ülke:</strong> ${sale.buyerCountry || "-"}</p>
      <p><strong>İletişim:</strong> ${sale.buyerContact || "-"}</p>
      <p><strong>Tutar:</strong> ${(sale.totalPrice || 0).toFixed(2)} TL</p>
      <p><strong>Ödeme Türü:</strong> ${sale.paymentType || "-"}</p>
      <hr/>
      ${occHTML}
    `;

            // Modalı aç
            document.getElementById("saleDetailModalOverlay2").style.display = "flex";
        }

        function closeSaleDetailModal2(event) {
            // Arka plana tıklanınca veya X'e tıklanınca kapansın
            if (!event || event.target.id === "saleDetailModalOverlay2") {
                document.getElementById("saleDetailModalOverlay2").style.display = "none";
            }
        }

        /* ========== 6) Filtre Sıfırla ========== */
        function resetSellerFilters() {
            document.getElementById("filterSellerSelect").value = "";
            document.getElementById("filterSellerName").value = "";
            document.getElementById("filterTeam").value = "";
            document.getElementById("filterCity").value = "";
            document.getElementById("filterCountry").value = "";
            document.getElementById("filterTourName").value = "";
            document.getElementById("filterStartDate").value = "";
            document.getElementById("filterEndDate").value = "";
            filterSellerSales();
        }

        /* ========== 7) Panel Yüklendiğinde Başlangıç ========== */
        // onSnapshot ile sellers ve salesHistory dolunca:
        // sellers = [...]; salesHistory=[...]; populateSellerDropdown(); filterSellerSales();
        // gibi bir akış kullanabilirsiniz.
        function showSellerStats(sellerId, sellerName) {
            document.getElementById("sellerSalesTitle").textContent = `📊 ${sellerName} Satışları`;
            document.getElementById("sellerSalesModal").style.display = "flex";

            const tbody = document.getElementById("sellerSalesBody");
            const totalCell = document.getElementById("sellerSalesTotal");
            const commissionCell = document.getElementById("sellerSalesCommission");

            tbody.innerHTML = "";
            totalCell.textContent = "0 TL";
            commissionCell.textContent = "0 TL";

            let total = 0;

            firebase.firestore().collection("salesHistory").get().then(snapshot => {
                let sales = snapshot.docs.map(d => d.data());

                const selectedSeller = document.getElementById("sellerDropdown")?.value;
                const tourFilter = document.getElementById("tourNameInput")?.value.trim().toLowerCase();
                const startDate = document.getElementById("startDateInput")?.value;
                const endDate = document.getElementById("endDateInput")?.value;

                if (selectedSeller) {
                    sales = sales.filter(s => (s.sellerName || "").toLowerCase().includes(selectedSeller.toLowerCase()));
                }
                if (tourFilter) {
                    sales = sales.filter(s => (s.tourName || "").toLowerCase().includes(tourFilter));
                }
                if (startDate) {
                    sales = sales.filter(s => new Date(s.date) >= new Date(startDate));
                }
                if (endDate) {
                    sales = sales.filter(s => new Date(s.date) <= new Date(endDate));
                }

                sales.forEach(sale => {
                    const row = document.createElement("tr");
                    row.innerHTML = `
        <td>${new Date(sale.date).toLocaleDateString()}</td>
        <td>${sale.tourName || "-"}</td>
        <td>${sale.buyerName || "-"}</td>
        <td>${(sale.occupants?.length || 0) + 1}</td>
        <td>${sale.paymentType || "-"}</td>
        <td>${(sale.totalPrice || 0).toFixed(2)} TL</td>
      `;
                    tbody.appendChild(row);
                    total += sale.totalPrice || 0;
                });

                totalCell.textContent = `${total.toFixed(2)} TL`;
                commissionCell.textContent = `${(total * 0.10).toFixed(2)} TL`;
            });
        }

        function closeSellerSalesModal() {
            document.getElementById("sellerSalesModal").style.display = "none";
        }

        function populateSellerDropdown() {
            const dropdown = document.getElementById("sellerDropdown");
            if (!dropdown) return;
            dropdown.innerHTML = '<option value="">Tüm Satıcılar</option>';

            firebase.firestore().collection("sellers").get().then(snapshot => {
                snapshot.forEach(doc => {
                    const s = doc.data();
                    const name = s.name || s.username || doc.id;
                    const option = document.createElement("option");
                    option.value = name;
                    option.textContent = name;
                    dropdown.appendChild(option);
                });
            });
        }

        document.addEventListener("DOMContentLoaded", populateSellerDropdown);

        function showSellerStats(sellerId, sellerName) {
            document.getElementById("sellerSalesTitle").textContent = `📊 ${sellerName} Satışları`;
            document.getElementById("sellerSalesModal").style.display = "flex";

            const tbody = document.getElementById("sellerSalesBody");
            const totalCell = document.getElementById("sellerSalesTotal");
            const commissionCell = document.getElementById("sellerSalesCommission");

            tbody.innerHTML = "";
            totalCell.textContent = "0 TL";
            commissionCell.textContent = "0 TL";

            let total = 0;

            firebase.firestore().collection("salesHistory").get().then(snapshot => {
                let sales = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

                if (sellerId) {
                    sales = sales.filter(s =>
                        s.sellerId === sellerId || s.sellerUsername === sellerId || s.sellerName === sellerId
                    );
                }

                sales.forEach(sale => {
                    const row = document.createElement("tr");
                    const kisi = (sale.occupants?.length || 0) + 1;
                    row.innerHTML = `
        <td><input type="checkbox" class="saleCheck" data-id="${sale.id}" /></td>
        <td>${sale.sellerName || "-"}</td>
        <td>${sale.tourName || "-"}</td>
        <td>${new Date(sale.date).toLocaleDateString()}</td>
        <td>${kisi}</td>
        <td>${(sale.totalPrice || 0).toFixed(2)} TL</td>
        <td>${sale.paymentType || "-"}</td>
        <td>${sale.buyerName || "-"}</td>
      `;
                    row.onclick = () => openSaleDetailModal(sale.id);
                    tbody.appendChild(row);
                    total += sale.totalPrice || 0;
                });

                totalCell.textContent = `${total.toFixed(2)} TL`;
                commissionCell.textContent = `${(total * 0.10).toFixed(2)} TL`;
            });
        }

        function closeSellerSalesModal() {
            document.getElementById("sellerSalesModal").style.display = "none";
        }

        function exportSelectedSalesToExcel() {
            const checks = document.querySelectorAll(".saleCheck:checked");
            if (!checks.length) return alert("Hiç kayıt seçmediniz!");

            let html = `
    <table border="1" style="border-collapse:collapse;">
      <tr style="background:#eee;">
        <th>Satıcı</th>
        <th>Tur</th>
        <th>Tarih</th>
        <th>Kişi</th>
        <th>Tutar</th>
        <th>Ödeme</th>
        <th>Müşteri</th>
      </tr>
  `;

            checks.forEach(chk => {
                const saleId = chk.dataset.id;
                const sale = salesHistory.find(s => s.id === saleId);
                if (!sale) return;

                const kisi = (sale.occupants?.length || 0) + 1;

                html += `
      <tr>
        <td>${sale.sellerName || "-"}</td>
        <td>${sale.tourName || "-"}</td>
        <td>${new Date(sale.date).toLocaleDateString()}</td>
        <td>${kisi}</td>
        <td>${(sale.totalPrice || 0).toFixed(2)} TL</td>
        <td>${sale.paymentType || "-"}</td>
        <td>${sale.buyerName || "-"}</td>
      </tr>
    `;
            });

            html += `</table><br><p style='text-align:center;'>🚌 İyi turlar dileriz</p>`;

            const blob = new Blob([html], { type: "application/vnd.ms-excel" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "Satıcı_Satis_Listesi.xls";
            a.click();
            URL.revokeObjectURL(url);
        }
        // Satıcıları yükle
        function loadSellersForNotification() {
            const box = document.getElementById("sellerCheckboxes");
            box.innerHTML = "⏳ Yükleniyor...";

            db.collection("sellers").get().then(snapshot => {
                box.innerHTML = "";
                snapshot.forEach(doc => {
                    const s = doc.data();
                    const label = document.createElement("label");
                    label.style.display = "block";
                    label.style.marginBottom = "6px";

                    const input = document.createElement("input");
                    input.type = "checkbox";
                    input.className = "notifSeller";
                    input.value = s.username;

                    label.appendChild(input);
                    label.innerHTML += ` ${s.name || s.username}`;
                    box.appendChild(label);
                });
            });
        }

        // Bildirim gönderme
        async function sendNotification() {
            const message = document.getElementById("notifMessage").value.trim();
            if (!message) return alert("Mesaj boş olamaz!");

            const selected = [...document.querySelectorAll(".notifSeller:checked")].map(cb => cb.value);
            if (selected.length === 0) return alert("Lütfen en az 1 satıcı seçin!");

            const batch = db.batch();
            const colRef = db.collection("notifications");

            selected.forEach(username => {
                const docRef = colRef.doc();
                batch.set(docRef, {
                    message: message,
                    to: username,
                    createdAt: new Date(),
                    readBy: []
                });
            });

            try {
                await batch.commit();
                alert("✅ Bildirimler gönderildi!");
                document.getElementById("notifMessage").value = "";
                document.querySelectorAll(".notifSeller").forEach(cb => cb.checked = false);
            } catch (e) {
                console.error("🔥 Hata:", e);
                alert("Gönderim hatası: " + e.message);
            }
        }

        document.addEventListener("DOMContentLoaded", loadSellersForNotification);



        // 📥 Satıcıları Yükle (checkbox listesi)
        function loadSellersForNotification() {
            const box = document.getElementById("sellerCheckboxes");
            if (!box) return;

            box.innerHTML = "⏳ Yükleniyor...";

            db.collection("sellers").get().then(snapshot => {
                box.innerHTML = "";
                snapshot.forEach(doc => {
                    const s = doc.data();
                    const label = document.createElement("label");
                    label.style.display = "block";
                    label.style.marginBottom = "6px";

                    const input = document.createElement("input");
                    input.type = "checkbox";
                    input.className = "notifSeller";
                    input.value = s.username;

                    label.appendChild(input);
                    label.innerHTML += ` ${s.name || s.username}`;
                    box.appendChild(label);
                });
            });
        }

        // 📤 Bildirim Gönder
        async function sendNotification() {
            const msg = document.getElementById("notifMessage").value.trim();
            const selected = [...document.querySelectorAll(".notifSeller:checked")].map(cb => cb.value);

            if (!msg) return alert("❗ Mesaj boş!");
            if (!selected.length) return alert("❗ En az 1 satıcı seçin!");

            for (let username of selected) {
                await db.collection("notifications").add({
                    to: username,
                    message: msg,
                    createdAt: new Date(),
                    readBy: []
                });
            }

            alert("✅ Bildirim gönderildi!");
            document.getElementById("notifMessage").value = "";
            document.querySelectorAll(".notifSeller").forEach(cb => cb.checked = false);
        }
        if (role === "admin") {
            document.getElementById("adminSection").classList.add("active");
            document.getElementById("adminName").textContent = currentUser.name;
            renderAdminTours();
            renderSalesReport();
            loadSellersForNotification(); // 🔔 burayı ekle
        }
        function toggleKvkkModal() {
            const modal = document.getElementById("kvkkModal");
            modal.style.display = modal.style.display === "flex" ? "none" : "flex";
        }

        function toggleContractModal() {
            const modal = document.getElementById("contractModal");
            modal.style.display = modal.style.display === "flex" ? "none" : "flex";
        }

        function closeKvkkModal() {
            document.getElementById("kvkkModal").style.display = "none";
        }

        function closeContractModal() {
            document.getElementById("contractModal").style.display = "none";
        }

        document.getElementById("kvkkCheckbox").addEventListener("change", function () {
            document.getElementById("kvkkApproveBtn").disabled = !this.checked;
        });

        document.getElementById("contractCheckbox").addEventListener("change", function () {
            document.getElementById("contractApproveBtn").disabled = !this.checked;
        });

        document.getElementById('paymentForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const cardNumber = document.getElementById('cardNumber').value;
            const expireMonth = document.getElementById('expireMonth').value;
            const expireYear = document.getElementById('expireYear').value;
            const cvv = document.getElementById('cvv').value;
            const amount = document.getElementById('amount').value;
            const orderId = "ORD" + Math.floor(Math.random() * 1000000);

            const paymentData = {
                cardNumber,
                expireMonth,
                expireYear,
                cvv,
                amount,
                orderId
            };

            try {
                const response = await fetch("https://us-central1-tur-61.cloudfunctions.net/start3DPayment", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(paymentData)
                });

                const html = await response.text();
                const newWindow = window.open("", "_blank");
                newWindow.document.write(html);
            } catch (err) {
                alert("Ödeme başlatılamadı. Lütfen tekrar deneyin.");
                console.error("Hata:", err);
            }
        });
        document.getElementById("amount").value = totalAmount.toFixed(2);

    </script>









    </script>


</body>

</html>
